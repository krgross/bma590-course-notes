<!DOCTYPE html>
<html lang="" xml:lang="">
<head>

  <meta charset="utf-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <title>Chapter 6 Hierarchical (mixed) models | Applied statistical analysis of non-normal and/or correlated data</title>
  <meta name="description" content="This is a proto-textbook for BMA / ST 590, Statistical Modeling in Ecology." />
  <meta name="generator" content="bookdown 0.43 and GitBook 2.6.7" />

  <meta property="og:title" content="Chapter 6 Hierarchical (mixed) models | Applied statistical analysis of non-normal and/or correlated data" />
  <meta property="og:type" content="book" />
  
  <meta property="og:description" content="This is a proto-textbook for BMA / ST 590, Statistical Modeling in Ecology." />
  

  <meta name="twitter:card" content="summary" />
  <meta name="twitter:title" content="Chapter 6 Hierarchical (mixed) models | Applied statistical analysis of non-normal and/or correlated data" />
  
  <meta name="twitter:description" content="This is a proto-textbook for BMA / ST 590, Statistical Modeling in Ecology." />
  

<meta name="author" content="Kevin Gross" />


<meta name="date" content="2025-11-10" />

  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="black" />
  
  
<link rel="prev" href="generalized-least-squares.html"/>
<link rel="next" href="generalized-linear-models.html"/>
<script src="libs/jquery-3.6.0/jquery-3.6.0.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/fuse.js@6.4.6/dist/fuse.min.js"></script>
<link href="libs/gitbook-2.6.7/css/style.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-table.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-bookdown.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-highlight.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-search.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-fontsettings.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-clipboard.css" rel="stylesheet" />








<link href="libs/anchor-sections-1.1.0/anchor-sections.css" rel="stylesheet" />
<link href="libs/anchor-sections-1.1.0/anchor-sections-hash.css" rel="stylesheet" />
<script src="libs/anchor-sections-1.1.0/anchor-sections.js"></script>
<link href="libs/htmltools-fill-0.5.8.1/fill.css" rel="stylesheet" />
<script src="libs/htmlwidgets-1.6.4/htmlwidgets.js"></script>
<script src="libs/plotly-binding-4.11.0/plotly.js"></script>
<script src="libs/typedarray-0.1/typedarray.min.js"></script>
<link href="libs/crosstalk-1.2.1/css/crosstalk.min.css" rel="stylesheet" />
<script src="libs/crosstalk-1.2.1/js/crosstalk.min.js"></script>
<link href="libs/plotly-htmlwidgets-css-2.11.1/plotly-htmlwidgets.css" rel="stylesheet" />
<script src="libs/plotly-main-2.11.1/plotly-latest.min.js"></script>


<style type="text/css">
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
    color: #aaaaaa;
  }
pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
code span.al { color: #ff0000; font-weight: bold; } /* Alert */
code span.an { color: #60a0b0; font-weight: bold; font-style: italic; } /* Annotation */
code span.at { color: #7d9029; } /* Attribute */
code span.bn { color: #40a070; } /* BaseN */
code span.bu { color: #008000; } /* BuiltIn */
code span.cf { color: #007020; font-weight: bold; } /* ControlFlow */
code span.ch { color: #4070a0; } /* Char */
code span.cn { color: #880000; } /* Constant */
code span.co { color: #60a0b0; font-style: italic; } /* Comment */
code span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } /* CommentVar */
code span.do { color: #ba2121; font-style: italic; } /* Documentation */
code span.dt { color: #902000; } /* DataType */
code span.dv { color: #40a070; } /* DecVal */
code span.er { color: #ff0000; font-weight: bold; } /* Error */
code span.ex { } /* Extension */
code span.fl { color: #40a070; } /* Float */
code span.fu { color: #06287e; } /* Function */
code span.im { color: #008000; font-weight: bold; } /* Import */
code span.in { color: #60a0b0; font-weight: bold; font-style: italic; } /* Information */
code span.kw { color: #007020; font-weight: bold; } /* Keyword */
code span.op { color: #666666; } /* Operator */
code span.ot { color: #007020; } /* Other */
code span.pp { color: #bc7a00; } /* Preprocessor */
code span.sc { color: #4070a0; } /* SpecialChar */
code span.ss { color: #bb6688; } /* SpecialString */
code span.st { color: #4070a0; } /* String */
code span.va { color: #19177c; } /* Variable */
code span.vs { color: #4070a0; } /* VerbatimString */
code span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } /* Warning */
</style>

<style type="text/css">
  
  div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
</style>
<style type="text/css">
/* Used with Pandoc 2.11+ new --citeproc when CSL is used */
div.csl-bib-body { }
div.csl-entry {
  clear: both;
  margin-bottom: 0em;
}
.hanging div.csl-entry {
  margin-left:2em;
  text-indent:-2em;
}
div.csl-left-margin {
  min-width:2em;
  float:left;
}
div.csl-right-inline {
  margin-left:2em;
  padding-left:1em;
}
div.csl-indent {
  margin-left: 2em;
}
</style>

</head>

<body>



  <div class="book without-animation with-summary font-size-2 font-family-1" data-basepath=".">

    <div class="book-summary">
      <nav role="navigation">

<ul class="summary">
<li class="chapter" data-level="1" data-path="index.html"><a href="index.html"><i class="fa fa-check"></i><b>1</b> Maximum likelihood estimation</a>
<ul>
<li class="chapter" data-level="1.1" data-path="index.html"><a href="index.html#mathematical-basics"><i class="fa fa-check"></i><b>1.1</b> Mathematical basics</a></li>
<li class="chapter" data-level="1.2" data-path="index.html"><a href="index.html#horse"><i class="fa fa-check"></i><b>1.2</b> Horse-kick data</a>
<ul>
<li class="chapter" data-level="1.2.1" data-path="index.html"><a href="index.html#calculate-and-plot-the-log-likelihood-function"><i class="fa fa-check"></i><b>1.2.1</b> Calculate and plot the log-likelihood function</a></li>
<li class="chapter" data-level="1.2.2" data-path="index.html"><a href="index.html#find-the-mle-numerically-using-optimize"><i class="fa fa-check"></i><b>1.2.2</b> Find the MLE numerically using ‘optimize’</a></li>
</ul></li>
<li class="chapter" data-level="1.3" data-path="index.html"><a href="index.html#pulse-rate-data"><i class="fa fa-check"></i><b>1.3</b> Pulse rate data</a></li>
<li class="chapter" data-level="1.4" data-path="index.html"><a href="index.html#tadpole-data"><i class="fa fa-check"></i><b>1.4</b> Tadpole data</a></li>
<li class="chapter" data-level="1.5" data-path="index.html"><a href="index.html#transformable-constraints"><i class="fa fa-check"></i><b>1.5</b> Transformable constraints</a></li>
</ul></li>
<li class="chapter" data-level="2" data-path="beyondML.html"><a href="beyondML.html"><i class="fa fa-check"></i><b>2</b> Beyond the MLE: Confidence regions and hypothesis tests using the likelihood function</a>
<ul>
<li class="chapter" data-level="2.1" data-path="beyondML.html"><a href="beyondML.html#confidence-intervals-for-single-parameters"><i class="fa fa-check"></i><b>2.1</b> Confidence intervals for single parameters</a></li>
<li class="chapter" data-level="2.2" data-path="beyondML.html"><a href="beyondML.html#two-param-mle"><i class="fa fa-check"></i><b>2.2</b> Confidence regions, profile likelihoods, and associated univariate intervals</a>
<ul>
<li class="chapter" data-level="2.2.1" data-path="beyondML.html"><a href="beyondML.html#profile-likelihoods"><i class="fa fa-check"></i><b>2.2.1</b> Profile likelihoods</a></li>
</ul></li>
<li class="chapter" data-level="2.3" data-path="beyondML.html"><a href="beyondML.html#quadapprox"><i class="fa fa-check"></i><b>2.3</b> Quadratic approximations to confidence intervals and regions</a></li>
<li class="chapter" data-level="2.4" data-path="beyondML.html"><a href="beyondML.html#comparing-models-likelihood-ratio-test-and-aic"><i class="fa fa-check"></i><b>2.4</b> Comparing models: Likelihood ratio test and AIC</a></li>
<li class="chapter" data-level="2.5" data-path="beyondML.html"><a href="beyondML.html#the-negative-binomial-distriution-revisited"><i class="fa fa-check"></i><b>2.5</b> The negative binomial distriution, revisited</a></li>
</ul></li>
<li class="chapter" data-level="3" data-path="bayesian-computation.html"><a href="bayesian-computation.html"><i class="fa fa-check"></i><b>3</b> Bayesian computation</a>
<ul>
<li class="chapter" data-level="3.1" data-path="bayesian-computation.html"><a href="bayesian-computation.html#computations-with-conjugate-priors"><i class="fa fa-check"></i><b>3.1</b> Computations with conjugate priors</a></li>
<li class="chapter" data-level="3.2" data-path="bayesian-computation.html"><a href="bayesian-computation.html#mcmc-and-stochastic-approximations-of-the-posterior"><i class="fa fa-check"></i><b>3.2</b> MCMC and stochastic approximations of the posterior</a>
<ul>
<li class="chapter" data-level="3.2.1" data-path="bayesian-computation.html"><a href="bayesian-computation.html#the-horse-kick-data-once-more"><i class="fa fa-check"></i><b>3.2.1</b> The horse-kick data, once more</a></li>
<li class="chapter" data-level="3.2.2" data-path="bayesian-computation.html"><a href="bayesian-computation.html#a-simple-regression-example"><i class="fa fa-check"></i><b>3.2.2</b> A simple regression example</a></li>
</ul></li>
<li class="chapter" data-level="3.3" data-path="bayesian-computation.html"><a href="bayesian-computation.html#rstanarm"><i class="fa fa-check"></i><b>3.3</b> rstanarm</a></li>
</ul></li>
<li class="chapter" data-level="4" data-path="smoothing-and-gams.html"><a href="smoothing-and-gams.html"><i class="fa fa-check"></i><b>4</b> Smoothing and GAMs</a>
<ul>
<li class="chapter" data-level="4.1" data-path="smoothing-and-gams.html"><a href="smoothing-and-gams.html#loess-smoothers"><i class="fa fa-check"></i><b>4.1</b> Loess smoothers</a></li>
<li class="chapter" data-level="4.2" data-path="smoothing-and-gams.html"><a href="smoothing-and-gams.html#splines"><i class="fa fa-check"></i><b>4.2</b> Splines</a>
<ul>
<li class="chapter" data-level="4.2.1" data-path="smoothing-and-gams.html"><a href="smoothing-and-gams.html#regression-splines"><i class="fa fa-check"></i><b>4.2.1</b> Regression splines</a></li>
<li class="chapter" data-level="4.2.2" data-path="smoothing-and-gams.html"><a href="smoothing-and-gams.html#natural-splines"><i class="fa fa-check"></i><b>4.2.2</b> Natural splines</a></li>
<li class="chapter" data-level="4.2.3" data-path="smoothing-and-gams.html"><a href="smoothing-and-gams.html#smoothing-splines"><i class="fa fa-check"></i><b>4.2.3</b> Smoothing splines</a></li>
</ul></li>
<li class="chapter" data-level="4.3" data-path="smoothing-and-gams.html"><a href="smoothing-and-gams.html#GAMs"><i class="fa fa-check"></i><b>4.3</b> Generalized additive models (GAMs)</a></li>
</ul></li>
<li class="chapter" data-level="5" data-path="generalized-least-squares.html"><a href="generalized-least-squares.html"><i class="fa fa-check"></i><b>5</b> Generalized Least Squares</a>
<ul>
<li class="chapter" data-level="5.1" data-path="generalized-least-squares.html"><a href="generalized-least-squares.html#heterogeneous-variance"><i class="fa fa-check"></i><b>5.1</b> Heterogeneous variance</a></li>
<li class="chapter" data-level="5.2" data-path="generalized-least-squares.html"><a href="generalized-least-squares.html#temporal-serial-correlation"><i class="fa fa-check"></i><b>5.2</b> Temporal (serial) correlation</a></li>
<li class="chapter" data-level="5.3" data-path="generalized-least-squares.html"><a href="generalized-least-squares.html#spatial-data"><i class="fa fa-check"></i><b>5.3</b> Spatial data</a></li>
</ul></li>
<li class="chapter" data-level="6" data-path="hierarchical-mixed-models.html"><a href="hierarchical-mixed-models.html"><i class="fa fa-check"></i><b>6</b> Hierarchical (mixed) models</a>
<ul>
<li class="chapter" data-level="6.1" data-path="hierarchical-mixed-models.html"><a href="hierarchical-mixed-models.html#one-factor-layout-dyestuff-data"><i class="fa fa-check"></i><b>6.1</b> One-factor layout: Dyestuff data</a>
<ul>
<li class="chapter" data-level="6.1.1" data-path="hierarchical-mixed-models.html"><a href="hierarchical-mixed-models.html#comparing-fixed-vs.-random-effects"><i class="fa fa-check"></i><b>6.1.1</b> Comparing fixed vs. random effects</a></li>
<li class="chapter" data-level="6.1.2" data-path="hierarchical-mixed-models.html"><a href="hierarchical-mixed-models.html#bayesian-analysis"><i class="fa fa-check"></i><b>6.1.2</b> Bayesian analysis</a></li>
<li class="chapter" data-level="6.1.3" data-path="hierarchical-mixed-models.html"><a href="hierarchical-mixed-models.html#negative-within-group-correlations"><i class="fa fa-check"></i><b>6.1.3</b> Negative within-group correlations</a></li>
</ul></li>
<li class="chapter" data-level="6.2" data-path="hierarchical-mixed-models.html"><a href="hierarchical-mixed-models.html#moth-mm"><i class="fa fa-check"></i><b>6.2</b> Industrial melanism data</a></li>
<li class="chapter" data-level="6.3" data-path="hierarchical-mixed-models.html"><a href="hierarchical-mixed-models.html#random-coefficient-models-rikz-data"><i class="fa fa-check"></i><b>6.3</b> Random coefficient models: RIKZ data</a>
<ul>
<li class="chapter" data-level="6.3.1" data-path="hierarchical-mixed-models.html"><a href="hierarchical-mixed-models.html#analysis-without-beach-level-covariate"><i class="fa fa-check"></i><b>6.3.1</b> Analysis without beach-level covariate</a></li>
<li class="chapter" data-level="6.3.2" data-path="hierarchical-mixed-models.html"><a href="hierarchical-mixed-models.html#adding-a-beach-level-covariate"><i class="fa fa-check"></i><b>6.3.2</b> Adding a beach-level covariate</a></li>
</ul></li>
<li class="chapter" data-level="6.4" data-path="hierarchical-mixed-models.html"><a href="hierarchical-mixed-models.html#nested-and-crossed-random-effects"><i class="fa fa-check"></i><b>6.4</b> Nested and crossed random effects</a>
<ul>
<li class="chapter" data-level="6.4.1" data-path="hierarchical-mixed-models.html"><a href="hierarchical-mixed-models.html#nested-random-effects"><i class="fa fa-check"></i><b>6.4.1</b> Nested random effects</a></li>
<li class="chapter" data-level="6.4.2" data-path="hierarchical-mixed-models.html"><a href="hierarchical-mixed-models.html#crossed-random-effects"><i class="fa fa-check"></i><b>6.4.2</b> Crossed random effects</a></li>
<li class="chapter" data-level="6.4.3" data-path="hierarchical-mixed-models.html"><a href="hierarchical-mixed-models.html#an-ecological-example-with-both-crossed-and-nested-random-effects"><i class="fa fa-check"></i><b>6.4.3</b> An ecological example with both crossed and nested random effects</a></li>
</ul></li>
</ul></li>
<li class="chapter" data-level="7" data-path="generalized-linear-models.html"><a href="generalized-linear-models.html"><i class="fa fa-check"></i><b>7</b> Generalized linear models</a>
<ul>
<li class="chapter" data-level="7.1" data-path="generalized-linear-models.html"><a href="generalized-linear-models.html#glms-the-big-picture"><i class="fa fa-check"></i><b>7.1</b> GLMs: The big picture</a></li>
<li class="chapter" data-level="7.2" data-path="generalized-linear-models.html"><a href="generalized-linear-models.html#poisson-regression"><i class="fa fa-check"></i><b>7.2</b> Poisson regression</a>
<ul>
<li class="chapter" data-level="7.2.1" data-path="generalized-linear-models.html"><a href="generalized-linear-models.html#horse-kick-data-revisited"><i class="fa fa-check"></i><b>7.2.1</b> Horse-kick data revisited</a></li>
<li class="chapter" data-level="7.2.2" data-path="generalized-linear-models.html"><a href="generalized-linear-models.html#elephant-matings"><i class="fa fa-check"></i><b>7.2.2</b> Elephant matings</a></li>
</ul></li>
<li class="chapter" data-level="7.3" data-path="generalized-linear-models.html"><a href="generalized-linear-models.html#binary-responses"><i class="fa fa-check"></i><b>7.3</b> Binary responses</a>
<ul>
<li class="chapter" data-level="7.3.1" data-path="generalized-linear-models.html"><a href="generalized-linear-models.html#individual-binary-responses-tb-in-boar"><i class="fa fa-check"></i><b>7.3.1</b> Individual binary responses: TB in boar</a></li>
<li class="chapter" data-level="7.3.2" data-path="generalized-linear-models.html"><a href="generalized-linear-models.html#grouped-binary-data-tb-in-red-deer"><i class="fa fa-check"></i><b>7.3.2</b> Grouped binary data: TB in red deer</a></li>
</ul></li>
<li class="chapter" data-level="7.4" data-path="generalized-linear-models.html"><a href="generalized-linear-models.html#zero-adjusted-models-for-count-data"><i class="fa fa-check"></i><b>7.4</b> Zero-adjusted models for count data</a>
<ul>
<li class="chapter" data-level="7.4.1" data-path="generalized-linear-models.html"><a href="generalized-linear-models.html#zero-truncated-models"><i class="fa fa-check"></i><b>7.4.1</b> Zero-truncated models</a></li>
<li class="chapter" data-level="7.4.2" data-path="generalized-linear-models.html"><a href="generalized-linear-models.html#zero-inflated-models"><i class="fa fa-check"></i><b>7.4.2</b> Zero-inflated models</a></li>
<li class="chapter" data-level="7.4.3" data-path="generalized-linear-models.html"><a href="generalized-linear-models.html#zero-altered-or-hurdle-models"><i class="fa fa-check"></i><b>7.4.3</b> Zero-altered, or “hurdle”, models</a></li>
</ul></li>
<li class="chapter" data-level="7.5" data-path="generalized-linear-models.html"><a href="generalized-linear-models.html#generalized-additive-models-gams"><i class="fa fa-check"></i><b>7.5</b> Generalized additive models (GAMs)</a></li>
<li class="chapter" data-level="7.6" data-path="generalized-linear-models.html"><a href="generalized-linear-models.html#further-reading"><i class="fa fa-check"></i><b>7.6</b> Further reading</a></li>
</ul></li>
<li class="chapter" data-level="8" data-path="glmms.html"><a href="glmms.html"><i class="fa fa-check"></i><b>8</b> Generalized linear mixed models</a>
<ul>
<li class="chapter" data-level="8.1" data-path="glmms.html"><a href="glmms.html#example-1-industrial-melanism-data-continued"><i class="fa fa-check"></i><b>8.1</b> Example 1: Industrial melanism data, continued</a>
<ul>
<li class="chapter" data-level="8.1.1" data-path="glmms.html"><a href="glmms.html#gees"><i class="fa fa-check"></i><b>8.1.1</b> GEEs</a></li>
<li class="chapter" data-level="8.1.2" data-path="glmms.html"><a href="glmms.html#glmms-1"><i class="fa fa-check"></i><b>8.1.2</b> GLMMs</a></li>
<li class="chapter" data-level="8.1.3" data-path="glmms.html"><a href="glmms.html#bayesian-fit"><i class="fa fa-check"></i><b>8.1.3</b> Bayesian fit</a></li>
</ul></li>
<li class="chapter" data-level="8.2" data-path="glmms.html"><a href="glmms.html#example-2-ticks-on-red-grouse"><i class="fa fa-check"></i><b>8.2</b> Example 2: Ticks on red grouse</a></li>
<li class="chapter" data-level="8.3" data-path="glmms.html"><a href="glmms.html#GAMMs"><i class="fa fa-check"></i><b>8.3</b> GAMMs</a>
<ul>
<li class="chapter" data-level="8.3.1" data-path="glmms.html"><a href="glmms.html#mgcvgamm"><i class="fa fa-check"></i><b>8.3.1</b> mgcv::gamm</a></li>
<li class="chapter" data-level="8.3.2" data-path="glmms.html"><a href="glmms.html#gammgamm4"><i class="fa fa-check"></i><b>8.3.2</b> gamm::gamm4</a></li>
</ul></li>
</ul></li>
<li class="chapter" data-level="" data-path="bibliography.html"><a href="bibliography.html"><i class="fa fa-check"></i>Bibliography</a></li>
</ul>

      </nav>
    </div>

    <div class="book-body">
      <div class="body-inner">
        <div class="book-header" role="navigation">
          <h1>
            <i class="fa fa-circle-o-notch fa-spin"></i><a href="./">Applied statistical analysis of non-normal and/or correlated data</a>
          </h1>
        </div>

        <div class="page-wrapper" tabindex="-1" role="main">
          <div class="page-inner">

            <section class="normal" id="section-">
<div id="hierarchical-mixed-models" class="section level1 hasAnchor" number="6">
<h1><span class="header-section-number">Chapter 6</span> Hierarchical (mixed) models<a href="hierarchical-mixed-models.html#hierarchical-mixed-models" class="anchor-section" aria-label="Anchor link to header"></a></h1>
<div id="one-factor-layout-dyestuff-data" class="section level2 hasAnchor" number="6.1">
<h2><span class="header-section-number">6.1</span> One-factor layout: Dyestuff data<a href="hierarchical-mixed-models.html#one-factor-layout-dyestuff-data" class="anchor-section" aria-label="Anchor link to header"></a></h2>
<div id="comparing-fixed-vs.-random-effects" class="section level3 hasAnchor" number="6.1.1">
<h3><span class="header-section-number">6.1.1</span> Comparing fixed vs. random effects<a href="hierarchical-mixed-models.html#comparing-fixed-vs.-random-effects" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<p>We will illustrate the basic ideas of hierarchical models with the <code>Dyestuff</code> data contained in <code>lme4</code>. According to <span class="citation">Bates (<a href="#ref-bates2012lme4">2012+</a>)</span>, these data originally appeared in Davies (1947), and “are described in Davies and Goldsmith (1972, Table 6.3, p. 131) … as coming from ‘an investigation to find out how much the variation from batch to batch in the quality of an intermediate product contributes to the variation in the yield of the dyestuff made from it’”. The data consist of 6 batches, each of which gives rise to 5 observations.</p>
<p>Preparatory work:</p>
<pre><code>## Loading required package: lme4</code></pre>
<pre><code>## Loading required package: Matrix</code></pre>
<div class="sourceCode" id="cb398"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb398-1"><a href="hierarchical-mixed-models.html#cb398-1" tabindex="-1"></a><span class="fu">data</span>(Dyestuff)</span>
<span id="cb398-2"><a href="hierarchical-mixed-models.html#cb398-2" tabindex="-1"></a><span class="fu">summary</span>(Dyestuff)</span></code></pre></div>
<pre><code>##  Batch     Yield     
##  A:5   Min.   :1440  
##  B:5   1st Qu.:1469  
##  C:5   Median :1530  
##  D:5   Mean   :1528  
##  E:5   3rd Qu.:1575  
##  F:5   Max.   :1635</code></pre>
<div class="sourceCode" id="cb400"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb400-1"><a href="hierarchical-mixed-models.html#cb400-1" tabindex="-1"></a><span class="fu">with</span>(Dyestuff, <span class="fu">stripchart</span>(Yield <span class="sc">~</span> Batch, <span class="at">pch =</span> <span class="dv">16</span>))</span></code></pre></div>
<p><img src="06-HierarchicalModels_files/figure-html/unnamed-chunk-3-1.png" alt="Stripchart showing dyestuff data" width="672" /></p>
<p>To develop some notation, let <span class="math inline">\(i = 1, \ldots, 6\)</span> index the batches, let <span class="math inline">\(j = 1, \ldots, 5\)</span> index the observations within each batch, and let <span class="math inline">\(y_{ij}\)</span> denote observation <span class="math inline">\(j\)</span> from batch <span class="math inline">\(i\)</span>.</p>
<p>We will use <code>nlme::gls</code> to fit a model that assumes that the data within each batch are correlated. In other words, we fit the model
<span class="math display">\[\begin{align}
y_{ij} &amp; \sim \mathcal{N}(\mu_i, \sigma^2) \\
\mathrm{Corr}(y_{ij}, y_{ik}) &amp; = \rho
\end{align}\]</span></p>
<div class="sourceCode" id="cb401"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb401-1"><a href="hierarchical-mixed-models.html#cb401-1" tabindex="-1"></a><span class="fu">require</span>(nlme)</span></code></pre></div>
<pre><code>## Loading required package: nlme</code></pre>
<pre><code>## 
## Attaching package: &#39;nlme&#39;</code></pre>
<pre><code>## The following object is masked from &#39;package:lme4&#39;:
## 
##     lmList</code></pre>
<div class="sourceCode" id="cb405"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb405-1"><a href="hierarchical-mixed-models.html#cb405-1" tabindex="-1"></a>fm1 <span class="ot">&lt;-</span> <span class="fu">gls</span>(Yield <span class="sc">~</span> <span class="dv">1</span>, <span class="at">data =</span> Dyestuff, <span class="at">correlation =</span> <span class="fu">corCompSymm</span>(<span class="at">form =</span> <span class="sc">~</span> <span class="dv">1</span> <span class="sc">|</span> Batch))</span>
<span id="cb405-2"><a href="hierarchical-mixed-models.html#cb405-2" tabindex="-1"></a><span class="fu">summary</span>(fm1)</span></code></pre></div>
<pre><code>## Generalized least squares fit by REML
##   Model: Yield ~ 1 
##   Data: Dyestuff 
##        AIC      BIC    logLik
##   325.6543 329.7562 -159.8271
## 
## Correlation Structure: Compound symmetry
##  Formula: ~1 | Batch 
##  Parameter estimate(s):
##       Rho 
## 0.4184874 
## 
## Coefficients:
##              Value Std.Error  t-value p-value
## (Intercept) 1527.5  19.38341 78.80449       0
## 
## Standardized residuals:
##         Min          Q1         Med          Q3         Max 
## -1.34770180 -0.90488550  0.03850577  0.73160955  1.65574793 
## 
## Residual standard error: 64.92534 
## Degrees of freedom: 30 total; 29 residual</code></pre>
<p>The most salient components of this output are the estimate of the overall mean, and the estimate of the within-batch correlation (<span class="math inline">\(\hat{\rho} = 0.42\)</span>).</p>
<p>Now we will fit a random-effects, or variance-components, model that includes a random effect for the batch. We can write the model as
<span class="math display">\[\begin{align}
y_{ij} &amp; \sim \mathcal{N}(B_i, \sigma_\varepsilon^2) \\
B_i &amp; \stackrel{\text{iid}}{\sim} \mathcal{N}(\mu, \sigma_B^2).
\end{align}\]</span></p>
<div class="sourceCode" id="cb407"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb407-1"><a href="hierarchical-mixed-models.html#cb407-1" tabindex="-1"></a>fm2 <span class="ot">&lt;-</span> <span class="fu">lmer</span>(Yield <span class="sc">~</span> <span class="dv">1</span> <span class="sc">+</span> (<span class="dv">1</span> <span class="sc">|</span> Batch), <span class="at">data =</span> Dyestuff)</span>
<span id="cb407-2"><a href="hierarchical-mixed-models.html#cb407-2" tabindex="-1"></a><span class="fu">summary</span>(fm2)</span></code></pre></div>
<pre><code>## Linear mixed model fit by REML [&#39;lmerMod&#39;]
## Formula: Yield ~ 1 + (1 | Batch)
##    Data: Dyestuff
## 
## REML criterion at convergence: 319.7
## 
## Scaled residuals: 
##     Min      1Q  Median      3Q     Max 
## -1.4117 -0.7634  0.1418  0.7792  1.8296 
## 
## Random effects:
##  Groups   Name        Variance Std.Dev.
##  Batch    (Intercept) 1764     42.00   
##  Residual             2451     49.51   
## Number of obs: 30, groups:  Batch, 6
## 
## Fixed effects:
##             Estimate Std. Error t value
## (Intercept)  1527.50      19.38    78.8</code></pre>
<p>The estimate of the overall mean is the same as it is in the GLS fit. Note also that we can recover the estimate of the within-batch correlation from the estimates of the variances of the random effects:</p>
<div class="sourceCode" id="cb409"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb409-1"><a href="hierarchical-mixed-models.html#cb409-1" tabindex="-1"></a>var.B   <span class="ot">&lt;-</span> <span class="dv">1764</span></span>
<span id="cb409-2"><a href="hierarchical-mixed-models.html#cb409-2" tabindex="-1"></a>var.eps <span class="ot">&lt;-</span> <span class="dv">2451</span></span>
<span id="cb409-3"><a href="hierarchical-mixed-models.html#cb409-3" tabindex="-1"></a>var.B <span class="sc">/</span> (var.B <span class="sc">+</span> var.eps)</span></code></pre></div>
<pre><code>## [1] 0.4185053</code></pre>
<p>To obtain the conditional modes (BLUPs) of the batch-level random effect, we can use the command <code>ranef</code>:</p>
<div class="sourceCode" id="cb411"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb411-1"><a href="hierarchical-mixed-models.html#cb411-1" tabindex="-1"></a><span class="fu">ranef</span>(fm2)</span></code></pre></div>
<pre><code>## $Batch
##   (Intercept)
## A -17.6068514
## B   0.3912634
## C  28.5622256
## D -23.0845385
## E  56.7331877
## F -44.9952868
## 
## with conditional variances for &quot;Batch&quot;</code></pre>
<p>The conditional modes given here correspond to the differences between the mean for each batch and the overall mean (<span class="math inline">\(\mu\)</span>). To convert these to best guesses for the mean of each batch, we have to the overall mean back. This can be done by using the command <code>fixef</code> to extract the lone fixed-effect estimate from the model:</p>
<div class="sourceCode" id="cb413"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb413-1"><a href="hierarchical-mixed-models.html#cb413-1" tabindex="-1"></a>(batch.conditional.modes <span class="ot">&lt;-</span> (<span class="fu">fixef</span>(fm2) <span class="sc">+</span> <span class="fu">ranef</span>(fm2)<span class="sc">$</span>Batch<span class="sc">$</span><span class="st">`</span><span class="at">(Intercept)</span><span class="st">`</span>))</span></code></pre></div>
<pre><code>## [1] 1509.893 1527.891 1556.062 1504.415 1584.233 1482.505</code></pre>
<p>It is informative to compare the conditional models for each batch to the sample means. We can calculate the sample means with the <code>tapply</code> function</p>
<div class="sourceCode" id="cb415"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb415-1"><a href="hierarchical-mixed-models.html#cb415-1" tabindex="-1"></a>(batch.means <span class="ot">&lt;-</span> <span class="fu">with</span>(Dyestuff, <span class="fu">tapply</span>(Yield, Batch, mean)))</span></code></pre></div>
<pre><code>##    A    B    C    D    E    F 
## 1505 1528 1564 1498 1600 1470</code></pre>
<p>Now plot the sample means against the conditional modes:</p>
<div class="sourceCode" id="cb417"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb417-1"><a href="hierarchical-mixed-models.html#cb417-1" tabindex="-1"></a><span class="fu">plot</span>(<span class="at">x    =</span> batch.means, </span>
<span id="cb417-2"><a href="hierarchical-mixed-models.html#cb417-2" tabindex="-1"></a>     <span class="at">y    =</span> batch.conditional.modes, </span>
<span id="cb417-3"><a href="hierarchical-mixed-models.html#cb417-3" tabindex="-1"></a>     <span class="at">xlim =</span> <span class="fu">range</span>(batch.means), </span>
<span id="cb417-4"><a href="hierarchical-mixed-models.html#cb417-4" tabindex="-1"></a>     <span class="at">ylim =</span> <span class="fu">range</span>(batch.means), </span>
<span id="cb417-5"><a href="hierarchical-mixed-models.html#cb417-5" tabindex="-1"></a>     <span class="at">xlab =</span> <span class="st">&quot;sample means&quot;</span>,</span>
<span id="cb417-6"><a href="hierarchical-mixed-models.html#cb417-6" tabindex="-1"></a>     <span class="at">ylab =</span> <span class="st">&quot;conditional modes&quot;</span>,</span>
<span id="cb417-7"><a href="hierarchical-mixed-models.html#cb417-7" tabindex="-1"></a>     <span class="at">pch  =</span> LETTERS[<span class="dv">1</span><span class="sc">:</span><span class="dv">6</span>])</span>
<span id="cb417-8"><a href="hierarchical-mixed-models.html#cb417-8" tabindex="-1"></a></span>
<span id="cb417-9"><a href="hierarchical-mixed-models.html#cb417-9" tabindex="-1"></a><span class="fu">abline</span>(<span class="at">a =</span> <span class="dv">0</span>, <span class="at">b =</span> <span class="dv">1</span>)</span></code></pre></div>
<p><img src="06-HierarchicalModels_files/figure-html/unnamed-chunk-10-1.png" width="672" /></p>
<p>The conditional modes are “shrunken” towards the global mean relative to the sample means. Why is this so?</p>
<p>To conduct inferences about the parameters in the hierarchical model, <code>lme4::lmer</code> offers likelihood profiling. This is the same idea that we encountered when we were using the likelihood to calculate profile-based confidence intervals earlier in the course. <code>lme4::lmer</code> does all its profiling on the ML fit, so we begin by refitting our hierarchical model using ML. To do so, set the optional argument <code>REML</code> to <code>FALSE</code>.</p>
<div class="sourceCode" id="cb418"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb418-1"><a href="hierarchical-mixed-models.html#cb418-1" tabindex="-1"></a>fm2ML <span class="ot">&lt;-</span> <span class="fu">lmer</span>(Yield <span class="sc">~</span> <span class="dv">1</span> <span class="sc">+</span> (<span class="dv">1</span> <span class="sc">|</span> Batch), <span class="at">data =</span> Dyestuff, <span class="at">REML =</span> <span class="cn">FALSE</span>)</span>
<span id="cb418-2"><a href="hierarchical-mixed-models.html#cb418-2" tabindex="-1"></a><span class="fu">summary</span>(fm2ML)</span></code></pre></div>
<pre><code>## Linear mixed model fit by maximum likelihood  [&#39;lmerMod&#39;]
## Formula: Yield ~ 1 + (1 | Batch)
##    Data: Dyestuff
## 
##       AIC       BIC    logLik -2*log(L)  df.resid 
##     333.3     337.5    -163.7     327.3        27 
## 
## Scaled residuals: 
##     Min      1Q  Median      3Q     Max 
## -1.4315 -0.7972  0.1480  0.7721  1.8037 
## 
## Random effects:
##  Groups   Name        Variance Std.Dev.
##  Batch    (Intercept) 1388     37.26   
##  Residual             2451     49.51   
## Number of obs: 30, groups:  Batch, 6
## 
## Fixed effects:
##             Estimate Std. Error t value
## (Intercept)  1527.50      17.69   86.33</code></pre>
<p>Switching to ML has decreased our estimate of the batch-level variance, and decreased it by quite a bit. To construct profile-based intervals, we use the <code>lme4::profile</code> function.<a href="#fn7" class="footnote-ref" id="fnref7"><sup>7</sup></a> We will use the <code>xyplot</code> function from the <code>lattice</code> package to display the profiles.</p>
<div class="sourceCode" id="cb420"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb420-1"><a href="hierarchical-mixed-models.html#cb420-1" tabindex="-1"></a>pr <span class="ot">&lt;-</span> <span class="fu">profile</span>(fm2ML)</span>
<span id="cb420-2"><a href="hierarchical-mixed-models.html#cb420-2" tabindex="-1"></a>lattice<span class="sc">::</span><span class="fu">xyplot</span>(pr)</span></code></pre></div>
<p><img src="06-HierarchicalModels_files/figure-html/unnamed-chunk-12-1.png" width="672" /></p>
<p>There are three panels here, one for each of the parameters in the model. These parameters are labeled as <span class="math inline">\(\sigma_1\)</span> for the standard deviation of the block-level random effect (what we have written <span class="math inline">\(\sigma_B\)</span>), <span class="math inline">\(\sigma\)</span> for the standard deviation of the errors (what we have written as <span class="math inline">\(\sigma_\varepsilon\)</span>), and “(Intercept)” for the global mean (what we have written as <span class="math inline">\(\mu\)</span>).</p>
<p>Within each panel, the values plotted on the vertical axis are the signed square roots of the likelihood ratio test statistic. This value is denoted by the Greek letter <span class="math inline">\(\zeta\)</span> (“zeta”); hence, the plots we are viewing are called zeta-plots.</p>
<p>I do not know how widely used zeta-plots are. They may be more common in other realms of science, although I have never encountered them outside <code>lme4</code>. Basically, they are a visualization of profile-likelihood based confidence intervals. The vertical lines in each panel give the limits of (working from the inside out) 50%, 80%, 90%, 95%, and 99% confidence intervals for each parameter. We can also extract these confidence limits using the <code>confint</code> function. Below, we show 95% confidence intervals; of course, one can change the confidence level as needed.</p>
<div class="sourceCode" id="cb421"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb421-1"><a href="hierarchical-mixed-models.html#cb421-1" tabindex="-1"></a><span class="fu">confint</span>(pr, <span class="at">level =</span> .<span class="dv">95</span>)</span></code></pre></div>
<pre><code>##                  2.5 %     97.5 %
## .sig01        12.19854   84.06305
## .sigma        38.22998   67.65770
## (Intercept) 1486.45150 1568.54849</code></pre>
<p>So, a 95% confidence interval for <span class="math inline">\(\mu\)</span> ranges from 1486 to 1569.</p>
<p>Here is a bit more about the logic behind zeta plots (feel free to skip this paragraph if you wish). Recall that negative log-likelihood profiles are convex and approximately quadratic. Plotting the LRT statistic instead of the likelihood itself has the effect of placing the nadir of these curves at 0, instead of at the value of the negative log-likelihood. Taking the square root of the LRT statistic converts a quadratic curve (a u-shape) into a linear one (a v-shape). We can see this v-shape by using the optional argument <code>absVal = TRUE</code>:</p>
<div class="sourceCode" id="cb423"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb423-1"><a href="hierarchical-mixed-models.html#cb423-1" tabindex="-1"></a>lattice<span class="sc">::</span><span class="fu">xyplot</span>(pr, <span class="at">absVal =</span> <span class="cn">TRUE</span>)</span></code></pre></div>
<p><img src="06-HierarchicalModels_files/figure-html/unnamed-chunk-14-1.png" width="672" /></p>
<p>The purpose of using a signed square root is to turn the U-shaped plots of profile likelihoods into V-shaped plots. Some might argue that V-shaped plots are useful because it makes it easier to detect the asymmetries between the left and right halves of the plot.</p>
<p>(Start reading again if you skipped the above detail). There is an interesting detail to the zeta-plots. Consider the zeta-plot for <span class="math inline">\(\sigma_1\)</span> (the standard deviation of the batch-level random effects), and try to find the lower limit of a 99% confidence interval. You’ll notice that the zeta-plot hits 0 (the lowest possible value for a standard deviation) before the interval is completed. Thus, the lower limit of this interval is 0:</p>
<div class="sourceCode" id="cb424"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb424-1"><a href="hierarchical-mixed-models.html#cb424-1" tabindex="-1"></a><span class="fu">confint</span>(pr, <span class="at">level =</span> <span class="fl">0.99</span>)</span></code></pre></div>
<pre><code>##                  0.5 %     99.5 %
## .sig01         0.00000  113.68769
## .sigma        35.56317   75.66803
## (Intercept) 1465.87401 1589.12602</code></pre>
<p>Although we are not much in the habit of conducting hypothesis tests in this course, we would conclude that we would fail to reject the null hypothesis that the batch-level variance equals 0 with a 99% level test.</p>
<p>We can also obtain bivariate confidence regions from the profile likelihood using the <code>lattice::splom</code> command.</p>
<div class="sourceCode" id="cb426"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb426-1"><a href="hierarchical-mixed-models.html#cb426-1" tabindex="-1"></a>lattice<span class="sc">::</span><span class="fu">splom</span>(pr)</span></code></pre></div>
<p><img src="06-HierarchicalModels_files/figure-html/dyestuff%20bivariate%20confidence%20regions-1.png" width="672" />
Panels above the diagonal show bivariate, profile-based confidence regions for each pair of parameters. Within each panel, we see 50%, 80%, 90%, 95%, and 99% confidence regions. The panels show, for example, that the estimate of the observation-level standard deviation is slightly negatively correlated with the estimate of the batch-level standard deviation. Panels below the diagonal show the same plots on the <span class="math inline">\(\zeta\)</span> scale. See <span class="citation">Bates (<a href="#ref-bates2012lme4">2012+</a>)</span> 1.5.3 for a detailed description of how to interpret these plots.</p>
<p>There is a second approach to calculating confidence intervals and/or conducting hypothesis tests for fixed-effect parameters. <a href="https://stat.ethz.ch/pipermail/r-help/2006-May/094765.html">Famously,</a> <code>lme4::lmer</code> does not provide degrees of freedom for the estimates of the fixed effects. The package <code>lmerTest</code> uses the Satterthwaite approximation to estimate these df.</p>
<div class="sourceCode" id="cb427"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb427-1"><a href="hierarchical-mixed-models.html#cb427-1" tabindex="-1"></a><span class="fu">require</span>(lmerTest)</span></code></pre></div>
<pre><code>## Loading required package: lmerTest</code></pre>
<pre><code>## 
## Attaching package: &#39;lmerTest&#39;</code></pre>
<pre><code>## The following object is masked from &#39;package:lme4&#39;:
## 
##     lmer</code></pre>
<pre><code>## The following object is masked from &#39;package:stats&#39;:
## 
##     step</code></pre>
<div class="sourceCode" id="cb432"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb432-1"><a href="hierarchical-mixed-models.html#cb432-1" tabindex="-1"></a>fm3 <span class="ot">&lt;-</span> lmerTest<span class="sc">::</span><span class="fu">lmer</span>(Yield <span class="sc">~</span> <span class="dv">1</span> <span class="sc">+</span> (<span class="dv">1</span> <span class="sc">|</span> Batch), <span class="at">data =</span> Dyestuff)</span>
<span id="cb432-2"><a href="hierarchical-mixed-models.html#cb432-2" tabindex="-1"></a><span class="fu">summary</span>(fm3)</span></code></pre></div>
<pre><code>## Linear mixed model fit by REML. t-tests use Satterthwaite&#39;s method [
## lmerModLmerTest]
## Formula: Yield ~ 1 + (1 | Batch)
##    Data: Dyestuff
## 
## REML criterion at convergence: 319.7
## 
## Scaled residuals: 
##     Min      1Q  Median      3Q     Max 
## -1.4117 -0.7634  0.1418  0.7792  1.8296 
## 
## Random effects:
##  Groups   Name        Variance Std.Dev.
##  Batch    (Intercept) 1764     42.00   
##  Residual             2451     49.51   
## Number of obs: 30, groups:  Batch, 6
## 
## Fixed effects:
##             Estimate Std. Error      df t value Pr(&gt;|t|)    
## (Intercept)  1527.50      19.38    5.00    78.8 6.23e-09 ***
## ---
## Signif. codes:  0 &#39;***&#39; 0.001 &#39;**&#39; 0.01 &#39;*&#39; 0.05 &#39;.&#39; 0.1 &#39; &#39; 1</code></pre>
<p><code>lmerTest::lmer</code> gives the associated df for the estimate of the intercept as 5. If this were a class in experimental design, we would regard the individual measurements from each batch as subsamples, in which case the correct df for inferences about the intercept should be <span class="math inline">\(6 - 1 = 5\)</span>. In this case, the calculation from <code>lmerTest::lmer</code> matches our intuition.</p>
<p>Equipped with this information, we could construct a 95% confidence interval for the overall mean as</p>
<div class="sourceCode" id="cb434"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb434-1"><a href="hierarchical-mixed-models.html#cb434-1" tabindex="-1"></a><span class="fl">1527.5</span> <span class="sc">+</span> <span class="fl">19.38</span> <span class="sc">*</span>  <span class="fu">qt</span>(<span class="fu">c</span>(<span class="fl">0.025</span>, <span class="fl">0.975</span>), <span class="at">df =</span> <span class="dv">5</span>)</span></code></pre></div>
<pre><code>## [1] 1477.682 1577.318</code></pre>
<p>Compare this interval with the profile interval generated by <code>lme4::profile</code>.</p>
<p>Finally, we can also obtain prediction intervals on the conditional modes of the random effects by using the <code>condVar = TRUE</code> option in a call to <code>ranef</code>. We illustrate below, and direct the output to <code>lattice::dotplot</code> for visualization. Each line below shows a 95% prediction interval for a conditional mode. When there are many levels of the random effect, <span class="citation">Bates (<a href="#ref-bates2012lme4">2012+</a>)</span> recommends using <code>lattice::qqmath</code> instead of <code>lattice::dotplot</code>.</p>
<div class="sourceCode" id="cb436"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb436-1"><a href="hierarchical-mixed-models.html#cb436-1" tabindex="-1"></a>lattice<span class="sc">::</span><span class="fu">dotplot</span>(<span class="fu">ranef</span>(fm2, <span class="at">condVar =</span> <span class="cn">TRUE</span>))</span></code></pre></div>
<pre><code>## $Batch</code></pre>
<p><img src="06-HierarchicalModels_files/figure-html/unnamed-chunk-18-1.png" width="672" /></p>
</div>
<div id="bayesian-analysis" class="section level3 hasAnchor" number="6.1.2">
<h3><span class="header-section-number">6.1.2</span> Bayesian analysis<a href="hierarchical-mixed-models.html#bayesian-analysis" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<p>The variance-components model is our first encounter with a hierarchical model. One often hears the phrase “Bayesian hierarchical model” in ecology. It is important to realize that not all Bayesian models are hierarchical, and not all hierarchical models are Bayesian. Indeed, we have seen examples of both: none of the Bayesian examples that we have seen in earlier chapters were hierarchical, and the mixed-model analysis of the Dyestuff data is a hierarchical model analyzed from a frequentist perspective. However, we can certainly analyze hierarchical models from a Bayesian perspective as well, leading to a Bayesian hierarchical model.</p>
<p>The above paragraph begs the question: What defines a hierarchical model? One can find definitions in the literature, though it isn’t clear to me that any of these definitions are fully precise, although I may just be ignorant. As best I can tell, a hierarchical model is one that includes so-called “latent” variables. Latent variables are unobservable quantities on which the data depend, that in turn are related to model parameters via a statistical model. This “layered” construction of the model (observables depend on latent variables, and latent variables depend on model parameters) gives rise to the “hierarchy” that gives hierarchical models their name.</p>
<p>This hierarchical perspective can be emphasized by how the model is written. For the dyestuff data, when we write
<span class="math display">\[\begin{align}
y_{ij} &amp; \sim \mathcal{N}(B_i, \sigma^2_\varepsilon) \\
B_i &amp; \stackrel{\text{iid}}{\sim} \mathcal{N}(\mu, \sigma^2_B) \\
\end{align}\]</span></p>
<p>we emphasize that the distribution of the data depends in part on the latent variables <span class="math inline">\(B_i\)</span>, and the distribution of the latent variables depends in turn on some of the model parameters.</p>
<p>To complete the Bayesian specification, we need to place priors on our three parameters: <span class="math inline">\(\mu\)</span>, <span class="math inline">\(\sigma^2_B\)</span>, and <span class="math inline">\(\sigma^2_\varepsilon\)</span>. In the absence of any information, we might choose a vague normal prior for <span class="math inline">\(\mu\)</span>, and vague gamma priors for <span class="math inline">\(1/\sigma^2_B\)</span> and <span class="math inline">\(1/\sigma^2_\varepsilon\)</span>. The following <code>R2Jags</code> code implements such a model.</p>
<div class="sourceCode" id="cb438"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb438-1"><a href="hierarchical-mixed-models.html#cb438-1" tabindex="-1"></a><span class="fu">require</span>(R2jags)</span></code></pre></div>
<pre><code>## Loading required package: R2jags</code></pre>
<pre><code>## Loading required package: rjags</code></pre>
<pre><code>## Loading required package: coda</code></pre>
<pre><code>## Linked to JAGS 4.3.1</code></pre>
<pre><code>## Loaded modules: basemod,bugs</code></pre>
<pre><code>## 
## Attaching package: &#39;R2jags&#39;</code></pre>
<pre><code>## The following object is masked from &#39;package:coda&#39;:
## 
##     traceplot</code></pre>
<div class="sourceCode" id="cb446"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb446-1"><a href="hierarchical-mixed-models.html#cb446-1" tabindex="-1"></a>dyestuff.model <span class="ot">&lt;-</span> <span class="cf">function</span>() {</span>
<span id="cb446-2"><a href="hierarchical-mixed-models.html#cb446-2" tabindex="-1"></a>  </span>
<span id="cb446-3"><a href="hierarchical-mixed-models.html#cb446-3" tabindex="-1"></a>  <span class="do">## likelihood</span></span>
<span id="cb446-4"><a href="hierarchical-mixed-models.html#cb446-4" tabindex="-1"></a>  </span>
<span id="cb446-5"><a href="hierarchical-mixed-models.html#cb446-5" tabindex="-1"></a>  <span class="cf">for</span> (j <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span>J) {            </span>
<span id="cb446-6"><a href="hierarchical-mixed-models.html#cb446-6" tabindex="-1"></a>    </span>
<span id="cb446-7"><a href="hierarchical-mixed-models.html#cb446-7" tabindex="-1"></a>    y[j]    <span class="sc">~</span> <span class="fu">dnorm</span>(B[batch[j]], tau_eps)  <span class="co"># data distribution</span></span>
<span id="cb446-8"><a href="hierarchical-mixed-models.html#cb446-8" tabindex="-1"></a>  }</span>
<span id="cb446-9"><a href="hierarchical-mixed-models.html#cb446-9" tabindex="-1"></a>  </span>
<span id="cb446-10"><a href="hierarchical-mixed-models.html#cb446-10" tabindex="-1"></a>  <span class="do">## latent variables</span></span>
<span id="cb446-11"><a href="hierarchical-mixed-models.html#cb446-11" tabindex="-1"></a>  </span>
<span id="cb446-12"><a href="hierarchical-mixed-models.html#cb446-12" tabindex="-1"></a>  <span class="cf">for</span> (b <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span><span class="dv">6</span>){</span>
<span id="cb446-13"><a href="hierarchical-mixed-models.html#cb446-13" tabindex="-1"></a>  </span>
<span id="cb446-14"><a href="hierarchical-mixed-models.html#cb446-14" tabindex="-1"></a>    B[b] <span class="sc">~</span> <span class="fu">dnorm</span>(mu, tauB)</span>
<span id="cb446-15"><a href="hierarchical-mixed-models.html#cb446-15" tabindex="-1"></a>  }</span>
<span id="cb446-16"><a href="hierarchical-mixed-models.html#cb446-16" tabindex="-1"></a>  </span>
<span id="cb446-17"><a href="hierarchical-mixed-models.html#cb446-17" tabindex="-1"></a>  mu <span class="sc">~</span> <span class="fu">dnorm</span> (<span class="fl">0.0</span>, <span class="fl">1E-6</span>)  <span class="co"># prior for the overall mean</span></span>
<span id="cb446-18"><a href="hierarchical-mixed-models.html#cb446-18" tabindex="-1"></a>  </span>
<span id="cb446-19"><a href="hierarchical-mixed-models.html#cb446-19" tabindex="-1"></a>  tau_eps <span class="sc">~</span> <span class="fu">dgamma</span>(.<span class="dv">01</span>, .<span class="dv">01</span>)  <span class="co"># ok here because these are precisions</span></span>
<span id="cb446-20"><a href="hierarchical-mixed-models.html#cb446-20" tabindex="-1"></a>  tauB    <span class="sc">~</span> <span class="fu">dgamma</span>(.<span class="dv">01</span>, .<span class="dv">01</span>)</span>
<span id="cb446-21"><a href="hierarchical-mixed-models.html#cb446-21" tabindex="-1"></a>  </span>
<span id="cb446-22"><a href="hierarchical-mixed-models.html#cb446-22" tabindex="-1"></a>  sd_eps <span class="ot">&lt;-</span> <span class="fu">pow</span>(tau_eps, <span class="sc">-</span><span class="dv">1</span><span class="sc">/</span><span class="dv">2</span>)</span>
<span id="cb446-23"><a href="hierarchical-mixed-models.html#cb446-23" tabindex="-1"></a>  sdB    <span class="ot">&lt;-</span> <span class="fu">pow</span>(tauB, <span class="sc">-</span><span class="dv">1</span><span class="sc">/</span><span class="dv">2</span>)</span>
<span id="cb446-24"><a href="hierarchical-mixed-models.html#cb446-24" tabindex="-1"></a>}</span>
<span id="cb446-25"><a href="hierarchical-mixed-models.html#cb446-25" tabindex="-1"></a></span>
<span id="cb446-26"><a href="hierarchical-mixed-models.html#cb446-26" tabindex="-1"></a>jags.data <span class="ot">&lt;-</span> <span class="fu">list</span>(<span class="at">y     =</span> Dyestuff<span class="sc">$</span>Yield, </span>
<span id="cb446-27"><a href="hierarchical-mixed-models.html#cb446-27" tabindex="-1"></a>                  <span class="at">batch =</span> <span class="fu">as.numeric</span>(Dyestuff<span class="sc">$</span>Batch), </span>
<span id="cb446-28"><a href="hierarchical-mixed-models.html#cb446-28" tabindex="-1"></a>                  <span class="at">J     =</span> <span class="fu">nrow</span>(Dyestuff))</span>
<span id="cb446-29"><a href="hierarchical-mixed-models.html#cb446-29" tabindex="-1"></a></span>
<span id="cb446-30"><a href="hierarchical-mixed-models.html#cb446-30" tabindex="-1"></a>jags.params <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">&quot;mu&quot;</span>, <span class="st">&quot;sd_eps&quot;</span>, <span class="st">&quot;sdB&quot;</span>, <span class="st">&quot;B[1]&quot;</span>, <span class="st">&quot;B[2]&quot;</span>)</span>
<span id="cb446-31"><a href="hierarchical-mixed-models.html#cb446-31" tabindex="-1"></a></span>
<span id="cb446-32"><a href="hierarchical-mixed-models.html#cb446-32" tabindex="-1"></a>jags.inits <span class="ot">&lt;-</span> <span class="cf">function</span>(){</span>
<span id="cb446-33"><a href="hierarchical-mixed-models.html#cb446-33" tabindex="-1"></a>  <span class="fu">list</span>(<span class="st">&quot;mu&quot;</span> <span class="ot">=</span> <span class="fu">rnorm</span>(<span class="dv">1</span>, .<span class="dv">01</span>), <span class="st">&quot;tauB&quot;</span> <span class="ot">=</span> <span class="fu">dexp</span>(<span class="dv">1</span>, <span class="dv">1</span>), <span class="st">&quot;tau_eps&quot;</span> <span class="ot">=</span> <span class="fu">dexp</span>(<span class="dv">1</span>, <span class="dv">1</span>))</span>
<span id="cb446-34"><a href="hierarchical-mixed-models.html#cb446-34" tabindex="-1"></a>}</span>
<span id="cb446-35"><a href="hierarchical-mixed-models.html#cb446-35" tabindex="-1"></a></span>
<span id="cb446-36"><a href="hierarchical-mixed-models.html#cb446-36" tabindex="-1"></a>jagsfit <span class="ot">&lt;-</span> <span class="fu">jags</span>(<span class="at">data               =</span> jags.data, </span>
<span id="cb446-37"><a href="hierarchical-mixed-models.html#cb446-37" tabindex="-1"></a>                <span class="at">inits              =</span> jags.inits, </span>
<span id="cb446-38"><a href="hierarchical-mixed-models.html#cb446-38" tabindex="-1"></a>                <span class="at">parameters.to.save =</span> jags.params,</span>
<span id="cb446-39"><a href="hierarchical-mixed-models.html#cb446-39" tabindex="-1"></a>                <span class="at">model.file         =</span> dyestuff.model,</span>
<span id="cb446-40"><a href="hierarchical-mixed-models.html#cb446-40" tabindex="-1"></a>                <span class="at">n.chains           =</span> <span class="dv">3</span>,</span>
<span id="cb446-41"><a href="hierarchical-mixed-models.html#cb446-41" tabindex="-1"></a>                <span class="at">n.iter             =</span> <span class="fl">1e5</span>,</span>
<span id="cb446-42"><a href="hierarchical-mixed-models.html#cb446-42" tabindex="-1"></a>                <span class="at">jags.seed          =</span> <span class="dv">1</span>)</span></code></pre></div>
<pre><code>## module glm loaded</code></pre>
<p>The code above requires a way to associate each observation with the batch from which the observation was drawn. We accomplish this by creating the variable <code>batch</code> that associates each observation with the numerical index of the batch. (That is, batch “A” is associated with the index 1, etc.) In the code, this happens with the line</p>
<div class="sourceCode" id="cb448"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb448-1"><a href="hierarchical-mixed-models.html#cb448-1" tabindex="-1"></a>batch <span class="ot">=</span> <span class="fu">as.numeric</span>(Dyestuff<span class="sc">$</span>Batch)</span></code></pre></div>
<p>The <code>as.numeric</code> command returns numerical values for each level of the factor <code>Batch</code>.</p>
<p>Note also that we have only asked for the posterior draws for the latent means of the first two batches, <span class="math inline">\(B_1\)</span> and <span class="math inline">\(B_2\)</span>. This is merely to keep the output small for this example. We could of course ask for the means of the other batches as well.</p>
<p>Let’s have a look at the output:</p>
<div class="sourceCode" id="cb449"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb449-1"><a href="hierarchical-mixed-models.html#cb449-1" tabindex="-1"></a><span class="fu">print</span>(jagsfit)</span></code></pre></div>
<pre><code>## Inference for Bugs model at &quot;C:/Users/krgross/AppData/Local/Temp/RtmpSSij12/model20fc31927764&quot;, fit using jags,
##  3 chains, each with 1e+05 iterations (first 50000 discarded), n.thin = 50
##  n.sims = 3000 iterations saved. Running time = 0.48 secs
##           mu.vect sd.vect     2.5%      25%      50%      75%    97.5%  Rhat
## B[1]     1513.631  20.231 1471.283 1499.935 1514.682 1527.592 1550.754 1.001
## B[2]     1527.720  19.488 1488.551 1515.797 1527.451 1539.246 1567.505 1.001
## mu       1526.379  21.314 1482.536 1514.950 1526.401 1538.284 1569.024 1.001
## sdB        38.868  26.648    0.243   21.745   36.584   52.500   99.655 1.001
## sd_eps     54.118   9.197   39.638   47.410   52.933   59.810   75.858 1.001
## deviance  323.634   6.366  315.031  318.496  322.035  328.214  336.401 1.001
##          n.eff
## B[1]      3000
## B[2]      3000
## mu        3000
## sdB       3000
## sd_eps    3000
## deviance  3000
## 
## For each parameter, n.eff is a crude measure of effective sample size,
## and Rhat is the potential scale reduction factor (at convergence, Rhat=1).
## 
## DIC info (using the rule: pV = var(deviance)/2)
## pV = 20.3 and DIC = 343.9
## DIC is an estimate of expected predictive error (lower deviance is better).</code></pre>
<div class="sourceCode" id="cb451"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb451-1"><a href="hierarchical-mixed-models.html#cb451-1" tabindex="-1"></a><span class="fu">traceplot</span>(jagsfit)  </span></code></pre></div>
<p><img src="06-HierarchicalModels_files/figure-html/unnamed-chunk-21-1.png" width="672" /><img src="06-HierarchicalModels_files/figure-html/unnamed-chunk-21-2.png" width="672" /><img src="06-HierarchicalModels_files/figure-html/unnamed-chunk-21-3.png" width="672" /><img src="06-HierarchicalModels_files/figure-html/unnamed-chunk-21-4.png" width="672" /><img src="06-HierarchicalModels_files/figure-html/unnamed-chunk-21-5.png" width="672" /><img src="06-HierarchicalModels_files/figure-html/unnamed-chunk-21-6.png" width="672" /></p>
<div class="sourceCode" id="cb452"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb452-1"><a href="hierarchical-mixed-models.html#cb452-1" tabindex="-1"></a><span class="fu">require</span>(lattice)</span></code></pre></div>
<pre><code>## Loading required package: lattice</code></pre>
<div class="sourceCode" id="cb454"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb454-1"><a href="hierarchical-mixed-models.html#cb454-1" tabindex="-1"></a>jagsfit.mcmc <span class="ot">&lt;-</span> <span class="fu">as.mcmc</span>(jagsfit)</span>
<span id="cb454-2"><a href="hierarchical-mixed-models.html#cb454-2" tabindex="-1"></a><span class="fu">densityplot</span>(jagsfit.mcmc)</span></code></pre></div>
<p><img src="06-HierarchicalModels_files/figure-html/unnamed-chunk-21-7.png" width="672" /></p>
<p>One especially appealing aspect of analyzing this model from a Bayesian perspective is that there is no awkwardness in analyzing the posterior distributions of the latent variables, namely, the batch-specific means. From the frequentist perspective, it is somewhat awkward (though not prohibitively so) to define the conditional modes (BLUPs). We also lack straightforward methods for quantifying the uncertainty in these conditional modes. From the Bayesian viewpoint, this awkwardness disappears, because the distinction between model parameters and latent variables vanishes. Both are simply unobserved quantities. Consequently, it is natural to summarize our posterior knowledge about the latent variables by their (marginal) posterior distributions, in the same way that we use marginal posteriors to summarize our inferences about the model parameters.</p>
</div>
<div id="negative-within-group-correlations" class="section level3 hasAnchor" number="6.1.3">
<h3><span class="header-section-number">6.1.3</span> Negative within-group correlations<a href="hierarchical-mixed-models.html#negative-within-group-correlations" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<p>The hierarchical model formulation, regardless of whether analyzed from a frequentist or Bayesian perspective, is just a model. All models are wrong, but some models are useful. One can encounter grouped data where the hierarchical formulation is not useful. To illustrate, we consider the <code>Dyestuff2</code> data provided in <code>lme4</code>. These are synthetic (fake) data that have been created by <span class="citation">Box and Tiao (<a href="#ref-box1973">1973</a>)</span> for the sake of illustration. The Dyestuff2 data have the same structure as the original Dyestuff data, that is, 5 observations from each of 6 batches.</p>
<div class="sourceCode" id="cb455"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb455-1"><a href="hierarchical-mixed-models.html#cb455-1" tabindex="-1"></a><span class="fu">data</span>(Dyestuff2)</span>
<span id="cb455-2"><a href="hierarchical-mixed-models.html#cb455-2" tabindex="-1"></a><span class="fu">summary</span>(Dyestuff2)</span></code></pre></div>
<pre><code>##  Batch     Yield       
##  A:5   Min.   :-0.892  
##  B:5   1st Qu.: 2.765  
##  C:5   Median : 5.365  
##  D:5   Mean   : 5.666  
##  E:5   3rd Qu.: 8.151  
##  F:5   Max.   :13.434</code></pre>
<div class="sourceCode" id="cb457"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb457-1"><a href="hierarchical-mixed-models.html#cb457-1" tabindex="-1"></a><span class="fu">with</span>(Dyestuff2, <span class="fu">stripchart</span>(Yield <span class="sc">~</span> Batch, <span class="at">pch =</span> <span class="dv">16</span>))</span></code></pre></div>
<p><img src="06-HierarchicalModels_files/figure-html/unnamed-chunk-22-1.png" width="672" /></p>
<p>We’ll begin by fitting a GLS model that includes a within-batch correlation:</p>
<div class="sourceCode" id="cb458"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb458-1"><a href="hierarchical-mixed-models.html#cb458-1" tabindex="-1"></a>fm6 <span class="ot">&lt;-</span> <span class="fu">gls</span>(Yield <span class="sc">~</span> <span class="dv">1</span>, <span class="at">data =</span> Dyestuff2, <span class="at">correlation =</span> <span class="fu">corCompSymm</span>(<span class="at">form =</span> <span class="sc">~</span> <span class="dv">1</span> <span class="sc">|</span> Batch))</span>
<span id="cb458-2"><a href="hierarchical-mixed-models.html#cb458-2" tabindex="-1"></a><span class="fu">summary</span>(fm6)</span></code></pre></div>
<pre><code>## Generalized least squares fit by REML
##   Model: Yield ~ 1 
##   Data: Dyestuff2 
##        AIC      BIC    logLik
##   167.2092 171.3111 -80.60461
## 
## Correlation Structure: Compound symmetry
##  Formula: ~1 | Batch 
##  Parameter estimate(s):
##        Rho 
## -0.0970284 
## 
## Coefficients:
##              Value Std.Error  t-value p-value
## (Intercept) 5.6656 0.5271409 10.74779       0
## 
## Standardized residuals:
##         Min          Q1         Med          Q3         Max 
## -1.77661357 -0.78584319 -0.08143986  0.67335540  2.10464878 
## 
## Residual standard error: 3.691067 
## Degrees of freedom: 30 total; 29 residual</code></pre>
<p>Notice that the within-batch correlation is negative. What does this imply about the structure of the data?</p>
<p>Let’s have a look at a hierarchical model, fit with <code>lmer</code>.</p>
<div class="sourceCode" id="cb460"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb460-1"><a href="hierarchical-mixed-models.html#cb460-1" tabindex="-1"></a>fm6 <span class="ot">&lt;-</span> lme4<span class="sc">::</span><span class="fu">lmer</span>(Yield <span class="sc">~</span> <span class="dv">1</span> <span class="sc">+</span> (<span class="dv">1</span> <span class="sc">|</span> Batch), <span class="at">data =</span> Dyestuff2)</span></code></pre></div>
<pre><code>## boundary (singular) fit: see help(&#39;isSingular&#39;)</code></pre>
<div class="sourceCode" id="cb462"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb462-1"><a href="hierarchical-mixed-models.html#cb462-1" tabindex="-1"></a><span class="fu">summary</span>(fm6)</span></code></pre></div>
<pre><code>## Linear mixed model fit by REML [&#39;lmerMod&#39;]
## Formula: Yield ~ 1 + (1 | Batch)
##    Data: Dyestuff2
## 
## REML criterion at convergence: 161.8
## 
## Scaled residuals: 
##     Min      1Q  Median      3Q     Max 
## -1.7648 -0.7806 -0.0809  0.6689  2.0907 
## 
## Random effects:
##  Groups   Name        Variance Std.Dev.
##  Batch    (Intercept)  0.00    0.000   
##  Residual             13.81    3.716   
## Number of obs: 30, groups:  Batch, 6
## 
## Fixed effects:
##             Estimate Std. Error t value
## (Intercept)   5.6656     0.6784   8.352
## optimizer (nloptwrap) convergence code: 0 (OK)
## boundary (singular) fit: see help(&#39;isSingular&#39;)</code></pre>
<p>The estimate of the among-batch variance, <span class="math inline">\(\sigma^2_B\)</span>, is 0. The warning generated by R tells us that our fit is singular: one of the estimated parameters lies on the boundary of its possible values. To quote <span class="citation">Bates (<a href="#ref-bates2012lme4">2012+</a>)</span> (using our notation):</p>
<blockquote>
<p>“An estimate of 0 for <span class="math inline">\(\sigma_B\)</span> does not mean that there is no variation between the groups. Indeed, … there is some small amount of variability between the groups. The estimate, <span class="math inline">\(\hat{\sigma}_B=0\)</span>, simply indicates that the level of ‘between-group’ variability is not sufficient to warrant incorporating random effects in the model.</p>
</blockquote>
<blockquote>
<p>“The important point … is that we must allow for the estimates of variance components to be zero. We describe such a model as being degenerate, in the sense that it corresponds to a linear model in which we have removed the randdom effects associated with Batch. Degenerate models can and do occur in practice. Eveen when the final fitted model is not degenerate, we must allow for such models when determining the parameter estimates through numerical optimization.”</p>
</blockquote>
<p>Can you think of any ecological mechanisms that might give rise to negative within-group correlations?</p>
</div>
</div>
<div id="moth-mm" class="section level2 hasAnchor" number="6.2">
<h2><span class="header-section-number">6.2</span> Industrial melanism data<a href="hierarchical-mixed-models.html#moth-mm" class="anchor-section" aria-label="Anchor link to header"></a></h2>
<p>The data we analyze here come from a famous ecological study investigating predation on light and dark colored moths along an urban-rural transect outside of Liverpool, England. We will examine several approaches to analyzing these data. The original source for these data is <span class="citation">Bishop (<a href="#ref-bishop1972">1972</a>)</span>; I obtained them from <span class="citation">Ramsey and Schafer (<a href="#ref-ramsey2002">2002</a>)</span>. These data consist of paired binomial responses with two covariates: distance from Liverpool (a station-level covariate) and color morph (an observation-level covariate).</p>
<p>Although simple, these data contain many features that complicate their analysis:</p>
<ul>
<li>Observations from the same location are (positively) correlated, presumably because the predation pressure varies from one location to the next.</li>
<li>The responses are grouped binomial responses with varying group size (that is, varying numbers of moths placed on trees) at each location.</li>
</ul>
<p>Accommodating both the non-independence (due to the pairing) and the non-normality of these data requires a more sophisticated approach that we will discuss <a href="glmms.html#glmms">later</a>. Here, we will use the empirical logit of the proportion of moths removed to create a response variable that is close enough to normality to justify normal-based approaches. We will focus on using mixed models to accommodate the correlations among observations from the same location.</p>
<p>In notation, let <span class="math inline">\(i=1,2\)</span> index the two color morphs, let <span class="math inline">\(j = 1, \ldots, 7\)</span> index the locations, let <span class="math inline">\(y_{ij}\)</span> give the number of moths removed, let <span class="math inline">\(n_{ij}\)</span> give the number of moths placed, and let <span class="math inline">\(x_j\)</span> give the distance of station <span class="math inline">\(j\)</span> from Liverpool. Here, we will study the model
<span class="math display">\[
\mathrm{logit}(y_{ij} / n_{ij}) = a_i + b_i x_j + \varepsilon_{ij}
\]</span>
which regresses the log odds of moth removal against distance from Liverpool, with different intercepts and slopes for each color morph. We are most interested in learning about the difference <span class="math inline">\(b_1 - b_2\)</span>, which quantifies how the relationship between log odds of removal and distance differs between the two color morphs, and determining whether there is evidence that this difference <span class="math inline">\(\neq 0\)</span>.</p>
<p>The issue at hand is that the observation-level errors—the <span class="math inline">\(\varepsilon_{ij}\)</span>’s—from the same location are likely to be positively correlated.</p>
<!-- Alternatively, we might prefer to consider the quantity $e^{b_1 - b_2} = e^{b_1} / e^{b_2}$, which tells us how the odds ratio for removal changes between the two morphs as distance increases.  This odds ratio is a bit closer to something that we can mentall grasp.  In terms of the odds ratio, we are interested in learning if the odds ratio $\neq 1$. -->
<p>Because there are only two observations per station (that is, the data are paired) one approach is simply to regress the difference of the empirical logits vs. distance. That is, if we define <span class="math inline">\(l_j = \mathrm{logit}(y_{1j} / n_{1j})\)</span> as the log odds of removal for light moths at location <span class="math inline">\(j\)</span>, <span class="math inline">\(d_j = \mathrm{logit}(y_{2j} / n_{2j})\)</span> as the log odds of removal for dark moths at location <span class="math inline">\(j\)</span>, and <span class="math inline">\(\delta_j = d_j - l_j\)</span> as the difference in the log odds of removal between dark and light moths at location <span class="math inline">\(j\)</span>, then we can fit the model
<span class="math display">\[
\delta_j = a + b x_j + \varepsilon_j
\]</span>
as a simple regression. We try this approach first and use it as a benchmark. The data set used here is reformatted to include one record for each of the 7 stations.</p>
<div class="sourceCode" id="cb464"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb464-1"><a href="hierarchical-mixed-models.html#cb464-1" tabindex="-1"></a>moth2 <span class="ot">&lt;-</span> <span class="fu">read.table</span>(<span class="st">&quot;data/moth2.txt&quot;</span>, <span class="at">head =</span> <span class="cn">TRUE</span>, <span class="at">stringsAsFactors =</span> <span class="cn">TRUE</span>)</span>
<span id="cb464-2"><a href="hierarchical-mixed-models.html#cb464-2" tabindex="-1"></a></span>
<span id="cb464-3"><a href="hierarchical-mixed-models.html#cb464-3" tabindex="-1"></a><span class="fu">head</span>(moth2, <span class="at">n =</span> <span class="dv">3</span>)</span></code></pre></div>
<pre><code>##   location distance morph l.placed l.removed d.placed d.removed
## 1       sp      0.0 light       56        17       56        14
## 2       ef      7.2 light       80        28       80        20
## 3       ha     24.1 light       52        18       52        22</code></pre>
<div class="sourceCode" id="cb466"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb466-1"><a href="hierarchical-mixed-models.html#cb466-1" tabindex="-1"></a>elogit <span class="ot">&lt;-</span> <span class="cf">function</span>(x) <span class="fu">log</span>(x <span class="sc">/</span> (<span class="dv">1</span> <span class="sc">-</span> x))</span>
<span id="cb466-2"><a href="hierarchical-mixed-models.html#cb466-2" tabindex="-1"></a></span>
<span id="cb466-3"><a href="hierarchical-mixed-models.html#cb466-3" tabindex="-1"></a>moth2<span class="sc">$</span>elogit.diff <span class="ot">&lt;-</span> <span class="fu">with</span>(moth2, <span class="fu">elogit</span>(d.removed <span class="sc">/</span> d.placed) <span class="sc">-</span> <span class="fu">elogit</span>(l.removed <span class="sc">/</span> l.placed))</span>
<span id="cb466-4"><a href="hierarchical-mixed-models.html#cb466-4" tabindex="-1"></a></span>
<span id="cb466-5"><a href="hierarchical-mixed-models.html#cb466-5" tabindex="-1"></a>fm1 <span class="ot">&lt;-</span> <span class="fu">lm</span>(elogit.diff <span class="sc">~</span> distance, <span class="at">data =</span> moth2)</span>
<span id="cb466-6"><a href="hierarchical-mixed-models.html#cb466-6" tabindex="-1"></a></span>
<span id="cb466-7"><a href="hierarchical-mixed-models.html#cb466-7" tabindex="-1"></a><span class="fu">with</span>(moth2, <span class="fu">plot</span>(elogit.diff <span class="sc">~</span> distance,</span>
<span id="cb466-8"><a href="hierarchical-mixed-models.html#cb466-8" tabindex="-1"></a>                <span class="at">xlab =</span> <span class="st">&quot;distance from city center (km)&quot;</span>,</span>
<span id="cb466-9"><a href="hierarchical-mixed-models.html#cb466-9" tabindex="-1"></a>                <span class="at">ylab =</span> <span class="st">&quot;difference in log odds of removal, dark - light&quot;</span>))</span>
<span id="cb466-10"><a href="hierarchical-mixed-models.html#cb466-10" tabindex="-1"></a></span>
<span id="cb466-11"><a href="hierarchical-mixed-models.html#cb466-11" tabindex="-1"></a><span class="fu">abline</span>(<span class="at">h =</span> <span class="dv">0</span>, <span class="at">lty =</span> <span class="st">&quot;dashed&quot;</span>)</span>
<span id="cb466-12"><a href="hierarchical-mixed-models.html#cb466-12" tabindex="-1"></a><span class="fu">abline</span>(fm1)</span></code></pre></div>
<p><img src="06-HierarchicalModels_files/figure-html/unnamed-chunk-23-1.png" width="384" /></p>
<div class="sourceCode" id="cb467"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb467-1"><a href="hierarchical-mixed-models.html#cb467-1" tabindex="-1"></a><span class="fu">summary</span>(fm1)</span></code></pre></div>
<pre><code>## 
## Call:
## lm(formula = elogit.diff ~ distance, data = moth2)
## 
## Residuals:
##        1        2        3        4        5        6        7 
##  0.10557 -0.30431  0.03501  0.26395 -0.09387  0.29714 -0.30349 
## 
## Coefficients:
##              Estimate Std. Error t value Pr(&gt;|t|)   
## (Intercept) -0.373830   0.192503  -1.942  0.10980   
## distance     0.027579   0.005997   4.599  0.00585 **
## ---
## Signif. codes:  0 &#39;***&#39; 0.001 &#39;**&#39; 0.01 &#39;*&#39; 0.05 &#39;.&#39; 0.1 &#39; &#39; 1
## 
## Residual standard error: 0.2698 on 5 degrees of freedom
## Multiple R-squared:  0.8088, Adjusted R-squared:  0.7706 
## F-statistic: 21.15 on 1 and 5 DF,  p-value: 0.005846</code></pre>
<div class="sourceCode" id="cb469"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb469-1"><a href="hierarchical-mixed-models.html#cb469-1" tabindex="-1"></a><span class="fu">confint</span>(fm1)</span></code></pre></div>
<pre><code>##                   2.5 %     97.5 %
## (Intercept) -0.86867531 0.12101544
## distance     0.01216371 0.04299419</code></pre>
<p>While the model has answered our primary question, this approach is clearly limited to models with only two treatments. If there had been three or more moth morphs, simply taking differences would not have worked so nicely.</p>
<p>An alternative approach that would work just as well for three or more groups is to use a random effect to capture the differences among the locations. In notation, we will fit the model
<span class="math display">\[
\mathrm{logit}(y_{ij} / n_{ij}) = a_i + b_i x_j + L_j + \varepsilon_{ij}
\]</span>
where <span class="math inline">\(L_j\sim \mathcal{N}(0, \sigma^2_L)\)</span> are location-level random effects, and <span class="math inline">\(\varepsilon_{ij}\sim \mathcal{N}(0, \sigma^2_\varepsilon)\)</span> are observation-level random effects. Here’s the fit.</p>
<div class="sourceCode" id="cb471"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb471-1"><a href="hierarchical-mixed-models.html#cb471-1" tabindex="-1"></a>moth <span class="ot">&lt;-</span> <span class="fu">read.table</span>(<span class="st">&quot;data/moth.txt&quot;</span>, <span class="at">head =</span> <span class="cn">TRUE</span>, <span class="at">stringsAsFactors =</span> <span class="cn">TRUE</span>)</span>
<span id="cb471-2"><a href="hierarchical-mixed-models.html#cb471-2" tabindex="-1"></a></span>
<span id="cb471-3"><a href="hierarchical-mixed-models.html#cb471-3" tabindex="-1"></a>moth<span class="sc">$</span>logit_removed <span class="ot">&lt;-</span> <span class="fu">with</span>(moth, <span class="fu">elogit</span>(removed <span class="sc">/</span> placed))</span>
<span id="cb471-4"><a href="hierarchical-mixed-models.html#cb471-4" tabindex="-1"></a></span>
<span id="cb471-5"><a href="hierarchical-mixed-models.html#cb471-5" tabindex="-1"></a>mm1 <span class="ot">&lt;-</span> lme4<span class="sc">::</span><span class="fu">lmer</span>(logit_removed <span class="sc">~</span> distance <span class="sc">*</span> morph <span class="sc">+</span> (<span class="dv">1</span> <span class="sc">|</span> location), <span class="at">data =</span> moth)</span>
<span id="cb471-6"><a href="hierarchical-mixed-models.html#cb471-6" tabindex="-1"></a><span class="fu">summary</span>(mm1)</span></code></pre></div>
<pre><code>## Linear mixed model fit by REML [&#39;lmerMod&#39;]
## Formula: logit_removed ~ distance * morph + (1 | location)
##    Data: moth
## 
## REML criterion at convergence: 22.6
## 
## Scaled residuals: 
##     Min      1Q  Median      3Q     Max 
## -1.2662 -0.5662  0.1830  0.4088  0.9045 
## 
## Random effects:
##  Groups   Name        Variance Std.Dev.
##  location (Intercept) 0.07639  0.2764  
##  Residual             0.03639  0.1907  
## Number of obs: 14, groups:  location, 7
## 
## Fixed effects:
##                      Estimate Std. Error t value
## (Intercept)         -1.123346   0.239648  -4.687
## distance             0.018190   0.007465   2.437
## morphlight           0.373830   0.192503   1.942
## distance:morphlight -0.027579   0.005997  -4.599
## 
## Correlation of Fixed Effects:
##             (Intr) distnc mrphlg
## distance    -0.848              
## morphlight  -0.402  0.341       
## dstnc:mrphl  0.341 -0.402 -0.848</code></pre>
<p>A visualization:</p>
<div class="sourceCode" id="cb473"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb473-1"><a href="hierarchical-mixed-models.html#cb473-1" tabindex="-1"></a><span class="fu">with</span>(moth, <span class="fu">plot</span>(logit_removed <span class="sc">~</span> distance, <span class="at">type =</span> <span class="st">&quot;n&quot;</span>))</span>
<span id="cb473-2"><a href="hierarchical-mixed-models.html#cb473-2" tabindex="-1"></a><span class="fu">with</span>(<span class="fu">subset</span>(moth, morph <span class="sc">==</span> <span class="st">&quot;dark&quot;</span>), <span class="fu">points</span>(logit_removed <span class="sc">~</span> distance, <span class="at">pch =</span> <span class="dv">16</span>))</span>
<span id="cb473-3"><a href="hierarchical-mixed-models.html#cb473-3" tabindex="-1"></a><span class="fu">with</span>(<span class="fu">subset</span>(moth, morph <span class="sc">==</span> <span class="st">&quot;light&quot;</span>), <span class="fu">points</span>(logit_removed <span class="sc">~</span> distance, <span class="at">pch =</span> <span class="dv">1</span>))</span>
<span id="cb473-4"><a href="hierarchical-mixed-models.html#cb473-4" tabindex="-1"></a></span>
<span id="cb473-5"><a href="hierarchical-mixed-models.html#cb473-5" tabindex="-1"></a><span class="fu">abline</span>(<span class="at">a =</span> <span class="sc">-</span><span class="fl">1.1233</span>, <span class="at">b =</span> <span class="fl">0.01819</span>) <span class="co"># dark fit</span></span>
<span id="cb473-6"><a href="hierarchical-mixed-models.html#cb473-6" tabindex="-1"></a><span class="fu">abline</span>(<span class="at">a =</span> <span class="sc">-</span><span class="fl">1.1233</span> <span class="sc">+</span> <span class="fl">0.3738</span>, <span class="at">b =</span> <span class="fl">0.01819</span> <span class="sc">-</span> <span class="fl">0.02758</span>, <span class="at">lty =</span> <span class="st">&quot;dashed&quot;</span>)  <span class="co"># light fit</span></span></code></pre></div>
<p><img src="06-HierarchicalModels_files/figure-html/unnamed-chunk-25-1.png" width="672" /></p>
<p>To test for the significance of the difference in slopes, we use <code>lmerTest::lmer</code>:</p>
<div class="sourceCode" id="cb474"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb474-1"><a href="hierarchical-mixed-models.html#cb474-1" tabindex="-1"></a>mm1a <span class="ot">&lt;-</span> lmerTest<span class="sc">::</span><span class="fu">lmer</span>(logit_removed <span class="sc">~</span> distance <span class="sc">*</span> morph <span class="sc">+</span> (<span class="dv">1</span> <span class="sc">|</span> location), <span class="at">data =</span> moth)</span>
<span id="cb474-2"><a href="hierarchical-mixed-models.html#cb474-2" tabindex="-1"></a><span class="fu">summary</span>(mm1a)</span></code></pre></div>
<pre><code>## Linear mixed model fit by REML. t-tests use Satterthwaite&#39;s method [
## lmerModLmerTest]
## Formula: logit_removed ~ distance * morph + (1 | location)
##    Data: moth
## 
## REML criterion at convergence: 22.6
## 
## Scaled residuals: 
##     Min      1Q  Median      3Q     Max 
## -1.2662 -0.5662  0.1830  0.4088  0.9045 
## 
## Random effects:
##  Groups   Name        Variance Std.Dev.
##  location (Intercept) 0.07639  0.2764  
##  Residual             0.03639  0.1907  
## Number of obs: 14, groups:  location, 7
## 
## Fixed effects:
##                      Estimate Std. Error        df t value Pr(&gt;|t|)   
## (Intercept)         -1.123346   0.239648  6.854778  -4.687  0.00237 **
## distance             0.018190   0.007465  6.854778   2.437  0.04571 * 
## morphlight           0.373830   0.192503  5.000000   1.942  0.10980   
## distance:morphlight -0.027579   0.005997  5.000000  -4.599  0.00585 **
## ---
## Signif. codes:  0 &#39;***&#39; 0.001 &#39;**&#39; 0.01 &#39;*&#39; 0.05 &#39;.&#39; 0.1 &#39; &#39; 1
## 
## Correlation of Fixed Effects:
##             (Intr) distnc mrphlg
## distance    -0.848              
## morphlight  -0.402  0.341       
## dstnc:mrphl  0.341 -0.402 -0.848</code></pre>
<p>In this simple case, the df for the <span class="math inline">\(t\)</span>-statistic associated with the difference in slopes is indisputable, and <code>lmerTest::lmer</code> returns the same <span class="math inline">\(p\)</span>-value as the paired analysis.</p>
<p>For what it’s worth, we can also extract conditional modes for the random effects of each of the locations:</p>
<div class="sourceCode" id="cb476"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb476-1"><a href="hierarchical-mixed-models.html#cb476-1" tabindex="-1"></a><span class="fu">ranef</span>(mm1)</span></code></pre></div>
<pre><code>## $location
##    (Intercept)
## cm  0.02991727
## ef  0.03709012
## ha  0.28858612
## ll  0.02644813
## lo -0.46001114
## pw  0.10062376
## sp -0.02265426
## 
## with conditional variances for &quot;location&quot;</code></pre>
</div>
<div id="random-coefficient-models-rikz-data" class="section level2 hasAnchor" number="6.3">
<h2><span class="header-section-number">6.3</span> Random coefficient models: RIKZ data<a href="hierarchical-mixed-models.html#random-coefficient-models-rikz-data" class="anchor-section" aria-label="Anchor link to header"></a></h2>
<p>Random-coefficient models are those in which the random-effect for each group applies not just to the overall mean response from that group (the “intercept”) but to a parameter that characterizes a particular feature of the data from that group, such as a regression slope. To illustrate random-coefficient models, we will consider the RIKZ data from <span class="citation">Zuur et al. (<a href="#ref-zuur2009">2009</a>)</span>. These data were first analyzed in an earlier textbook (<span class="citation">Zuur, Ieno, and Smith (<a href="#ref-zuur2007analysing">2007</a>)</span>). <span class="citation">Zuur et al. (<a href="#ref-zuur2009">2009</a>)</span> (p. 101) describe the data as follows:</p>
<blockquote>
<p>“<span class="citation">Zuur, Ieno, and Smith (<a href="#ref-zuur2007analysing">2007</a>)</span> used marine benthic data from nine inter-tidal areas along the Dutch coast. The data were collected by the Dutch institute RIKZ in the summer of 2002. In each inter-tidal area (denoted by ‘beach’), five samples were taken, and the macro-fauna and abiotic variables were measured. … The underlying question for these data is whether there is a relationship between species richness, exposure, and NAP (the height of a sampling station compared to mean tidal level). Exposure is an index composed of the following elements: wave action, length of the surf zone, slope, grain size, and the depth of the anaerobic layer.”</p>
</blockquote>
<p>That is, there are 9 beaches, and 5 samples from each beach. The response, measured at each sample, is the macrofaunal species richness. There are two covariates: NAP, which is a sample-level covariate, and exposure, which is a beach-level covariate. Because species richness is a count variable and includes the occasional zero (and because we have not yet discussed hierarchical models for non-Gaussian responses) we will use the square-root of richness as a variance-stabilizing transformation. Using the square root of species richness as the response has the added benefit of making our analysis different from the analysis in Zuur et al. (2009).</p>
<p>We are going to analyze these data exhaustively, considering various approaches for their analysis and comparing the pros and cons. In our first pass, we will ignore the exposure covariate, and seek only to model the relationship between species richness and NAP. Once that analysis is complete, we will circle back and consider how the analysis changes when we consider the beach-level covariate as well.</p>
<p>Like all data from <span class="citation">Zuur et al. (<a href="#ref-zuur2009">2009</a>)</span>, the data are available for download from the book’s associated webpage. We will read in the data and do some housekeeping first.</p>
<div class="sourceCode" id="cb478"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb478-1"><a href="hierarchical-mixed-models.html#cb478-1" tabindex="-1"></a><span class="fu">require</span>(lme4)</span>
<span id="cb478-2"><a href="hierarchical-mixed-models.html#cb478-2" tabindex="-1"></a><span class="fu">require</span>(lmerTest)</span>
<span id="cb478-3"><a href="hierarchical-mixed-models.html#cb478-3" tabindex="-1"></a></span>
<span id="cb478-4"><a href="hierarchical-mixed-models.html#cb478-4" tabindex="-1"></a>rikz <span class="ot">&lt;-</span> <span class="fu">read.table</span>(<span class="st">&quot;data/RIKZ.txt&quot;</span>, <span class="at">head =</span> T)</span>
<span id="cb478-5"><a href="hierarchical-mixed-models.html#cb478-5" tabindex="-1"></a></span>
<span id="cb478-6"><a href="hierarchical-mixed-models.html#cb478-6" tabindex="-1"></a><span class="fu">with</span>(rikz, <span class="fu">plot</span>(Richness <span class="sc">~</span> NAP, <span class="at">pch =</span> Beach))  <span class="co"># raw response; note the non-constant variance</span></span></code></pre></div>
<p><img src="06-HierarchicalModels_files/figure-html/unnamed-chunk-28-1.png" width="672" /></p>
<div class="sourceCode" id="cb479"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb479-1"><a href="hierarchical-mixed-models.html#cb479-1" tabindex="-1"></a><span class="fu">with</span>(rikz, <span class="fu">plot</span>(<span class="fu">sqrt</span>(Richness) <span class="sc">~</span> NAP, <span class="at">pch =</span> Beach))  <span class="co"># transformation stabilizes the variance</span></span>
<span id="cb479-2"><a href="hierarchical-mixed-models.html#cb479-2" tabindex="-1"></a><span class="fu">legend</span>(<span class="st">&quot;topright&quot;</span>, <span class="at">leg =</span> <span class="dv">1</span><span class="sc">:</span><span class="dv">9</span>, <span class="at">pch =</span> <span class="dv">1</span><span class="sc">:</span><span class="dv">9</span>)</span></code></pre></div>
<p><img src="06-HierarchicalModels_files/figure-html/unnamed-chunk-28-2.png" width="672" /></p>
<div class="sourceCode" id="cb480"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb480-1"><a href="hierarchical-mixed-models.html#cb480-1" tabindex="-1"></a><span class="co"># change the Beach variable to a factor</span></span>
<span id="cb480-2"><a href="hierarchical-mixed-models.html#cb480-2" tabindex="-1"></a><span class="co"># would have been better to code the beaches as b1, b2, ...</span></span>
<span id="cb480-3"><a href="hierarchical-mixed-models.html#cb480-3" tabindex="-1"></a></span>
<span id="cb480-4"><a href="hierarchical-mixed-models.html#cb480-4" tabindex="-1"></a>rikz<span class="sc">$</span>fBeach <span class="ot">&lt;-</span> <span class="fu">as.factor</span>(rikz<span class="sc">$</span>Beach)</span></code></pre></div>
<div id="analysis-without-beach-level-covariate" class="section level3 hasAnchor" number="6.3.1">
<h3><span class="header-section-number">6.3.1</span> Analysis without beach-level covariate<a href="hierarchical-mixed-models.html#analysis-without-beach-level-covariate" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<div id="using-fixed-effects-for-differences-among-beaches" class="section level4 hasAnchor" number="6.3.1.1">
<h4><span class="header-section-number">6.3.1.1</span> Using fixed effects for differences among beaches<a href="hierarchical-mixed-models.html#using-fixed-effects-for-differences-among-beaches" class="anchor-section" aria-label="Anchor link to header"></a></h4>
<p>To develop some notation for modeling, let <span class="math inline">\(i=1, \ldots, 9\)</span> index the beaches, let <span class="math inline">\(j = 1, \ldots, 5\)</span> index the samples at each beach, let <span class="math inline">\(y_{ij}\)</span> be the square root of the species richness at sample <span class="math inline">\(j\)</span> at beach <span class="math inline">\(i\)</span>, and let <span class="math inline">\(x_{ij}\)</span> be the NAP covariate at sample <span class="math inline">\(j\)</span> at beach <span class="math inline">\(i\)</span>.</p>
<p>In a standard linear models course, we would identify this as a two-factor design with a categorical factor (the beaches) and a numerical factor (NAP). Suppose we wish to characterize the relationship between NAP and (the square root of) species richness, while controlling for differences among the beaches. To do so, we might entertain the additive model
<span class="math display">\[\begin{equation}
y_{ij} \sim \mathcal{N}(a_i + b x_{ij}, \sigma_\varepsilon^2).
\end{equation}\]</span>
where <span class="math inline">\(a_i\)</span> is the intercept for beach <span class="math inline">\(i\)</span> and <span class="math inline">\(b\)</span> is the common slope that associates the NAP value with the response for all beaches. The error variance is the same for all observations.</p>
<p>Let’s fit the model and see what it yields.</p>
<div class="sourceCode" id="cb481"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb481-1"><a href="hierarchical-mixed-models.html#cb481-1" tabindex="-1"></a>fm0 <span class="ot">&lt;-</span> <span class="fu">lm</span>(<span class="fu">sqrt</span>(Richness) <span class="sc">~</span> fBeach <span class="sc">+</span> NAP, <span class="at">data =</span> rikz)</span>
<span id="cb481-2"><a href="hierarchical-mixed-models.html#cb481-2" tabindex="-1"></a><span class="fu">summary</span>(fm0)</span></code></pre></div>
<pre><code>## 
## Call:
## lm(formula = sqrt(Richness) ~ fBeach + NAP, data = rikz)
## 
## Residuals:
##      Min       1Q   Median       3Q      Max 
## -1.58544 -0.28653 -0.06544  0.23657  1.69043 
## 
## Coefficients:
##             Estimate Std. Error t value Pr(&gt;|t|)    
## (Intercept)  2.99457    0.26711  11.211 3.92e-13 ***
## fBeach2      0.61544    0.37909   1.623  0.11346    
## fBeach3     -1.21158    0.37491  -3.232  0.00268 ** 
## fBeach4     -1.13596    0.38510  -2.950  0.00564 ** 
## fBeach5     -0.32863    0.38648  -0.850  0.40093    
## fBeach6     -0.90219    0.37835  -2.385  0.02265 *  
## fBeach7     -0.98741    0.39419  -2.505  0.01705 *  
## fBeach8     -0.89080    0.38392  -2.320  0.02628 *  
## fBeach9     -0.79350    0.38561  -2.058  0.04712 *  
## NAP         -0.66410    0.09655  -6.878 5.49e-08 ***
## ---
## Signif. codes:  0 &#39;***&#39; 0.001 &#39;**&#39; 0.01 &#39;*&#39; 0.05 &#39;.&#39; 0.1 &#39; &#39; 1
## 
## Residual standard error: 0.5882 on 35 degrees of freedom
## Multiple R-squared:  0.7596, Adjusted R-squared:  0.6978 
## F-statistic: 12.29 on 9 and 35 DF,  p-value: 1.744e-08</code></pre>
<p>This analysis gives us an estimate for the common slope (-0.664) and a basis to draw inferences about this slope. For example, we can get a confidence interval in the usual way:</p>
<div class="sourceCode" id="cb483"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb483-1"><a href="hierarchical-mixed-models.html#cb483-1" tabindex="-1"></a><span class="fu">confint</span>(fm0, <span class="at">level =</span> <span class="fl">0.95</span>)</span></code></pre></div>
<pre><code>##                  2.5 %      97.5 %
## (Intercept)  2.4523092  3.53682298
## fBeach2     -0.1541506  1.38502150
## fBeach3     -1.9726894 -0.45047493
## fBeach4     -1.9177509 -0.35416521
## fBeach5     -1.1132200  0.45596483
## fBeach6     -1.6702860 -0.13408870
## fBeach7     -1.7876580 -0.18716421
## fBeach8     -1.6702073 -0.11139365
## fBeach9     -1.5763374 -0.01066776
## NAP         -0.8601180 -0.46808725</code></pre>
<p>We can also use the <code>anova</code> command to test for whether the differences among the beaches are statistically significant, after accounting for the effect of NAP. Note that such a test makes sense in this case, because we have used fixed-effects to capture the differences among the beaches, and thus can carry out inference about these 9 beaches specifically.</p>
<div class="sourceCode" id="cb485"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb485-1"><a href="hierarchical-mixed-models.html#cb485-1" tabindex="-1"></a><span class="fu">anova</span>(fm0)</span></code></pre></div>
<pre><code>## Analysis of Variance Table
## 
## Response: sqrt(Richness)
##           Df Sum Sq Mean Sq F value    Pr(&gt;F)    
## fBeach     8 21.900  2.7375  7.9109 5.119e-06 ***
## NAP        1 16.370 16.3701 47.3073 5.492e-08 ***
## Residuals 35 12.111  0.3460                      
## ---
## Signif. codes:  0 &#39;***&#39; 0.001 &#39;**&#39; 0.01 &#39;*&#39; 0.05 &#39;.&#39; 0.1 &#39; &#39; 1</code></pre>
<p>Finally, we can visualize the model by plotting each of the beach-specific fits. We’ll use the R trick of re-fitting the model without the intercept to obtain the beach-specific intercepts directly as model parameters, instead of having to compute those intercepts from the contrasts.</p>
<div class="sourceCode" id="cb487"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb487-1"><a href="hierarchical-mixed-models.html#cb487-1" tabindex="-1"></a>fm0.temp <span class="ot">&lt;-</span> <span class="fu">lm</span>(<span class="fu">sqrt</span>(Richness) <span class="sc">~</span> fBeach <span class="sc">+</span> NAP <span class="sc">-</span> <span class="dv">1</span>, <span class="at">data =</span> rikz)</span>
<span id="cb487-2"><a href="hierarchical-mixed-models.html#cb487-2" tabindex="-1"></a><span class="fu">coef</span>(fm0.temp)</span></code></pre></div>
<pre><code>##    fBeach1    fBeach2    fBeach3    fBeach4    fBeach5    fBeach6    fBeach7 
##  2.9945661  3.6100015  1.7829839  1.8586080  2.6659385  2.0923787  2.0071550 
##    fBeach8    fBeach9        NAP 
##  2.1037656  2.2010635 -0.6641026</code></pre>
<p>For later comparison, we’ll make a note of the intercept for beach 1, which in this case is 2.995.</p>
<p>Now we’ll proceed to make the plot.</p>
<div class="sourceCode" id="cb489"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb489-1"><a href="hierarchical-mixed-models.html#cb489-1" tabindex="-1"></a><span class="fu">with</span>(rikz, <span class="fu">plot</span>(<span class="fu">sqrt</span>(Richness) <span class="sc">~</span> NAP, <span class="at">pch =</span> Beach, <span class="at">main =</span> <span class="st">&quot;Fixed-effects fit, additive model&quot;</span>))</span>
<span id="cb489-2"><a href="hierarchical-mixed-models.html#cb489-2" tabindex="-1"></a><span class="fu">legend</span>(<span class="st">&quot;topright&quot;</span>, <span class="at">leg =</span> <span class="dv">1</span><span class="sc">:</span><span class="dv">9</span>, <span class="at">pch =</span> <span class="dv">1</span><span class="sc">:</span><span class="dv">9</span>)</span>
<span id="cb489-3"><a href="hierarchical-mixed-models.html#cb489-3" tabindex="-1"></a></span>
<span id="cb489-4"><a href="hierarchical-mixed-models.html#cb489-4" tabindex="-1"></a><span class="co"># add a line for each beach</span></span>
<span id="cb489-5"><a href="hierarchical-mixed-models.html#cb489-5" tabindex="-1"></a></span>
<span id="cb489-6"><a href="hierarchical-mixed-models.html#cb489-6" tabindex="-1"></a>b <span class="ot">&lt;-</span> <span class="fu">coef</span>(fm0)[<span class="st">&quot;NAP&quot;</span>]</span>
<span id="cb489-7"><a href="hierarchical-mixed-models.html#cb489-7" tabindex="-1"></a></span>
<span id="cb489-8"><a href="hierarchical-mixed-models.html#cb489-8" tabindex="-1"></a><span class="cf">for</span>(i <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span><span class="dv">9</span>){</span>
<span id="cb489-9"><a href="hierarchical-mixed-models.html#cb489-9" tabindex="-1"></a>  <span class="fu">abline</span>(<span class="at">a =</span> <span class="fu">coef</span>(fm0.temp)[i], <span class="at">b =</span> b, <span class="at">col =</span> <span class="st">&quot;red&quot;</span>, <span class="at">lty =</span> <span class="st">&quot;dotted&quot;</span>) </span>
<span id="cb489-10"><a href="hierarchical-mixed-models.html#cb489-10" tabindex="-1"></a>}</span></code></pre></div>
<p><img src="06-HierarchicalModels_files/figure-html/unnamed-chunk-33-1.png" width="672" /></p>
<p>Continuing with the fixed-effects analysis, we might also consider a model in which the relationship between NAP and species richness varies among beaches. In other words, we might fit a model with a beach-by-NAP interaction. This model is
<span class="math display">\[\begin{align*}
y_{ij} &amp; \sim \mathcal{N}(a_i + b_i x_{ij}, \sigma_\varepsilon^2).
\end{align*}\]</span></p>
<p>We fit this model in the usual way:</p>
<div class="sourceCode" id="cb490"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb490-1"><a href="hierarchical-mixed-models.html#cb490-1" tabindex="-1"></a>fm0b <span class="ot">&lt;-</span> <span class="fu">lm</span>(<span class="fu">sqrt</span>(Richness) <span class="sc">~</span> fBeach <span class="sc">*</span> NAP, <span class="at">data =</span> rikz)</span>
<span id="cb490-2"><a href="hierarchical-mixed-models.html#cb490-2" tabindex="-1"></a><span class="fu">summary</span>(fm0b)</span></code></pre></div>
<pre><code>## 
## Call:
## lm(formula = sqrt(Richness) ~ fBeach * NAP, data = rikz)
## 
## Residuals:
##      Min       1Q   Median       3Q      Max 
## -0.84831 -0.16080 -0.03091  0.14909  0.98737 
## 
## Coefficients:
##             Estimate Std. Error t value Pr(&gt;|t|)    
## (Intercept)  3.28835    0.24259  13.555 1.45e-13 ***
## fBeach2      0.30239    0.32158   0.940 0.355394    
## fBeach3     -1.50542    0.31542  -4.773 5.61e-05 ***
## fBeach4     -1.56073    0.33715  -4.629 8.25e-05 ***
## fBeach5      0.11078    0.35432   0.313 0.756947    
## fBeach6     -1.25466    0.31812  -3.944 0.000513 ***
## fBeach7     -1.39537    0.41116  -3.394 0.002144 ** 
## fBeach8     -1.17907    0.32697  -3.606 0.001242 ** 
## fBeach9     -0.85912    0.33879  -2.536 0.017314 *  
## NAP         -0.05077    0.28172  -0.180 0.858319    
## fBeach2:NAP -0.54313    0.36261  -1.498 0.145780    
## fBeach3:NAP -0.47943    0.37104  -1.292 0.207267    
## fBeach4:NAP -0.37552    0.35511  -1.057 0.299666    
## fBeach5:NAP -1.82561    0.38805  -4.705 6.74e-05 ***
## fBeach6:NAP -0.36229    0.33258  -1.089 0.285636    
## fBeach7:NAP -0.48212    0.41379  -1.165 0.254155    
## fBeach8:NAP -0.62429    0.32975  -1.893 0.069089 .  
## fBeach9:NAP -1.01278    0.35527  -2.851 0.008256 ** 
## ---
## Signif. codes:  0 &#39;***&#39; 0.001 &#39;**&#39; 0.01 &#39;*&#39; 0.05 &#39;.&#39; 0.1 &#39; &#39; 1
## 
## Residual standard error: 0.4508 on 27 degrees of freedom
## Multiple R-squared:  0.8911, Adjusted R-squared:  0.8225 
## F-statistic:    13 on 17 and 27 DF,  p-value: 7.079e-09</code></pre>
<p>We can test for whether the differences among the slopes for the beaches are statistically significant with the usual <span class="math inline">\(F\)</span>-test:</p>
<div class="sourceCode" id="cb492"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb492-1"><a href="hierarchical-mixed-models.html#cb492-1" tabindex="-1"></a><span class="fu">anova</span>(fm0, fm0b)</span></code></pre></div>
<pre><code>## Analysis of Variance Table
## 
## Model 1: sqrt(Richness) ~ fBeach + NAP
## Model 2: sqrt(Richness) ~ fBeach * NAP
##   Res.Df     RSS Df Sum of Sq      F   Pr(&gt;F)   
## 1     35 12.1113                                
## 2     27  5.4865  8    6.6248 4.0753 0.002742 **
## ---
## Signif. codes:  0 &#39;***&#39; 0.001 &#39;**&#39; 0.01 &#39;*&#39; 0.05 &#39;.&#39; 0.1 &#39; &#39; 1</code></pre>
<p>We’ll save the model of the beach-specific intercepts and slopes, and use them to visualize the fit. We’ll do the usual trick of refitting the model without the intercept to make it easy to extract the beach-level intercepts and slopes</p>
<div class="sourceCode" id="cb494"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb494-1"><a href="hierarchical-mixed-models.html#cb494-1" tabindex="-1"></a>fm0b.temp <span class="ot">&lt;-</span> <span class="fu">lm</span>(<span class="fu">sqrt</span>(Richness) <span class="sc">~</span> fBeach <span class="sc">+</span> fBeach<span class="sc">:</span>NAP <span class="sc">-</span> <span class="dv">1</span>, <span class="at">data =</span> rikz)</span>
<span id="cb494-2"><a href="hierarchical-mixed-models.html#cb494-2" tabindex="-1"></a>(fixed.params <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(<span class="at">beach     =</span> <span class="dv">1</span><span class="sc">:</span><span class="dv">9</span>,</span>
<span id="cb494-3"><a href="hierarchical-mixed-models.html#cb494-3" tabindex="-1"></a>                            <span class="at">intercept =</span> <span class="fu">coef</span>(fm0b.temp)[<span class="dv">1</span><span class="sc">:</span><span class="dv">9</span>], </span>
<span id="cb494-4"><a href="hierarchical-mixed-models.html#cb494-4" tabindex="-1"></a>                            <span class="at">slope     =</span> <span class="fu">coef</span>(fm0b.temp)[<span class="dv">10</span><span class="sc">:</span><span class="dv">18</span>]))</span></code></pre></div>
<pre><code>##         beach intercept       slope
## fBeach1     1  3.288351 -0.05077384
## fBeach2     2  3.590739 -0.59390495
## fBeach3     3  1.782930 -0.53019915
## fBeach4     4  1.727622 -0.42629196
## fBeach5     5  3.399128 -1.87638770
## fBeach6     6  2.033687 -0.41306694
## fBeach7     7  1.892979 -0.53289652
## fBeach8     8  2.109276 -0.67506643
## fBeach9     9  2.429231 -1.06355553</code></pre>
<div class="sourceCode" id="cb496"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb496-1"><a href="hierarchical-mixed-models.html#cb496-1" tabindex="-1"></a><span class="fu">row.names</span>(fixed.params) <span class="ot">&lt;-</span> <span class="cn">NULL</span></span>
<span id="cb496-2"><a href="hierarchical-mixed-models.html#cb496-2" tabindex="-1"></a></span>
<span id="cb496-3"><a href="hierarchical-mixed-models.html#cb496-3" tabindex="-1"></a><span class="fu">with</span>(rikz, <span class="fu">plot</span>(<span class="fu">sqrt</span>(Richness) <span class="sc">~</span> NAP, <span class="at">pch =</span> Beach, <span class="at">main =</span> <span class="st">&quot;Fixed-effects fit, with beach-NAP interaction&quot;</span>))</span>
<span id="cb496-4"><a href="hierarchical-mixed-models.html#cb496-4" tabindex="-1"></a><span class="fu">legend</span>(<span class="st">&quot;topright&quot;</span>, <span class="at">leg =</span> <span class="dv">1</span><span class="sc">:</span><span class="dv">9</span>, <span class="at">pch =</span> <span class="dv">1</span><span class="sc">:</span><span class="dv">9</span>)</span>
<span id="cb496-5"><a href="hierarchical-mixed-models.html#cb496-5" tabindex="-1"></a></span>
<span id="cb496-6"><a href="hierarchical-mixed-models.html#cb496-6" tabindex="-1"></a><span class="cf">for</span>(i <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span><span class="dv">9</span>){</span>
<span id="cb496-7"><a href="hierarchical-mixed-models.html#cb496-7" tabindex="-1"></a>  <span class="fu">abline</span>(<span class="at">a =</span> fixed.params<span class="sc">$</span>intercept[i], <span class="at">b =</span> fixed.params<span class="sc">$</span>slope[i], </span>
<span id="cb496-8"><a href="hierarchical-mixed-models.html#cb496-8" tabindex="-1"></a>         <span class="at">col =</span> <span class="st">&quot;red&quot;</span>, <span class="at">lty =</span> <span class="st">&quot;dotted&quot;</span>) </span>
<span id="cb496-9"><a href="hierarchical-mixed-models.html#cb496-9" tabindex="-1"></a>}</span></code></pre></div>
<p><img src="06-HierarchicalModels_files/figure-html/unnamed-chunk-37-1.png" width="672" /></p>
</div>
<div id="using-random-effects-for-differences-among-beaches" class="section level4 hasAnchor" number="6.3.1.2">
<h4><span class="header-section-number">6.3.1.2</span> Using random-effects for differences among beaches<a href="hierarchical-mixed-models.html#using-random-effects-for-differences-among-beaches" class="anchor-section" aria-label="Anchor link to header"></a></h4>
<p>Now let’s use random effects to capture the differences among beaches. A random effect is appropriate if we want to treat these beaches as a representative sample from a larger collection of beaches, and draw inferences about this larger collection. We’ll start with the additive model again, so that the random beach effect only affects the intercept.</p>
<p>Before we fit the model, it’s worth taking a moment to compare two different styles of writing the model. We could write the model as
<span class="math display">\[\begin{align*}
y_{ij} &amp; \sim \mathcal{N}(A_i + b x_{ij}, \sigma_\varepsilon^2)  \\
A_i &amp; \stackrel{\text{iid}}{\sim} \mathcal{N}(a, \sigma_a^2).
\end{align*}\]</span>
Here, <span class="math inline">\(A_i\)</span> is the intercept for beach <span class="math inline">\(i\)</span>, and these beach-specific intercepts are assumed to be drawn from a distribution of beach-specific intercepts with mean <span class="math inline">\(a\)</span> and variance <span class="math inline">\(\sigma_a^2\)</span>.</p>
<p>Alternatively, the same model can be written as
<span class="math display">\[\begin{align*}
y_{ij} &amp; \sim \mathcal{N}(a + A_i + b x_{ij}, \sigma_\varepsilon^2)  \\
A_i &amp; \stackrel{\text{iid}}{\sim} \mathcal{N}(0, \sigma_a^2).
\end{align*}\]</span>
In this second style, <span class="math inline">\(A_i\)</span> is the offset for beach <span class="math inline">\(i\)</span> that tells how the intercept for beach <span class="math inline">\(i\)</span> differs from the mean intercept, <span class="math inline">\(a\)</span>. These beach-level offsets are assumed to be drawn from a distribution of beach-specific offsets with mean <span class="math inline">\(0\)</span> and variance <span class="math inline">\(\sigma_a^2\)</span>.</p>
<p>I find the first style of writing the model a bit cleaner, and will use it here and below. The first style of writing is also closer to the logic of hierarchical models and the associated Bayesian formulation. The second style of writing the model is closer to the model syntax in <code>lme4</code>, which typically represents all random effects as being drawn from normal distributions with mean <span class="math inline">\(0\)</span>. Regardless, the model is the same regardless of which style is used to write it.</p>
<p>We’ll fit the model using <code>lmerTest::lmer</code>.</p>
<div class="sourceCode" id="cb497"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb497-1"><a href="hierarchical-mixed-models.html#cb497-1" tabindex="-1"></a>fm1 <span class="ot">&lt;-</span> lmerTest<span class="sc">::</span><span class="fu">lmer</span>(<span class="fu">sqrt</span>(Richness) <span class="sc">~</span> <span class="dv">1</span> <span class="sc">+</span> NAP <span class="sc">+</span> (<span class="dv">1</span> <span class="sc">|</span> fBeach), <span class="at">data =</span> rikz)</span>
<span id="cb497-2"><a href="hierarchical-mixed-models.html#cb497-2" tabindex="-1"></a></span>
<span id="cb497-3"><a href="hierarchical-mixed-models.html#cb497-3" tabindex="-1"></a><span class="fu">summary</span>(fm1)</span></code></pre></div>
<pre><code>## Linear mixed model fit by REML. t-tests use Satterthwaite&#39;s method [
## lmerModLmerTest]
## Formula: sqrt(Richness) ~ 1 + NAP + (1 | fBeach)
##    Data: rikz
## 
## REML criterion at convergence: 97.1
## 
## Scaled residuals: 
##     Min      1Q  Median      3Q     Max 
## -2.5693 -0.4286 -0.1869  0.3230  2.9399 
## 
## Random effects:
##  Groups   Name        Variance Std.Dev.
##  fBeach   (Intercept) 0.2957   0.5438  
##  Residual             0.3460   0.5882  
## Number of obs: 45, groups:  fBeach, 9
## 
## Fixed effects:
##             Estimate Std. Error       df t value Pr(&gt;|t|)    
## (Intercept)  2.37424    0.20405  8.36034  11.635 1.88e-06 ***
## NAP         -0.68063    0.09501 37.15971  -7.163 1.68e-08 ***
## ---
## Signif. codes:  0 &#39;***&#39; 0.001 &#39;**&#39; 0.01 &#39;*&#39; 0.05 &#39;.&#39; 0.1 &#39; &#39; 1
## 
## Correlation of Fixed Effects:
##     (Intr)
## NAP -0.162</code></pre>
<p>We can go further by finding the conditional modes of the intercepts for each beach.</p>
<div class="sourceCode" id="cb499"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb499-1"><a href="hierarchical-mixed-models.html#cb499-1" tabindex="-1"></a>(beach.conditional.modes <span class="ot">&lt;-</span> (<span class="fu">fixef</span>(fm1)[<span class="st">&quot;(Intercept)&quot;</span>] <span class="sc">+</span> <span class="fu">ranef</span>(fm1)<span class="sc">$</span>fBeach<span class="sc">$</span><span class="st">`</span><span class="at">(Intercept)</span><span class="st">`</span>))</span></code></pre></div>
<pre><code>## [1] 2.870511 3.379324 1.895117 1.963771 2.618721 2.148964 2.088426 2.161791
## [9] 2.241556</code></pre>
<p>The conditional mode for the intercept for beach 1 is 2.871, which is shrunken back towards the average intercept, compared to the intercept for this beach in the fixed-effects model.</p>
<p>To visualize the model, we will again make a plot that shows the conditional modes of the fit for each beach. We can also add a line for the average relationship across the population of beaches.</p>
<div class="sourceCode" id="cb501"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb501-1"><a href="hierarchical-mixed-models.html#cb501-1" tabindex="-1"></a><span class="fu">with</span>(rikz, <span class="fu">plot</span>(<span class="fu">sqrt</span>(Richness) <span class="sc">~</span> NAP, <span class="at">pch =</span> Beach, <span class="at">main =</span> <span class="st">&quot;Random intercepts fit&quot;</span>))</span>
<span id="cb501-2"><a href="hierarchical-mixed-models.html#cb501-2" tabindex="-1"></a><span class="fu">legend</span>(<span class="st">&quot;topright&quot;</span>, <span class="at">leg =</span> <span class="dv">1</span><span class="sc">:</span><span class="dv">9</span>, <span class="at">pch =</span> <span class="dv">1</span><span class="sc">:</span><span class="dv">9</span>)</span>
<span id="cb501-3"><a href="hierarchical-mixed-models.html#cb501-3" tabindex="-1"></a></span>
<span id="cb501-4"><a href="hierarchical-mixed-models.html#cb501-4" tabindex="-1"></a>a <span class="ot">&lt;-</span> <span class="fu">coef</span>(<span class="fu">summary</span>(fm1))[<span class="dv">1</span>, <span class="dv">1</span>]</span>
<span id="cb501-5"><a href="hierarchical-mixed-models.html#cb501-5" tabindex="-1"></a>b <span class="ot">&lt;-</span> <span class="fu">coef</span>(<span class="fu">summary</span>(fm1))[<span class="dv">2</span>, <span class="dv">1</span>]</span>
<span id="cb501-6"><a href="hierarchical-mixed-models.html#cb501-6" tabindex="-1"></a></span>
<span id="cb501-7"><a href="hierarchical-mixed-models.html#cb501-7" tabindex="-1"></a><span class="fu">abline</span>(<span class="at">a =</span> a, <span class="at">b =</span> b, <span class="at">col =</span> <span class="st">&quot;red&quot;</span>, <span class="at">lwd =</span> <span class="dv">2</span>)</span>
<span id="cb501-8"><a href="hierarchical-mixed-models.html#cb501-8" tabindex="-1"></a></span>
<span id="cb501-9"><a href="hierarchical-mixed-models.html#cb501-9" tabindex="-1"></a><span class="co"># make a plot with a line for each beach</span></span>
<span id="cb501-10"><a href="hierarchical-mixed-models.html#cb501-10" tabindex="-1"></a></span>
<span id="cb501-11"><a href="hierarchical-mixed-models.html#cb501-11" tabindex="-1"></a><span class="cf">for</span>(i <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span><span class="dv">9</span>){</span>
<span id="cb501-12"><a href="hierarchical-mixed-models.html#cb501-12" tabindex="-1"></a> <span class="fu">abline</span>(<span class="at">a =</span> beach.conditional.modes[i], <span class="at">b =</span> b, <span class="at">col =</span> <span class="st">&quot;red&quot;</span>, <span class="at">lty =</span> <span class="st">&quot;dotted&quot;</span>) </span>
<span id="cb501-13"><a href="hierarchical-mixed-models.html#cb501-13" tabindex="-1"></a>}</span></code></pre></div>
<p><img src="06-HierarchicalModels_files/figure-html/unnamed-chunk-41-1.png" width="672" /></p>
<p>Though it’s subtle, notice again that the implied fits for each beach have been shrunken back to the overall mean.</p>
<p>Now let’s consider a model that includes separate intercepts and slopes for each beach, while continuing to model the differences among beaches in both with random effects. In other words, we’ll fit a “random coefficients” model with random intercepts and slopes for each beach. We have two options here. Either we can allow for the random intercept and slope for each beach to be a draw from a bivariate normal distribution with possible correlations, or we can treat the random intercepts and slopes as independent. To write the first model in mixed-model notation, we might write
<span class="math display">\[\begin{align*}
y_{ij} &amp; \sim \mathcal{N}(A_i + B_i x_{ij}, \sigma_\varepsilon^2) \\
\left(\begin{array}{c} A \\ B \end{array} \right)_i &amp; \stackrel{\text{iid}}{\sim} \mathcal{N}_2 \left(\left(\begin{array}{c} a \\ b \end{array} \right), \left(\begin{array}{cc} \sigma_A^2 &amp; \sigma_{AB} \\ \sigma_{AB} &amp; \sigma_B^2 \end{array} \right) \right).
\end{align*}\]</span>
Here the <span class="math inline">\(B_i\)</span> gives the slope for beach <span class="math inline">\(i\)</span>, and the pair <span class="math inline">\((A, B)_i\)</span> is drawn from a bivarate Gaussian distribution with mean <span class="math inline">\((a,b)\)</span>.</p>
<p>To fit the model using <code>lmerTest::lmer</code>, we use</p>
<div class="sourceCode" id="cb502"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb502-1"><a href="hierarchical-mixed-models.html#cb502-1" tabindex="-1"></a>fm2 <span class="ot">&lt;-</span> lmerTest<span class="sc">::</span><span class="fu">lmer</span>(<span class="fu">sqrt</span>(Richness) <span class="sc">~</span> <span class="dv">1</span> <span class="sc">+</span> NAP <span class="sc">+</span> (<span class="dv">1</span> <span class="sc">+</span> NAP <span class="sc">|</span> fBeach), <span class="at">data =</span> rikz)  </span>
<span id="cb502-2"><a href="hierarchical-mixed-models.html#cb502-2" tabindex="-1"></a><span class="fu">summary</span>(fm2)</span></code></pre></div>
<pre><code>## Linear mixed model fit by REML. t-tests use Satterthwaite&#39;s method [
## lmerModLmerTest]
## Formula: sqrt(Richness) ~ 1 + NAP + (1 + NAP | fBeach)
##    Data: rikz
## 
## REML criterion at convergence: 92.5
## 
## Scaled residuals: 
##     Min      1Q  Median      3Q     Max 
## -1.6245 -0.4430 -0.1095  0.3023  2.1610 
## 
## Random effects:
##  Groups   Name        Variance Std.Dev. Corr 
##  fBeach   (Intercept) 0.4389   0.6625        
##           NAP         0.1582   0.3978   -0.41
##  Residual             0.2159   0.4647        
## Number of obs: 45, groups:  fBeach, 9
## 
## Fixed effects:
##             Estimate Std. Error      df t value Pr(&gt;|t|)    
## (Intercept)   2.4369     0.2348  7.9127  10.379 6.97e-06 ***
## NAP          -0.7026     0.1543  6.7971  -4.552  0.00283 ** 
## ---
## Signif. codes:  0 &#39;***&#39; 0.001 &#39;**&#39; 0.01 &#39;*&#39; 0.05 &#39;.&#39; 0.1 &#39; &#39; 1
## 
## Correlation of Fixed Effects:
##     (Intr)
## NAP -0.390</code></pre>
<p>Because this model nests the random-intercept model, we can compare the two directly with a LRT:</p>
<div class="sourceCode" id="cb504"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb504-1"><a href="hierarchical-mixed-models.html#cb504-1" tabindex="-1"></a><span class="fu">anova</span>(fm1, fm2)</span></code></pre></div>
<pre><code>## refitting model(s) with ML (instead of REML)</code></pre>
<pre><code>## Data: rikz
## Models:
## fm1: sqrt(Richness) ~ 1 + NAP + (1 | fBeach)
## fm2: sqrt(Richness) ~ 1 + NAP + (1 + NAP | fBeach)
##     npar    AIC    BIC  logLik -2*log(L)  Chisq Df Pr(&gt;Chisq)
## fm1    4 100.83 108.06 -46.416    92.833                     
## fm2    6 101.26 112.10 -44.630    89.259 3.5736  2     0.1675</code></pre>
<p>Interestingly, both the LRT and ANOVA suggest that the random-coefficients model does not provide a statistically significant improvement over the random-intercepts model. In other words, we cannot reject the null hypothesis that <span class="math inline">\(\sigma_B^2 = 0\)</span>.</p>
<p>Alternatively, we could try a model with independent random intercepts and slopes. This model is
<span class="math display">\[\begin{align*}
y_{ij} &amp; \sim \mathcal{N}(A_i + B_i x_{ij}, \sigma_\varepsilon^2) \\
A_i &amp; \stackrel{\text{iid}}{\sim} \mathcal{N}(a, \sigma^2_A) \\
B_i &amp; \stackrel{\text{iid}}{\sim} \mathcal{N}(b, \sigma^2_B).
\end{align*}\]</span></p>
<p>To fit it in R, we use</p>
<div class="sourceCode" id="cb507"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb507-1"><a href="hierarchical-mixed-models.html#cb507-1" tabindex="-1"></a>fm3 <span class="ot">&lt;-</span> lmerTest<span class="sc">::</span><span class="fu">lmer</span>(<span class="fu">sqrt</span>(Richness) <span class="sc">~</span> <span class="dv">1</span> <span class="sc">+</span> NAP <span class="sc">+</span> (<span class="dv">1</span> <span class="sc">|</span> fBeach) <span class="sc">+</span> (<span class="dv">0</span> <span class="sc">+</span> NAP <span class="sc">|</span> fBeach), <span class="at">data =</span> rikz)</span>
<span id="cb507-2"><a href="hierarchical-mixed-models.html#cb507-2" tabindex="-1"></a><span class="fu">summary</span>(fm3)</span></code></pre></div>
<pre><code>## Linear mixed model fit by REML. t-tests use Satterthwaite&#39;s method [
## lmerModLmerTest]
## Formula: sqrt(Richness) ~ 1 + NAP + (1 | fBeach) + (0 + NAP | fBeach)
##    Data: rikz
## 
## REML criterion at convergence: 93.4
## 
## Scaled residuals: 
##     Min      1Q  Median      3Q     Max 
## -1.5841 -0.4070 -0.1042  0.2804  2.2006 
## 
## Random effects:
##  Groups   Name        Variance Std.Dev.
##  fBeach   (Intercept) 0.4247   0.6517  
##  fBeach.1 NAP         0.1489   0.3858  
##  Residual             0.2168   0.4657  
## Number of obs: 45, groups:  fBeach, 9
## 
## Fixed effects:
##             Estimate Std. Error      df t value Pr(&gt;|t|)    
## (Intercept)   2.4413     0.2314  7.8858  10.552 6.32e-06 ***
## NAP          -0.6912     0.1510  6.6684  -4.576  0.00289 ** 
## ---
## Signif. codes:  0 &#39;***&#39; 0.001 &#39;**&#39; 0.01 &#39;*&#39; 0.05 &#39;.&#39; 0.1 &#39; &#39; 1
## 
## Correlation of Fixed Effects:
##     (Intr)
## NAP -0.061</code></pre>
<p>Because each of these random-effect models are nested within one another, we can compare them directly with LRTs:</p>
<div class="sourceCode" id="cb509"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb509-1"><a href="hierarchical-mixed-models.html#cb509-1" tabindex="-1"></a><span class="fu">anova</span>(fm1, fm3, fm2)</span></code></pre></div>
<pre><code>## refitting model(s) with ML (instead of REML)</code></pre>
<pre><code>## Data: rikz
## Models:
## fm1: sqrt(Richness) ~ 1 + NAP + (1 | fBeach)
## fm3: sqrt(Richness) ~ 1 + NAP + (1 | fBeach) + (0 + NAP | fBeach)
## fm2: sqrt(Richness) ~ 1 + NAP + (1 + NAP | fBeach)
##     npar    AIC    BIC  logLik -2*log(L)  Chisq Df Pr(&gt;Chisq)
## fm1    4 100.83 108.06 -46.416    92.833                     
## fm3    5 100.16 109.19 -45.078    90.156 2.6767  1     0.1018
## fm2    6 101.26 112.10 -44.630    89.259 0.8969  1     0.3436</code></pre>
<p>Here we see a conflict between AIC and the LRT. AIC favors the model with random but independent intercepts and slopes, whereas the LRT continues to suggest that we cannot reject the null hypothesis that <span class="math inline">\(\sigma_B^2 = 0\)</span>.</p>
<p>Finally, let’s compare the conditional modes for the intercepts and slopes from model <code>fm3</code> with the beach-specific intercept and slopes from the fixed-effects model.</p>
<div class="sourceCode" id="cb512"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb512-1"><a href="hierarchical-mixed-models.html#cb512-1" tabindex="-1"></a>(conditional.modes  <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(<span class="at">beach     =</span> <span class="dv">1</span><span class="sc">:</span><span class="dv">9</span>,</span>
<span id="cb512-2"><a href="hierarchical-mixed-models.html#cb512-2" tabindex="-1"></a>                                  <span class="at">intercept =</span> <span class="fu">fixef</span>(fm3)[<span class="st">&quot;(Intercept)&quot;</span>] <span class="sc">+</span> <span class="fu">ranef</span>(fm3)<span class="sc">$</span>fBeach<span class="sc">$</span><span class="st">`</span><span class="at">(Intercept)</span><span class="st">`</span>, </span>
<span id="cb512-3"><a href="hierarchical-mixed-models.html#cb512-3" tabindex="-1"></a>                                  <span class="at">slope     =</span> <span class="fu">fixef</span>(fm3)[<span class="st">&quot;NAP&quot;</span>] <span class="sc">+</span> <span class="fu">ranef</span>(fm3)<span class="sc">$</span>fBeach<span class="sc">$</span><span class="st">`</span><span class="at">NAP</span><span class="st">`</span>))</span></code></pre></div>
<pre><code>##   beach intercept      slope
## 1     1  3.091736 -0.3225870
## 2     2  3.484038 -0.5930830
## 3     3  1.843949 -0.5776709
## 4     4  1.841492 -0.5218237
## 5     5  3.066017 -1.4310799
## 6     6  2.083390 -0.4693246
## 7     7  2.032495 -0.6452486
## 8     8  2.145453 -0.6869329
## 9     9  2.383348 -0.9728640</code></pre>
<p>Let’s make a scatterplot that compares the fixed-effect estimates to the conditional modes.</p>
<div class="sourceCode" id="cb514"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb514-1"><a href="hierarchical-mixed-models.html#cb514-1" tabindex="-1"></a><span class="fu">par</span>(<span class="at">mfrow =</span> <span class="fu">c</span>(<span class="dv">1</span>, <span class="dv">2</span>))</span>
<span id="cb514-2"><a href="hierarchical-mixed-models.html#cb514-2" tabindex="-1"></a><span class="fu">with</span>(fixed.params, <span class="fu">plot</span>(slope <span class="sc">~</span> intercept, <span class="at">main =</span> <span class="st">&quot;fixed-effects fit&quot;</span>, <span class="at">pch =</span> <span class="dv">1</span><span class="sc">:</span><span class="dv">9</span>))</span>
<span id="cb514-3"><a href="hierarchical-mixed-models.html#cb514-3" tabindex="-1"></a><span class="fu">with</span>(fixed.params, <span class="fu">plot</span>(slope <span class="sc">~</span> intercept, <span class="at">main =</span> <span class="st">&quot;conditional modes&quot;</span>, <span class="at">type =</span> <span class="st">&quot;n&quot;</span>))</span>
<span id="cb514-4"><a href="hierarchical-mixed-models.html#cb514-4" tabindex="-1"></a><span class="fu">with</span>(conditional.modes, <span class="fu">points</span>(slope <span class="sc">~</span> intercept, <span class="at">pch =</span> <span class="dv">1</span><span class="sc">:</span><span class="dv">9</span>))</span>
<span id="cb514-5"><a href="hierarchical-mixed-models.html#cb514-5" tabindex="-1"></a><span class="fu">points</span>(<span class="fu">fixef</span>(fm3)[<span class="dv">1</span>], <span class="fu">fixef</span>(fm3)[<span class="dv">2</span>], <span class="at">pch =</span> <span class="dv">16</span>, <span class="at">col =</span> <span class="st">&quot;red&quot;</span>, <span class="at">cex =</span> <span class="dv">2</span>)</span></code></pre></div>
<p><img src="06-HierarchicalModels_files/figure-html/unnamed-chunk-47-1.png" width="672" /></p>
<p>Note, again, that the conditional modes of the intercepts and slopes have shrunk (sometimes substantially) back towards the population means of each. The population means of the intercept and slope are shown by the red dot on the right-hand panel. Finally, we visualize the model by plotting beach-specific “fits”:</p>
<div class="sourceCode" id="cb515"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb515-1"><a href="hierarchical-mixed-models.html#cb515-1" tabindex="-1"></a><span class="fu">par</span>(<span class="at">mfrow =</span> <span class="fu">c</span>(<span class="dv">1</span>, <span class="dv">1</span>))</span>
<span id="cb515-2"><a href="hierarchical-mixed-models.html#cb515-2" tabindex="-1"></a><span class="fu">with</span>(rikz, <span class="fu">plot</span>(<span class="fu">sqrt</span>(Richness) <span class="sc">~</span> NAP, <span class="at">pch =</span> Beach, <span class="at">main =</span> <span class="st">&quot;Random-coefficients fit&quot;</span>))</span>
<span id="cb515-3"><a href="hierarchical-mixed-models.html#cb515-3" tabindex="-1"></a><span class="fu">legend</span>(<span class="st">&quot;topright&quot;</span>, <span class="at">leg =</span> <span class="dv">1</span><span class="sc">:</span><span class="dv">9</span>, <span class="at">pch =</span> <span class="dv">1</span><span class="sc">:</span><span class="dv">9</span>)</span>
<span id="cb515-4"><a href="hierarchical-mixed-models.html#cb515-4" tabindex="-1"></a></span>
<span id="cb515-5"><a href="hierarchical-mixed-models.html#cb515-5" tabindex="-1"></a><span class="cf">for</span>(i <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span><span class="dv">9</span>){</span>
<span id="cb515-6"><a href="hierarchical-mixed-models.html#cb515-6" tabindex="-1"></a>  <span class="fu">abline</span>(<span class="at">a =</span> conditional.modes<span class="sc">$</span>intercept[i], <span class="at">b =</span> conditional.modes<span class="sc">$</span>slope[i], </span>
<span id="cb515-7"><a href="hierarchical-mixed-models.html#cb515-7" tabindex="-1"></a>         <span class="at">col =</span> <span class="st">&quot;red&quot;</span>, <span class="at">lty =</span> <span class="st">&quot;dotted&quot;</span>) </span>
<span id="cb515-8"><a href="hierarchical-mixed-models.html#cb515-8" tabindex="-1"></a>}</span>
<span id="cb515-9"><a href="hierarchical-mixed-models.html#cb515-9" tabindex="-1"></a></span>
<span id="cb515-10"><a href="hierarchical-mixed-models.html#cb515-10" tabindex="-1"></a><span class="fu">abline</span>(<span class="at">a =</span> <span class="fu">fixef</span>(fm3)[<span class="dv">1</span>], <span class="at">b =</span> <span class="fu">fixef</span>(fm3)[<span class="dv">2</span>], <span class="at">col =</span> <span class="st">&quot;red&quot;</span>, <span class="at">lwd =</span> <span class="dv">2</span>)</span></code></pre></div>
<p><img src="06-HierarchicalModels_files/figure-html/unnamed-chunk-48-1.png" width="672" /></p>
</div>
</div>
<div id="adding-a-beach-level-covariate" class="section level3 hasAnchor" number="6.3.2">
<h3><span class="header-section-number">6.3.2</span> Adding a beach-level covariate<a href="hierarchical-mixed-models.html#adding-a-beach-level-covariate" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<p>Now consider the effect of exposure, a beach-level covariate. Exposure is coded in the data set as a numerical predictor. However, there are only three unique values: 8, 10, and 11 (and only one beach has exposure level 8). We will follow Zuur et al. (2009) in treating exposure as a binary predictor, grouping the beaches with exposure levels 8 and 10 together as low exposure beaches.</p>
<div class="sourceCode" id="cb516"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb516-1"><a href="hierarchical-mixed-models.html#cb516-1" tabindex="-1"></a><span class="co"># create an &#39;exposure&#39; factor, with two levels: low and high</span></span>
<span id="cb516-2"><a href="hierarchical-mixed-models.html#cb516-2" tabindex="-1"></a></span>
<span id="cb516-3"><a href="hierarchical-mixed-models.html#cb516-3" tabindex="-1"></a><span class="fu">with</span>(rikz, <span class="fu">table</span>(fBeach, Exposure))</span></code></pre></div>
<pre><code>##       Exposure
## fBeach 8 10 11
##      1 0  5  0
##      2 5  0  0
##      3 0  0  5
##      4 0  0  5
##      5 0  5  0
##      6 0  0  5
##      7 0  0  5
##      8 0  5  0
##      9 0  5  0</code></pre>
<div class="sourceCode" id="cb518"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb518-1"><a href="hierarchical-mixed-models.html#cb518-1" tabindex="-1"></a>rikz<span class="sc">$</span>fExp <span class="ot">&lt;-</span> rikz<span class="sc">$</span>Exposure  <span class="co"># make a new variable so that we can leave the original alone</span></span>
<span id="cb518-2"><a href="hierarchical-mixed-models.html#cb518-2" tabindex="-1"></a>rikz<span class="sc">$</span>fExp[rikz<span class="sc">$</span>Exposure <span class="sc">==</span> <span class="dv">8</span>] <span class="ot">&lt;-</span> <span class="dv">10</span>  <span class="co"># assign a value of 10 to the lone beach with exposure = 8</span></span>
<span id="cb518-3"><a href="hierarchical-mixed-models.html#cb518-3" tabindex="-1"></a>rikz<span class="sc">$</span>fExp <span class="ot">&lt;-</span> <span class="fu">as.factor</span>(rikz<span class="sc">$</span>fExp)  <span class="co"># make the new variable into a factor</span></span>
<span id="cb518-4"><a href="hierarchical-mixed-models.html#cb518-4" tabindex="-1"></a></span>
<span id="cb518-5"><a href="hierarchical-mixed-models.html#cb518-5" tabindex="-1"></a><span class="fu">summary</span>(rikz)</span></code></pre></div>
<pre><code>##      Sample      Richness         Exposure          NAP              Beach  
##  Min.   : 1   Min.   : 0.000   Min.   : 8.00   Min.   :-1.3360   Min.   :1  
##  1st Qu.:12   1st Qu.: 3.000   1st Qu.:10.00   1st Qu.:-0.3750   1st Qu.:3  
##  Median :23   Median : 4.000   Median :10.00   Median : 0.1670   Median :5  
##  Mean   :23   Mean   : 5.689   Mean   :10.22   Mean   : 0.3477   Mean   :5  
##  3rd Qu.:34   3rd Qu.: 8.000   3rd Qu.:11.00   3rd Qu.: 1.1170   3rd Qu.:7  
##  Max.   :45   Max.   :22.000   Max.   :11.00   Max.   : 2.2550   Max.   :9  
##                                                                             
##      fBeach   fExp   
##  1      : 5   10:25  
##  2      : 5   11:20  
##  3      : 5          
##  4      : 5          
##  5      : 5          
##  6      : 5          
##  (Other):15</code></pre>
<p>We will consider a model in which we use separate distributions of random intercepts for the the low- and high-exposure beaches. To fit this model, we will need to embellish our notation. Now, let <span class="math inline">\(i=1, 2\)</span> index the exposure level of the beaches. Let <span class="math inline">\(j=1,\ldots, n_i\)</span> index the replicate beaches within each exposure level. Let <span class="math inline">\(k=1, \ldots, 5\)</span> index the samples at each beach.</p>
<p>Here we see an interesting consequence of our decision to model the differences among the beaches with either a fixed or random effect. <strong>To draw inferences about the effect of low vs. high exposure, we must use a random effect for the differences among beaches.</strong> This makes sense when we reflect upon it. In order to draw inferences about low vs. high exposure, we have to envision separate populations of low- and high-exposure beaches, and regard the beaches in this experiment as two separate random samples from those populations. If instead we treat the differences among beaches with fixed effects, then we are effectively saying that these are the only low- and high-exposure beaches that we care about. Therefore, in the fixed-effects formulation, these nine beaches are our two populations, and there are no inferences to draw.</p>
<p>As above, we will consider a series of three models with various specifications of the random effect. We will consider:</p>
<ul>
<li>A model with random intercepts for the beaches but common slopes within each exposure group</li>
<li>A model with independent random intercepts and slopes for beaches within each exposure group.</li>
<li>A model with random intercepts and slopes for beaches within each exposure group, and potential correlations between them</li>
</ul>
<p>Initially, we fit a model with richly specified fixed effects. In this case, this will mean that the average slope and intercept will vary between the exposure groups.</p>
<p>These models can be written and fit as follows. The random-intercepts model is
<span class="math display">\[\begin{align*}
y_{ijk} &amp; \sim \mathcal{N}(A_{ij} + b_i x_{ijk}, \sigma_\varepsilon^2)\\
A_{ij}  &amp; \stackrel{\text{iid}}{\sim} \mathcal{N}(a_i, \sigma^2_A).
\end{align*}\]</span>
Here, <span class="math inline">\(A_{ij}\)</span> gives the intercept for beach <span class="math inline">\(j\)</span> with exposure level <span class="math inline">\(i\)</span>. These beach-level intercepts are drawn from a Gaussian distribution with mean <span class="math inline">\(a_i\)</span>. The parameters <span class="math inline">\(b_i\)</span> give the slope for beaches with exposure level <span class="math inline">\(i\)</span>. We fit this model in R with the code</p>
<div class="sourceCode" id="cb520"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb520-1"><a href="hierarchical-mixed-models.html#cb520-1" tabindex="-1"></a>fm4 <span class="ot">&lt;-</span> lmerTest<span class="sc">::</span><span class="fu">lmer</span>(<span class="fu">sqrt</span>(Richness) <span class="sc">~</span> fExp <span class="sc">*</span> NAP <span class="sc">+</span> (<span class="dv">1</span> <span class="sc">|</span> fBeach), <span class="at">data =</span> rikz) </span>
<span id="cb520-2"><a href="hierarchical-mixed-models.html#cb520-2" tabindex="-1"></a><span class="fu">summary</span>(fm4)</span></code></pre></div>
<pre><code>## Linear mixed model fit by REML. t-tests use Satterthwaite&#39;s method [
## lmerModLmerTest]
## Formula: sqrt(Richness) ~ fExp * NAP + (1 | fBeach)
##    Data: rikz
## 
## REML criterion at convergence: 89.7
## 
## Scaled residuals: 
##     Min      1Q  Median      3Q     Max 
## -2.4532 -0.5066 -0.0280  0.3478  2.6221 
## 
## Random effects:
##  Groups   Name        Variance Std.Dev.
##  fBeach   (Intercept) 0.1395   0.3735  
##  Residual             0.3182   0.5641  
## Number of obs: 45, groups:  fBeach, 9
## 
## Fixed effects:
##             Estimate Std. Error      df t value Pr(&gt;|t|)    
## (Intercept)   2.7722     0.2047  7.3111  13.544 1.92e-06 ***
## fExp11       -0.9213     0.3096  7.5513  -2.976   0.0189 *  
## NAP          -0.8580     0.1207 37.7420  -7.110 1.82e-08 ***
## fExp11:NAP    0.3979     0.1818 37.1348   2.189   0.0350 *  
## ---
## Signif. codes:  0 &#39;***&#39; 0.001 &#39;**&#39; 0.01 &#39;*&#39; 0.05 &#39;.&#39; 0.1 &#39; &#39; 1
## 
## Correlation of Fixed Effects:
##            (Intr) fExp11 NAP   
## fExp11     -0.661              
## NAP        -0.174  0.115       
## fExp11:NAP  0.115 -0.212 -0.664</code></pre>
<p>There’s a lot of output to process here. For the moment, we’ll focus on selecting an appropriate model for the structure of the random effects. Once we’ve done that, then we’ll circle back and decipher the (presumably more interesting and more relevant) fixed-effects components of the model.</p>
<p>Proceeding in our series of models with increasingly complicated random effects, next we will consider a model where the slopes (of the NAP covariate) also differ among the beaches within each exposure-level group. This model writes as
<span class="math display">\[\begin{align*}
y_{ijk} &amp; \sim \mathcal{N}(A_{ij} + B_{ij} x_{ijk}, \sigma_\varepsilon^2)\\
A_{ij}  &amp; \stackrel{\text{iid}}{\sim} \mathcal{N}(a_i, \sigma^2_A) \\
B_{ij}  &amp; \stackrel{\text{iid}}{\sim} \mathcal{N}(b_i, \sigma^2_B) .
\end{align*}\]</span>
In this model, the newly added <span class="math inline">\(B_{ij}\)</span> give the slope of beach <span class="math inline">\(j\)</span> for exposure level <span class="math inline">\(i\)</span>.</p>
<p>We fit this model with the code</p>
<div class="sourceCode" id="cb522"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb522-1"><a href="hierarchical-mixed-models.html#cb522-1" tabindex="-1"></a>fm5 <span class="ot">&lt;-</span> lmerTest<span class="sc">::</span><span class="fu">lmer</span>(<span class="fu">sqrt</span>(Richness) <span class="sc">~</span> fExp <span class="sc">*</span> NAP <span class="sc">+</span> (<span class="dv">1</span> <span class="sc">|</span> fBeach) <span class="sc">+</span> (<span class="dv">0</span> <span class="sc">+</span> NAP <span class="sc">|</span> fBeach),</span>
<span id="cb522-2"><a href="hierarchical-mixed-models.html#cb522-2" tabindex="-1"></a>                      <span class="at">data =</span> rikz) </span>
<span id="cb522-3"><a href="hierarchical-mixed-models.html#cb522-3" tabindex="-1"></a><span class="fu">summary</span>(fm5)</span></code></pre></div>
<pre><code>## Linear mixed model fit by REML. t-tests use Satterthwaite&#39;s method [
## lmerModLmerTest]
## Formula: sqrt(Richness) ~ fExp * NAP + (1 | fBeach) + (0 + NAP | fBeach)
##    Data: rikz
## 
## REML criterion at convergence: 85.9
## 
## Scaled residuals: 
##      Min       1Q   Median       3Q      Max 
## -1.70750 -0.40036 -0.01429  0.32923  2.02319 
## 
## Random effects:
##  Groups   Name        Variance Std.Dev.
##  fBeach   (Intercept) 0.1783   0.4222  
##  fBeach.1 NAP         0.1476   0.3842  
##  Residual             0.2122   0.4606  
## Number of obs: 45, groups:  fBeach, 9
## 
## Fixed effects:
##             Estimate Std. Error      df t value Pr(&gt;|t|)    
## (Intercept)   2.8962     0.2153  7.1463  13.450 2.46e-06 ***
## fExp11       -1.0394     0.3248  7.2622  -3.200  0.01434 *  
## NAP          -0.8618     0.2007  5.7464  -4.295  0.00565 ** 
## fExp11:NAP    0.3904     0.3012  5.7584   1.296  0.24444    
## ---
## Signif. codes:  0 &#39;***&#39; 0.001 &#39;**&#39; 0.01 &#39;*&#39; 0.05 &#39;.&#39; 0.1 &#39; &#39; 1
## 
## Correlation of Fixed Effects:
##            (Intr) fExp11 NAP   
## fExp11     -0.663              
## NAP        -0.062  0.041       
## fExp11:NAP  0.041 -0.090 -0.666</code></pre>
<p>Finally, consider a model in which the random intercepts and slopes are correlated. This model writes as
<span class="math display">\[\begin{align*}
y_{ijk} &amp; \sim \mathcal{N}(A_{ij} + B_{ij} x_{ijk}, \sigma_\varepsilon^2)\\
\left(\begin{array}{c} A \\ B \end{array} \right)_i &amp; \sim \mathcal{N}_2 \left(\left(\begin{array}{c} a_i \\ b_i \end{array} \right), \left(\begin{array}{cc} \sigma_A^2 &amp; \sigma_{AB} \\ \sigma_{AB} &amp; \sigma_B^2 \end{array} \right) \right).
\end{align*}\]</span></p>
<p>We fit the model in R as follows</p>
<div class="sourceCode" id="cb524"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb524-1"><a href="hierarchical-mixed-models.html#cb524-1" tabindex="-1"></a>fm6 <span class="ot">&lt;-</span> lmerTest<span class="sc">::</span><span class="fu">lmer</span>(<span class="fu">sqrt</span>(Richness) <span class="sc">~</span> fExp <span class="sc">*</span> NAP <span class="sc">+</span> (<span class="dv">1</span> <span class="sc">+</span> NAP<span class="sc">|</span> fBeach), <span class="at">data =</span> rikz)  </span>
<span id="cb524-2"><a href="hierarchical-mixed-models.html#cb524-2" tabindex="-1"></a><span class="fu">summary</span>(fm6)</span></code></pre></div>
<pre><code>## Linear mixed model fit by REML. t-tests use Satterthwaite&#39;s method [
## lmerModLmerTest]
## Formula: sqrt(Richness) ~ fExp * NAP + (1 + NAP | fBeach)
##    Data: rikz
## 
## REML criterion at convergence: 85.8
## 
## Scaled residuals: 
##      Min       1Q   Median       3Q      Max 
## -1.70561 -0.39766 -0.01305  0.32821  2.02192 
## 
## Random effects:
##  Groups   Name        Variance Std.Dev. Corr
##  fBeach   (Intercept) 0.1767   0.4203       
##           NAP         0.1464   0.3826   0.05
##  Residual             0.2125   0.4610       
## Number of obs: 45, groups:  fBeach, 9
## 
## Fixed effects:
##             Estimate Std. Error      df t value Pr(&gt;|t|)    
## (Intercept)   2.8956     0.2146  6.9871  13.494 2.93e-06 ***
## fExp11       -1.0389     0.3237  7.0837  -3.210  0.01462 *  
## NAP          -0.8588     0.2001  5.6602  -4.292  0.00587 ** 
## fExp11:NAP    0.3874     0.3003  5.6586   1.290  0.24724    
## ---
## Signif. codes:  0 &#39;***&#39; 0.001 &#39;**&#39; 0.01 &#39;*&#39; 0.05 &#39;.&#39; 0.1 &#39; &#39; 1
## 
## Correlation of Fixed Effects:
##            (Intr) fExp11 NAP   
## fExp11     -0.663              
## NAP        -0.026  0.017       
## fExp11:NAP  0.017 -0.054 -0.666</code></pre>
<p>Because these models form a series of nested models, we can use LRTs or AIC to find the most parsimonious fit.</p>
<div class="sourceCode" id="cb526"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb526-1"><a href="hierarchical-mixed-models.html#cb526-1" tabindex="-1"></a><span class="fu">anova</span>(fm4, fm5, fm6)</span></code></pre></div>
<pre><code>## refitting model(s) with ML (instead of REML)</code></pre>
<pre><code>## Data: rikz
## Models:
## fm4: sqrt(Richness) ~ fExp * NAP + (1 | fBeach)
## fm5: sqrt(Richness) ~ fExp * NAP + (1 | fBeach) + (0 + NAP | fBeach)
## fm6: sqrt(Richness) ~ fExp * NAP + (1 + NAP | fBeach)
##     npar    AIC    BIC  logLik -2*log(L)  Chisq Df Pr(&gt;Chisq)
## fm4    6 94.275 105.11 -41.137    82.275                     
## fm5    7 94.418 107.06 -40.209    80.418 1.8565  1     0.1730
## fm6    8 96.373 110.83 -40.186    80.373 0.0454  1     0.8312</code></pre>
<p>Both AIC and the LRT suggest that the model with only random intercepts provides the most parsimonious fit. Let’s take a closer look at that model:</p>
<div class="sourceCode" id="cb529"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb529-1"><a href="hierarchical-mixed-models.html#cb529-1" tabindex="-1"></a><span class="fu">summary</span>(fm4)</span></code></pre></div>
<pre><code>## Linear mixed model fit by REML. t-tests use Satterthwaite&#39;s method [
## lmerModLmerTest]
## Formula: sqrt(Richness) ~ fExp * NAP + (1 | fBeach)
##    Data: rikz
## 
## REML criterion at convergence: 89.7
## 
## Scaled residuals: 
##     Min      1Q  Median      3Q     Max 
## -2.4532 -0.5066 -0.0280  0.3478  2.6221 
## 
## Random effects:
##  Groups   Name        Variance Std.Dev.
##  fBeach   (Intercept) 0.1395   0.3735  
##  Residual             0.3182   0.5641  
## Number of obs: 45, groups:  fBeach, 9
## 
## Fixed effects:
##             Estimate Std. Error      df t value Pr(&gt;|t|)    
## (Intercept)   2.7722     0.2047  7.3111  13.544 1.92e-06 ***
## fExp11       -0.9213     0.3096  7.5513  -2.976   0.0189 *  
## NAP          -0.8580     0.1207 37.7420  -7.110 1.82e-08 ***
## fExp11:NAP    0.3979     0.1818 37.1348   2.189   0.0350 *  
## ---
## Signif. codes:  0 &#39;***&#39; 0.001 &#39;**&#39; 0.01 &#39;*&#39; 0.05 &#39;.&#39; 0.1 &#39; &#39; 1
## 
## Correlation of Fixed Effects:
##            (Intr) fExp11 NAP   
## fExp11     -0.661              
## NAP        -0.174  0.115       
## fExp11:NAP  0.115 -0.212 -0.664</code></pre>
<p>We can analyze the fixed-effects as follows. Based on the contrasts R has used, the low exposure beaches are the baseline; thus the values for the “Intercept” and “NAP” coefficients give the intercept and slope for low-exposure beaches. The values of the “fExp11” and “fExp11:NAP” coefficients give the differences of the intercepts and slopes between the high vs. low exposure beaches. Thus the negative value of the “NAP” coefficient suggests that species richness declines as NAP increases at low-exposure beaches. The positive coefficient for the “fExp11:NAP” interaction suggests that species richness declines more gradually with increasing NAP at high-exposure beaches as compared to low-exposure beaches. Because we have analyzed the square-root transform of the response, it is hard to assign any biological meaning to the magnitudes of the coefficients. This is one downside of using a transformation to stabilize the variance in the response.</p>
<p>We’ll visualize the model with a plot.</p>
<div class="sourceCode" id="cb531"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb531-1"><a href="hierarchical-mixed-models.html#cb531-1" tabindex="-1"></a>a0 <span class="ot">&lt;-</span> <span class="fu">fixef</span>(fm4)[<span class="dv">1</span>]  <span class="co"># mean intercept for low-exposure beaches</span></span>
<span id="cb531-2"><a href="hierarchical-mixed-models.html#cb531-2" tabindex="-1"></a>b0 <span class="ot">&lt;-</span> <span class="fu">fixef</span>(fm4)[<span class="dv">2</span>]  <span class="co"># mean slope for low-exposure beaches</span></span>
<span id="cb531-3"><a href="hierarchical-mixed-models.html#cb531-3" tabindex="-1"></a>a1 <span class="ot">&lt;-</span> <span class="fu">fixef</span>(fm4)[<span class="dv">3</span>]  <span class="co"># difference in mean intercepts for high vs low </span></span>
<span id="cb531-4"><a href="hierarchical-mixed-models.html#cb531-4" tabindex="-1"></a>b1 <span class="ot">&lt;-</span> <span class="fu">fixef</span>(fm4)[<span class="dv">4</span>]  <span class="co"># difference in mean slopes for high vs low</span></span>
<span id="cb531-5"><a href="hierarchical-mixed-models.html#cb531-5" tabindex="-1"></a></span>
<span id="cb531-6"><a href="hierarchical-mixed-models.html#cb531-6" tabindex="-1"></a>c.mode <span class="ot">&lt;-</span> <span class="fu">ranef</span>(fm4)<span class="sc">$</span>fBeach</span>
<span id="cb531-7"><a href="hierarchical-mixed-models.html#cb531-7" tabindex="-1"></a></span>
<span id="cb531-8"><a href="hierarchical-mixed-models.html#cb531-8" tabindex="-1"></a>low.beaches <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="dv">1</span>, <span class="dv">2</span>, <span class="dv">5</span>, <span class="dv">8</span>, <span class="dv">9</span>) <span class="co"># indices of the low-exposure beaches</span></span>
<span id="cb531-9"><a href="hierarchical-mixed-models.html#cb531-9" tabindex="-1"></a>high.beaches <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="dv">3</span>, <span class="dv">4</span>, <span class="dv">6</span>, <span class="dv">7</span>) <span class="co"># indices of the high-exposure beacues</span></span>
<span id="cb531-10"><a href="hierarchical-mixed-models.html#cb531-10" tabindex="-1"></a></span>
<span id="cb531-11"><a href="hierarchical-mixed-models.html#cb531-11" tabindex="-1"></a><span class="fu">par</span>(<span class="at">mfrow =</span> <span class="fu">c</span>(<span class="dv">1</span>, <span class="dv">2</span>))  <span class="co"># split the plot region</span></span>
<span id="cb531-12"><a href="hierarchical-mixed-models.html#cb531-12" tabindex="-1"></a></span>
<span id="cb531-13"><a href="hierarchical-mixed-models.html#cb531-13" tabindex="-1"></a><span class="fu">with</span>(rikz, <span class="fu">plot</span>(<span class="fu">sqrt</span>(Richness) <span class="sc">~</span> NAP, </span>
<span id="cb531-14"><a href="hierarchical-mixed-models.html#cb531-14" tabindex="-1"></a>                <span class="at">type     =</span> <span class="st">&quot;n&quot;</span>, </span>
<span id="cb531-15"><a href="hierarchical-mixed-models.html#cb531-15" tabindex="-1"></a>                <span class="at">main     =</span> <span class="st">&quot;Exposure = 8 or 10&quot;</span>))  <span class="co"># set up the axes</span></span>
<span id="cb531-16"><a href="hierarchical-mixed-models.html#cb531-16" tabindex="-1"></a></span>
<span id="cb531-17"><a href="hierarchical-mixed-models.html#cb531-17" tabindex="-1"></a><span class="fu">with</span>(<span class="fu">subset</span>(rikz, fExp <span class="sc">==</span> <span class="st">&quot;10&quot;</span>), <span class="fu">points</span>(<span class="fu">sqrt</span>(Richness) <span class="sc">~</span> NAP, <span class="at">pch =</span> Beach))  <span class="co"># plot points for low exposure beaches</span></span>
<span id="cb531-18"><a href="hierarchical-mixed-models.html#cb531-18" tabindex="-1"></a></span>
<span id="cb531-19"><a href="hierarchical-mixed-models.html#cb531-19" tabindex="-1"></a><span class="fu">abline</span>(<span class="at">a =</span> a0, <span class="at">b =</span> b0, <span class="at">col =</span> <span class="st">&quot;red&quot;</span>, <span class="at">lwd =</span> <span class="dv">2</span>)  <span class="co"># add the average line for low-exposure beaches</span></span>
<span id="cb531-20"><a href="hierarchical-mixed-models.html#cb531-20" tabindex="-1"></a></span>
<span id="cb531-21"><a href="hierarchical-mixed-models.html#cb531-21" tabindex="-1"></a><span class="cf">for</span> (i <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span><span class="fu">length</span>(low.beaches)) {</span>
<span id="cb531-22"><a href="hierarchical-mixed-models.html#cb531-22" tabindex="-1"></a>  </span>
<span id="cb531-23"><a href="hierarchical-mixed-models.html#cb531-23" tabindex="-1"></a>  <span class="fu">abline</span>(<span class="at">a =</span> a0 <span class="sc">+</span> c.mode[low.beaches[i], <span class="dv">1</span>], <span class="at">b =</span> b0, <span class="at">col =</span> <span class="st">&quot;red&quot;</span>, <span class="at">lty =</span> <span class="st">&quot;dotted&quot;</span>)</span>
<span id="cb531-24"><a href="hierarchical-mixed-models.html#cb531-24" tabindex="-1"></a>}</span>
<span id="cb531-25"><a href="hierarchical-mixed-models.html#cb531-25" tabindex="-1"></a></span>
<span id="cb531-26"><a href="hierarchical-mixed-models.html#cb531-26" tabindex="-1"></a><span class="co"># Repeat for high exposure beaches</span></span>
<span id="cb531-27"><a href="hierarchical-mixed-models.html#cb531-27" tabindex="-1"></a></span>
<span id="cb531-28"><a href="hierarchical-mixed-models.html#cb531-28" tabindex="-1"></a><span class="fu">with</span>(rikz, <span class="fu">plot</span>(<span class="fu">sqrt</span>(Richness) <span class="sc">~</span> NAP, </span>
<span id="cb531-29"><a href="hierarchical-mixed-models.html#cb531-29" tabindex="-1"></a>                <span class="at">type     =</span> <span class="st">&quot;n&quot;</span>, </span>
<span id="cb531-30"><a href="hierarchical-mixed-models.html#cb531-30" tabindex="-1"></a>                <span class="at">main     =</span> <span class="st">&quot;Exposure = 11&quot;</span>))  <span class="co"># set up the axes</span></span>
<span id="cb531-31"><a href="hierarchical-mixed-models.html#cb531-31" tabindex="-1"></a></span>
<span id="cb531-32"><a href="hierarchical-mixed-models.html#cb531-32" tabindex="-1"></a><span class="fu">with</span>(<span class="fu">subset</span>(rikz, fExp <span class="sc">==</span> <span class="st">&quot;11&quot;</span>), <span class="fu">points</span>(<span class="fu">sqrt</span>(Richness) <span class="sc">~</span> NAP, <span class="at">pch =</span> Beach))  <span class="co"># plot points for low exposure beaches</span></span>
<span id="cb531-33"><a href="hierarchical-mixed-models.html#cb531-33" tabindex="-1"></a></span>
<span id="cb531-34"><a href="hierarchical-mixed-models.html#cb531-34" tabindex="-1"></a><span class="fu">abline</span>(<span class="at">a =</span> a0 <span class="sc">+</span> a1, <span class="at">b =</span> b0 <span class="sc">+</span> b1, <span class="at">col =</span> <span class="st">&quot;blue&quot;</span>, <span class="at">lwd =</span> <span class="dv">2</span>)  <span class="co"># add the average line for low-exposure beaches</span></span>
<span id="cb531-35"><a href="hierarchical-mixed-models.html#cb531-35" tabindex="-1"></a></span>
<span id="cb531-36"><a href="hierarchical-mixed-models.html#cb531-36" tabindex="-1"></a><span class="cf">for</span> (i <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span><span class="fu">length</span>(high.beaches)) {</span>
<span id="cb531-37"><a href="hierarchical-mixed-models.html#cb531-37" tabindex="-1"></a>  </span>
<span id="cb531-38"><a href="hierarchical-mixed-models.html#cb531-38" tabindex="-1"></a>  <span class="fu">abline</span>(<span class="at">a =</span> a0 <span class="sc">+</span> a1 <span class="sc">+</span> c.mode[high.beaches[i], <span class="dv">1</span>], <span class="at">b =</span> b0 <span class="sc">+</span> b1, <span class="at">col =</span> <span class="st">&quot;blue&quot;</span>, <span class="at">lty =</span> <span class="st">&quot;dotted&quot;</span>)</span>
<span id="cb531-39"><a href="hierarchical-mixed-models.html#cb531-39" tabindex="-1"></a>}</span></code></pre></div>
<p><img src="06-HierarchicalModels_files/figure-html/unnamed-chunk-54-1.png" width="672" /></p>
<p>As a last flourish, even though we have ruled out models with a random effect for the beaches, it’s still informative to see how the shrinkage plays out in those models. Here are the conditional modes of the intercept and slopes for the model with independent intercepts and slopes (<code>fm5</code>) above, color-coded by the beach’s exposure level:</p>
<div class="sourceCode" id="cb532"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb532-1"><a href="hierarchical-mixed-models.html#cb532-1" tabindex="-1"></a><span class="fu">par</span>(<span class="at">mfrow =</span> <span class="fu">c</span>(<span class="dv">1</span>, <span class="dv">2</span>))</span>
<span id="cb532-2"><a href="hierarchical-mixed-models.html#cb532-2" tabindex="-1"></a></span>
<span id="cb532-3"><a href="hierarchical-mixed-models.html#cb532-3" tabindex="-1"></a><span class="fu">with</span>(fixed.params, <span class="fu">plot</span>(slope <span class="sc">~</span> intercept, <span class="at">main =</span> <span class="st">&quot;fixed-effects fit&quot;</span>, <span class="at">type =</span> <span class="st">&quot;n&quot;</span>))</span>
<span id="cb532-4"><a href="hierarchical-mixed-models.html#cb532-4" tabindex="-1"></a><span class="fu">with</span>(fixed.params[low.beaches, ], <span class="fu">points</span>(slope <span class="sc">~</span> intercept, <span class="at">pch =</span> low.beaches, <span class="at">col =</span> <span class="st">&quot;red&quot;</span>))</span>
<span id="cb532-5"><a href="hierarchical-mixed-models.html#cb532-5" tabindex="-1"></a><span class="fu">with</span>(fixed.params[high.beaches, ], <span class="fu">points</span>(slope <span class="sc">~</span> intercept, <span class="at">pch =</span> high.beaches, <span class="at">col =</span> <span class="st">&quot;blue&quot;</span>))</span>
<span id="cb532-6"><a href="hierarchical-mixed-models.html#cb532-6" tabindex="-1"></a></span>
<span id="cb532-7"><a href="hierarchical-mixed-models.html#cb532-7" tabindex="-1"></a><span class="fu">legend</span>(<span class="st">&quot;bottomleft&quot;</span>, <span class="at">col =</span> <span class="fu">c</span>(<span class="st">&quot;red&quot;</span>, <span class="st">&quot;blue&quot;</span>), <span class="at">pch =</span> <span class="dv">16</span>, <span class="at">leg =</span> <span class="fu">c</span>(<span class="st">&quot;low&quot;</span>, <span class="st">&quot;high&quot;</span>))</span>
<span id="cb532-8"><a href="hierarchical-mixed-models.html#cb532-8" tabindex="-1"></a></span>
<span id="cb532-9"><a href="hierarchical-mixed-models.html#cb532-9" tabindex="-1"></a><span class="fu">with</span>(fixed.params, <span class="fu">plot</span>(slope <span class="sc">~</span> intercept, <span class="at">main =</span> <span class="st">&quot;conditional modes&quot;</span>, <span class="at">type =</span> <span class="st">&quot;n&quot;</span>))</span>
<span id="cb532-10"><a href="hierarchical-mixed-models.html#cb532-10" tabindex="-1"></a></span>
<span id="cb532-11"><a href="hierarchical-mixed-models.html#cb532-11" tabindex="-1"></a>conditional.modes.low <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(<span class="at">beach =</span> low.beaches, </span>
<span id="cb532-12"><a href="hierarchical-mixed-models.html#cb532-12" tabindex="-1"></a>                                    <span class="at">intercept =</span> <span class="fu">fixef</span>(fm5)[<span class="st">&quot;(Intercept)&quot;</span>] <span class="sc">+</span> <span class="fu">ranef</span>(fm5)<span class="sc">$</span>fBeach<span class="sc">$</span><span class="st">`</span><span class="at">(Intercept)</span><span class="st">`</span>[low.beaches], </span>
<span id="cb532-13"><a href="hierarchical-mixed-models.html#cb532-13" tabindex="-1"></a>                                    <span class="at">slope     =</span> <span class="fu">fixef</span>(fm5)[<span class="st">&quot;NAP&quot;</span>] <span class="sc">+</span> <span class="fu">ranef</span>(fm5)<span class="sc">$</span>fBeach<span class="sc">$</span><span class="st">`</span><span class="at">NAP</span><span class="st">`</span>[low.beaches])</span>
<span id="cb532-14"><a href="hierarchical-mixed-models.html#cb532-14" tabindex="-1"></a></span>
<span id="cb532-15"><a href="hierarchical-mixed-models.html#cb532-15" tabindex="-1"></a>conditional.modes.high <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(<span class="at">beach =</span> high.beaches, </span>
<span id="cb532-16"><a href="hierarchical-mixed-models.html#cb532-16" tabindex="-1"></a>                                     <span class="at">intercept =</span> <span class="fu">fixef</span>(fm5)[<span class="st">&quot;(Intercept)&quot;</span>] <span class="sc">+</span> <span class="fu">fixef</span>(fm5)[<span class="st">&quot;fExp11&quot;</span>] <span class="sc">+</span> <span class="fu">ranef</span>(fm5)<span class="sc">$</span>fBeach<span class="sc">$</span><span class="st">`</span><span class="at">(Intercept)</span><span class="st">`</span>[high.beaches], </span>
<span id="cb532-17"><a href="hierarchical-mixed-models.html#cb532-17" tabindex="-1"></a>                                     <span class="at">slope =</span> <span class="fu">fixef</span>(fm5)[<span class="st">&quot;NAP&quot;</span>] <span class="sc">+</span> <span class="fu">fixef</span>(fm5)[<span class="st">&quot;fExp11:NAP&quot;</span>] <span class="sc">+</span> <span class="fu">ranef</span>(fm5)<span class="sc">$</span>fBeach<span class="sc">$</span><span class="st">`</span><span class="at">NAP</span><span class="st">`</span>[high.beaches])</span>
<span id="cb532-18"><a href="hierarchical-mixed-models.html#cb532-18" tabindex="-1"></a></span>
<span id="cb532-19"><a href="hierarchical-mixed-models.html#cb532-19" tabindex="-1"></a><span class="fu">with</span>(conditional.modes.low, <span class="fu">points</span>(slope <span class="sc">~</span> intercept, <span class="at">pch =</span> low.beaches, <span class="at">col =</span> <span class="st">&quot;red&quot;</span>))</span>
<span id="cb532-20"><a href="hierarchical-mixed-models.html#cb532-20" tabindex="-1"></a><span class="fu">with</span>(conditional.modes.high, <span class="fu">points</span>(slope <span class="sc">~</span> intercept, <span class="at">pch =</span> high.beaches, <span class="at">col =</span> <span class="st">&quot;blue&quot;</span>))</span>
<span id="cb532-21"><a href="hierarchical-mixed-models.html#cb532-21" tabindex="-1"></a></span>
<span id="cb532-22"><a href="hierarchical-mixed-models.html#cb532-22" tabindex="-1"></a><span class="fu">points</span>(<span class="fu">fixef</span>(fm5)[<span class="st">&quot;(Intercept)&quot;</span>], <span class="fu">fixef</span>(fm5)[<span class="st">&quot;NAP&quot;</span>], <span class="at">pch =</span> <span class="dv">16</span>, <span class="at">col =</span> <span class="st">&quot;red&quot;</span>, <span class="at">cex =</span> <span class="dv">2</span>)</span>
<span id="cb532-23"><a href="hierarchical-mixed-models.html#cb532-23" tabindex="-1"></a><span class="fu">points</span>(<span class="fu">fixef</span>(fm5)[<span class="st">&quot;(Intercept)&quot;</span>] <span class="sc">+</span> <span class="fu">fixef</span>(fm5)[<span class="st">&quot;fExp11&quot;</span>],<span class="fu">fixef</span>(fm5)[<span class="st">&quot;NAP&quot;</span>] <span class="sc">+</span> <span class="fu">fixef</span>(fm5)[<span class="st">&quot;fExp11:NAP&quot;</span>], <span class="at">pch =</span> <span class="dv">16</span>, <span class="at">col =</span> <span class="st">&quot;blue&quot;</span>, <span class="at">cex =</span> <span class="dv">2</span>)</span></code></pre></div>
<p><img src="06-HierarchicalModels_files/figure-html/unnamed-chunk-55-1.png" width="672" /></p>
<!-- Finally, we'll fit a model in which the slope does not depend on exposure, just for comparison.  That is, we entertain the model -->
<!-- \begin{align*} -->
<!-- y_{ijk} & = A_{ij} + b x_{ijk} + \varepsilon_{ijk} \\ -->
<!-- A_{ij} & \sim \mathcal{N}(a_i, \sigma^2_A) \\ -->
<!-- \varepsilon_{ijk} & \stackrel{\text{iid}}{\sim} \mathcal{N}(0, \sigma_\varepsilon^2). -->
<!-- \end{align*} -->
<!-- ```{r} -->
<!-- fm5 <- lmerTest::lmer(sqrt(Richness) ~ 1 + NAP + fExp + (1 | fBeach), data = rikz) -->
<!-- a0 <- coef(summary(fm5))[1, 1]  # marginal intercept for low-exposure beaches -->
<!-- b0 <- coef(summary(fm5))[2, 1]  # common slope for all beaches -->
<!-- a1 <- coef(summary(fm5))[3, 1]  # difference in marginal intercepts for high vs low  -->
<!-- c.mode <- ranef(fm5)$fBeach -->
<!-- # this code is ugly, but oh well -->
<!-- par(mfrow = c(1, 2))  # split the plot region -->
<!-- with(rikz, plot(sqrt(Richness) ~ NAP,  -->
<!--                 type     = "n",  -->
<!--                 main     = "Exposure = 8 or 10"))  # set up the axes -->
<!-- with(subset(rikz, fExp == "10"), points(sqrt(Richness) ~ NAP, pch = Beach))  # plot points for low exposure beaches -->
<!-- abline(a = a0, b = b0, col = "red", lwd = 2)  # add the average line for low-exposure beaches -->
<!-- for (i in 1:length(low.beaches)) { -->
<!--   abline(a = a0 + c.mode[low.beaches[i], 1], b = b0, col = "red", lty = "dotted") -->
<!-- } -->
<!-- # Repeat for high exposure beaches -->
<!-- with(rikz, plot(sqrt(Richness) ~ NAP,  -->
<!--                 type     = "n",  -->
<!--                 main     = "Exposure = 11"))  # set up the axes -->
<!-- with(subset(rikz, fExp == "11"), points(sqrt(Richness) ~ NAP, pch = Beach))  # plot points for low exposure beaches -->
<!-- abline(a = a0 + a1, b = b0, col = "blue", lwd = 2)  # add the average line for low-exposure beaches -->
<!-- for (i in 1:length(high.beaches)) { -->
<!--   abline(a = a0 + a1 + c.mode[high.beaches[i], 1], b = b0, col = "blue", lty = "dotted") -->
<!-- } -->
<!-- # we want a model where the variance of the random beach effects differs between low vs. high exposure beaches. -->
<!-- # how do we do that?? -->
<!-- ``` -->
</div>
</div>
<div id="nested-and-crossed-random-effects" class="section level2 hasAnchor" number="6.4">
<h2><span class="header-section-number">6.4</span> Nested and crossed random effects<a href="hierarchical-mixed-models.html#nested-and-crossed-random-effects" class="anchor-section" aria-label="Anchor link to header"></a></h2>
<div id="nested-random-effects" class="section level3 hasAnchor" number="6.4.1">
<h3><span class="header-section-number">6.4.1</span> Nested random effects<a href="hierarchical-mixed-models.html#nested-random-effects" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<p>A major advantage of the <code>lme4::lmer</code> software is that it allows nested and crossed random effects. We will look first at an example of nested random effects. These data come from a study by Yates (1935), as reported in Venables &amp; Ripley (Modern Applied Statistics with S, 4e, 2002). They are found in the <code>MASS</code> library as the <code>oats</code> data. The description in the help documentation states:</p>
<blockquote>
<p>The yield of oats from a split-plot field trial using three varieties and four levels of manurial treatment. The experiment was laid out in 6 blocks of 3 main plots, each split into 4 sub-plots. The varieties were applied to the main plots and the manurial treatments to the sub-plots.</p>
</blockquote>
<p>Let’s first take a look at the data.</p>
<div class="sourceCode" id="cb533"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb533-1"><a href="hierarchical-mixed-models.html#cb533-1" tabindex="-1"></a><span class="fu">rm</span>(<span class="at">list =</span> <span class="fu">ls</span>())</span>
<span id="cb533-2"><a href="hierarchical-mixed-models.html#cb533-2" tabindex="-1"></a></span>
<span id="cb533-3"><a href="hierarchical-mixed-models.html#cb533-3" tabindex="-1"></a><span class="fu">library</span>(MASS)</span>
<span id="cb533-4"><a href="hierarchical-mixed-models.html#cb533-4" tabindex="-1"></a><span class="fu">require</span>(lme4)</span>
<span id="cb533-5"><a href="hierarchical-mixed-models.html#cb533-5" tabindex="-1"></a><span class="fu">require</span>(lmerTest)</span>
<span id="cb533-6"><a href="hierarchical-mixed-models.html#cb533-6" tabindex="-1"></a></span>
<span id="cb533-7"><a href="hierarchical-mixed-models.html#cb533-7" tabindex="-1"></a><span class="fu">data</span>(oats)</span>
<span id="cb533-8"><a href="hierarchical-mixed-models.html#cb533-8" tabindex="-1"></a><span class="fu">summary</span>(oats)</span></code></pre></div>
<pre><code>##    B                V           N            Y        
##  I  :12   Golden.rain:24   0.0cwt:18   Min.   : 53.0  
##  II :12   Marvellous :24   0.2cwt:18   1st Qu.: 86.0  
##  III:12   Victory    :24   0.4cwt:18   Median :102.5  
##  IV :12                    0.6cwt:18   Mean   :104.0  
##  V  :12                                3rd Qu.:121.2  
##  VI :12                                Max.   :174.0</code></pre>
<p>The variables are (respectively) [B]lock, [V]ariety, [N]itrogen (the manure), and the [Y]ield, in units of 1/4lbs, according to the help documentation.</p>
<p>To develop notation, let <span class="math inline">\(i = 1, \ldots, 3\)</span> index the three varieties, let <span class="math inline">\(j = 1, \ldots, 4\)</span> index the four manure treatments, and let <span class="math inline">\(k = 1, \ldots, 6\)</span> index the blocks. We wish to entertain the usual model for a split-plot design with a blocking factor at the whole-plot level:</p>
<p><span class="math display">\[\begin{align}
y_{ijk} &amp; \sim \mathcal{N}(\mu_{ij} + B_k + W_{ik}, \sigma^2_\varepsilon) \\
B_k  &amp; \stackrel{\text{iid}}{\sim} \mathcal{N}(0, \sigma^2_B) \\
W_{ik}  &amp; \stackrel{\text{iid}}{\sim} \mathcal{N}(0, \sigma^2_W).
\end{align}\]</span></p>
<p>Here, <span class="math inline">\(\mu_{ij}\)</span> is the average response for the combination of variety <span class="math inline">\(i\)</span> and manure treatment <span class="math inline">\(j\)</span>; the <span class="math inline">\(B_k\)</span> are the random effects for the blocks, the <span class="math inline">\(W_{ik}\)</span> are the whole-plot errors, and the <span class="math inline">\(\varepsilon_{ijk}\)</span> are the split-plot (observation-level) errors. We proceed to fit the model using <code>lmerTest::lmer</code>. A key to the coding here is to notice that each combination of block and variety uniquely specifies one of the 18 whole plots. (In other words, variety is not replicated within the blocks.) Therefore, we can code the whole-plot random effect as <code>(1 | B : V)</code>, which creats a random effect for each unique combination of block and variety. The rest of the model coding is straightforward.</p>
<div class="sourceCode" id="cb535"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb535-1"><a href="hierarchical-mixed-models.html#cb535-1" tabindex="-1"></a>fm1 <span class="ot">&lt;-</span> lmerTest<span class="sc">::</span><span class="fu">lmer</span>(Y <span class="sc">~</span> V <span class="sc">*</span> N <span class="sc">+</span> (<span class="dv">1</span> <span class="sc">|</span> B) <span class="sc">+</span> (<span class="dv">1</span> <span class="sc">|</span> B <span class="sc">:</span> V), <span class="at">data =</span> oats)</span>
<span id="cb535-2"><a href="hierarchical-mixed-models.html#cb535-2" tabindex="-1"></a></span>
<span id="cb535-3"><a href="hierarchical-mixed-models.html#cb535-3" tabindex="-1"></a><span class="co"># for nested random effects, lmer provides the coding shortcut  </span></span>
<span id="cb535-4"><a href="hierarchical-mixed-models.html#cb535-4" tabindex="-1"></a></span>
<span id="cb535-5"><a href="hierarchical-mixed-models.html#cb535-5" tabindex="-1"></a>fm1a <span class="ot">&lt;-</span> lmerTest<span class="sc">::</span><span class="fu">lmer</span>(Y <span class="sc">~</span> V <span class="sc">*</span> N <span class="sc">+</span> (<span class="dv">1</span> <span class="sc">|</span> B <span class="sc">/</span> V), <span class="at">data =</span> oats)</span>
<span id="cb535-6"><a href="hierarchical-mixed-models.html#cb535-6" tabindex="-1"></a></span>
<span id="cb535-7"><a href="hierarchical-mixed-models.html#cb535-7" tabindex="-1"></a><span class="fu">summary</span>(fm1)</span></code></pre></div>
<pre><code>## Linear mixed model fit by REML. t-tests use Satterthwaite&#39;s method [
## lmerModLmerTest]
## Formula: Y ~ V * N + (1 | B) + (1 | B:V)
##    Data: oats
## 
## REML criterion at convergence: 529
## 
## Scaled residuals: 
##      Min       1Q   Median       3Q      Max 
## -1.81301 -0.56145  0.01758  0.63865  1.57034 
## 
## Random effects:
##  Groups   Name        Variance Std.Dev.
##  B:V      (Intercept) 106.1    10.30   
##  B        (Intercept) 214.5    14.65   
##  Residual             177.1    13.31   
## Number of obs: 72, groups:  B:V, 18; B, 6
## 
## Fixed effects:
##                     Estimate Std. Error      df t value Pr(&gt;|t|)    
## (Intercept)          80.0000     9.1070 16.0816   8.784 1.55e-07 ***
## VMarvellous           6.6667     9.7150 30.2308   0.686   0.4978    
## VVictory             -8.5000     9.7150 30.2308  -0.875   0.3885    
## N0.2cwt              18.5000     7.6829 45.0000   2.408   0.0202 *  
## N0.4cwt              34.6667     7.6829 45.0000   4.512 4.58e-05 ***
## N0.6cwt              44.8333     7.6829 45.0000   5.835 5.48e-07 ***
## VMarvellous:N0.2cwt   3.3333    10.8653 45.0000   0.307   0.7604    
## VVictory:N0.2cwt     -0.3333    10.8653 45.0000  -0.031   0.9757    
## VMarvellous:N0.4cwt  -4.1667    10.8653 45.0000  -0.383   0.7032    
## VVictory:N0.4cwt      4.6667    10.8653 45.0000   0.430   0.6696    
## VMarvellous:N0.6cwt  -4.6667    10.8653 45.0000  -0.430   0.6696    
## VVictory:N0.6cwt      2.1667    10.8653 45.0000   0.199   0.8428    
## ---
## Signif. codes:  0 &#39;***&#39; 0.001 &#39;**&#39; 0.01 &#39;*&#39; 0.05 &#39;.&#39; 0.1 &#39; &#39; 1
## 
## Correlation of Fixed Effects:
##             (Intr) VMrvll VVctry N0.2cw N0.4cw N0.6cw VM:N0.2 VV:N0.2 VM:N0.4
## VMarvellous -0.533                                                           
## VVictory    -0.533  0.500                                                    
## N0.2cwt     -0.422  0.395  0.395                                             
## N0.4cwt     -0.422  0.395  0.395  0.500                                      
## N0.6cwt     -0.422  0.395  0.395  0.500  0.500                               
## VMrvll:N0.2  0.298 -0.559 -0.280 -0.707 -0.354 -0.354                        
## VVctry:N0.2  0.298 -0.280 -0.559 -0.707 -0.354 -0.354  0.500                 
## VMrvll:N0.4  0.298 -0.559 -0.280 -0.354 -0.707 -0.354  0.500   0.250         
## VVctry:N0.4  0.298 -0.280 -0.559 -0.354 -0.707 -0.354  0.250   0.500   0.500 
## VMrvll:N0.6  0.298 -0.559 -0.280 -0.354 -0.354 -0.707  0.500   0.250   0.500 
## VVctry:N0.6  0.298 -0.280 -0.559 -0.354 -0.354 -0.707  0.250   0.500   0.250 
##             VV:N0.4 VM:N0.6
## VMarvellous                
## VVictory                   
## N0.2cwt                    
## N0.4cwt                    
## N0.6cwt                    
## VMrvll:N0.2                
## VVctry:N0.2                
## VMrvll:N0.4                
## VVctry:N0.4                
## VMrvll:N0.6  0.250         
## VVctry:N0.6  0.500   0.500</code></pre>
<div class="sourceCode" id="cb537"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb537-1"><a href="hierarchical-mixed-models.html#cb537-1" tabindex="-1"></a><span class="fu">anova</span>(fm1)</span></code></pre></div>
<pre><code>## Type III Analysis of Variance Table with Satterthwaite&#39;s method
##      Sum Sq Mean Sq NumDF DenDF F value    Pr(&gt;F)    
## V     526.1   263.0     2    10  1.4853    0.2724    
## N   20020.5  6673.5     3    45 37.6857 2.458e-12 ***
## V:N   321.7    53.6     6    45  0.3028    0.9322    
## ---
## Signif. codes:  0 &#39;***&#39; 0.001 &#39;**&#39; 0.01 &#39;*&#39; 0.05 &#39;.&#39; 0.1 &#39; &#39; 1</code></pre>
<p>We proceed to analyze the fixed effects in the usual fashion, noting first that the variety-by-nitrogen interaction is not significant. We then proceed to inspect the <span class="math inline">\(F\)</span>-tests of the fixed effects, and see that the marginal means for the manure treatment are significantly different, but there are no significant differences among the marginal means for the three varieties.</p>
<p>Note that it would be incorrect to have coded the model as</p>
<div class="sourceCode" id="cb539"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb539-1"><a href="hierarchical-mixed-models.html#cb539-1" tabindex="-1"></a>fm1.wrong <span class="ot">&lt;-</span> lmerTest<span class="sc">::</span><span class="fu">lmer</span>(Y <span class="sc">~</span> V <span class="sc">*</span> N <span class="sc">+</span> (<span class="dv">1</span> <span class="sc">|</span> B) <span class="sc">+</span> (<span class="dv">1</span> <span class="sc">|</span> V), <span class="at">data =</span> oats)</span></code></pre></div>
<p>as this would have treated the random effects for block and variety as crossed, not nested.</p>
<p>To complete the analysis, we should notice that the levels of the nitrogen treatment correspond to equally spaced values of a numerical covariate. We can thus extract the polynomial trends by assigning polynomial contrasts to the nitrogen treatment.</p>
<div class="sourceCode" id="cb540"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb540-1"><a href="hierarchical-mixed-models.html#cb540-1" tabindex="-1"></a><span class="fu">contrasts</span>(oats<span class="sc">$</span>N) <span class="ot">&lt;-</span> <span class="fu">contr.poly</span>(<span class="at">n =</span> <span class="dv">4</span>)</span>
<span id="cb540-2"><a href="hierarchical-mixed-models.html#cb540-2" tabindex="-1"></a>fm1 <span class="ot">&lt;-</span> lmerTest<span class="sc">::</span><span class="fu">lmer</span>(Y <span class="sc">~</span> V <span class="sc">*</span> N <span class="sc">+</span>  (<span class="dv">1</span> <span class="sc">|</span> B) <span class="sc">+</span> (<span class="dv">1</span> <span class="sc">|</span> B <span class="sc">:</span> V), <span class="at">data =</span> oats)</span>
<span id="cb540-3"><a href="hierarchical-mixed-models.html#cb540-3" tabindex="-1"></a></span>
<span id="cb540-4"><a href="hierarchical-mixed-models.html#cb540-4" tabindex="-1"></a><span class="fu">summary</span>(fm1)</span></code></pre></div>
<pre><code>## Linear mixed model fit by REML. t-tests use Satterthwaite&#39;s method [
## lmerModLmerTest]
## Formula: Y ~ V * N + (1 | B) + (1 | B:V)
##    Data: oats
## 
## REML criterion at convergence: 533.2
## 
## Scaled residuals: 
##      Min       1Q   Median       3Q      Max 
## -1.81301 -0.56145  0.01758  0.63865  1.57034 
## 
## Random effects:
##  Groups   Name        Variance Std.Dev.
##  B:V      (Intercept) 106.1    10.30   
##  B        (Intercept) 214.5    14.65   
##  Residual             177.1    13.31   
## Number of obs: 72, groups:  B:V, 18; B, 6
## 
## Fixed effects:
##                 Estimate Std. Error       df t value Pr(&gt;|t|)    
## (Intercept)     104.5000     7.7976   8.8688  13.402 3.45e-07 ***
## VMarvellous       5.2917     7.0789  10.0000   0.748    0.472    
## VVictory         -6.8750     7.0789  10.0000  -0.971    0.354    
## N.L              33.6901     5.4327  45.0000   6.201 1.57e-07 ***
## N.Q              -4.1667     5.4327  45.0000  -0.767    0.447    
## N.C              -0.8199     5.4327  45.0000  -0.151    0.881    
## VMarvellous:N.L  -4.8075     7.6829  45.0000  -0.626    0.535    
## VVictory:N.L      2.5715     7.6829  45.0000   0.335    0.739    
## VMarvellous:N.Q  -1.9167     7.6829  45.0000  -0.249    0.804    
## VVictory:N.Q     -1.0833     7.6829  45.0000  -0.141    0.888    
## VMarvellous:N.C   3.9877     7.6829  45.0000   0.519    0.606    
## VVictory:N.C     -2.8696     7.6829  45.0000  -0.374    0.711    
## ---
## Signif. codes:  0 &#39;***&#39; 0.001 &#39;**&#39; 0.01 &#39;*&#39; 0.05 &#39;.&#39; 0.1 &#39; &#39; 1
## 
## Correlation of Fixed Effects:
##             (Intr) VMrvll VVctry N.L    N.Q    N.C    VM:N.L VV:N.L VM:N.Q
## VMarvellous -0.454                                                        
## VVictory    -0.454  0.500                                                 
## N.L          0.000  0.000  0.000                                          
## N.Q          0.000  0.000  0.000  0.000                                   
## N.C          0.000  0.000  0.000  0.000  0.000                            
## VMrvlls:N.L  0.000  0.000  0.000 -0.707  0.000  0.000                     
## VVictry:N.L  0.000  0.000  0.000 -0.707  0.000  0.000  0.500              
## VMrvlls:N.Q  0.000  0.000  0.000  0.000 -0.707  0.000  0.000  0.000       
## VVictry:N.Q  0.000  0.000  0.000  0.000 -0.707  0.000  0.000  0.000  0.500
## VMrvlls:N.C  0.000  0.000  0.000  0.000  0.000 -0.707  0.000  0.000  0.000
## VVictry:N.C  0.000  0.000  0.000  0.000  0.000 -0.707  0.000  0.000  0.000
##             VV:N.Q VM:N.C
## VMarvellous              
## VVictory                 
## N.L                      
## N.Q                      
## N.C                      
## VMrvlls:N.L              
## VVictry:N.L              
## VMrvlls:N.Q              
## VVictry:N.Q              
## VMrvlls:N.C  0.000       
## VVictry:N.C  0.000  0.500</code></pre>
<p>We see that only the linear trend of the nitrogen treatment is significant. Let’s make a quick plot to visualize this effect.</p>
<div class="sourceCode" id="cb542"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb542-1"><a href="hierarchical-mixed-models.html#cb542-1" tabindex="-1"></a><span class="fu">with</span>(oats, <span class="fu">plot</span>(Y <span class="sc">~</span> N))</span></code></pre></div>
<p><img src="06-HierarchicalModels_files/figure-html/unnamed-chunk-60-1.png" width="672" /></p>
</div>
<div id="crossed-random-effects" class="section level3 hasAnchor" number="6.4.2">
<h3><span class="header-section-number">6.4.2</span> Crossed random effects<a href="hierarchical-mixed-models.html#crossed-random-effects" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<p>To illustrate crossed random effects, we will model players’ scores from the 2018 US Open golf tournament. This data set includes scores for all 136 players who competed in the tournament. All players participated in the first two days of the tournament. Players who had a sufficiently low (good) total score from those first two days qualified to compete in the next two days. Players who with a high (poor) total score from the first two days were disqualified or “cut” from the tournament.</p>
<p>To develop notation, let <span class="math inline">\(i=1, \ldots, 136\)</span> index the players, and let <span class="math inline">\(j = 1, \ldots, 4\)</span> index the days. We seek to fit the model
<span class="math display">\[\begin{align}
y_{ij} &amp; \sim \mathcal{N}(\mu + A_i + B_j, \sigma^2_\varepsilon) \\
A_i  &amp; \stackrel{\text{iid}}{\sim} \mathcal{N}(0, \sigma^2_A) \\
B_j  &amp; \stackrel{\text{iid}}{\sim} \mathcal{N}(0, \sigma^2_B).
\end{align}\]</span></p>
<p>In this model, <span class="math inline">\(\mu\)</span> is the average score, <span class="math inline">\(A_i\)</span> are the player-level random effects, <span class="math inline">\(B_j\)</span> are the day-level random effects, and <span class="math inline">\(\varepsilon_{ij}\)</span> are the observation-level errors. Note that because each player played at most once in each day, there is no possibility to separate a possible player-by-day interaction (also a random effect) from the observation-level error. If the players had played multiple rounds in a given day, we could have tried to separate the player-by-day random effect from the observation-level error. We fit the model in <code>lmerTest::lmer</code>.</p>
<div class="sourceCode" id="cb543"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb543-1"><a href="hierarchical-mixed-models.html#cb543-1" tabindex="-1"></a>golf <span class="ot">&lt;-</span> <span class="fu">read.table</span>(<span class="st">&quot;data/golf.txt&quot;</span>, <span class="at">head =</span> T)</span>
<span id="cb543-2"><a href="hierarchical-mixed-models.html#cb543-2" tabindex="-1"></a></span>
<span id="cb543-3"><a href="hierarchical-mixed-models.html#cb543-3" tabindex="-1"></a>fm1 <span class="ot">&lt;-</span> lmerTest<span class="sc">::</span><span class="fu">lmer</span>(score <span class="sc">~</span> <span class="dv">1</span> <span class="sc">+</span> (<span class="dv">1</span> <span class="sc">|</span> player) <span class="sc">+</span> (<span class="dv">1</span> <span class="sc">|</span> round), <span class="at">data =</span> golf)</span>
<span id="cb543-4"><a href="hierarchical-mixed-models.html#cb543-4" tabindex="-1"></a></span>
<span id="cb543-5"><a href="hierarchical-mixed-models.html#cb543-5" tabindex="-1"></a><span class="fu">summary</span>(fm1)  <span class="co"># comparison of the std devs of the random effects is interesting</span></span></code></pre></div>
<pre><code>## Linear mixed model fit by REML. t-tests use Satterthwaite&#39;s method [
## lmerModLmerTest]
## Formula: score ~ 1 + (1 | player) + (1 | round)
##    Data: golf
## 
## REML criterion at convergence: 2130.5
## 
## Scaled residuals: 
##     Min      1Q  Median      3Q     Max 
## -2.6856 -0.6669 -0.0515  0.5825  4.5577 
## 
## Random effects:
##  Groups   Name        Variance Std.Dev.
##  player   (Intercept)  0.5059  0.7113  
##  round    (Intercept)  3.1513  1.7752  
##  Residual             11.2507  3.3542  
## Number of obs: 400, groups:  player, 136; round, 4
## 
## Fixed effects:
##             Estimate Std. Error      df t value Pr(&gt;|t|)    
## (Intercept)  74.2631     0.9081  3.0093   81.78  3.9e-06 ***
## ---
## Signif. codes:  0 &#39;***&#39; 0.001 &#39;**&#39; 0.01 &#39;*&#39; 0.05 &#39;.&#39; 0.1 &#39; &#39; 1</code></pre>
<p>It is interesting to compare the standard deviations of the random effects. It is also interesting to use the profile function to see the asymmetry in the confidence intervals for these standard deviations.</p>
<div class="sourceCode" id="cb545"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb545-1"><a href="hierarchical-mixed-models.html#cb545-1" tabindex="-1"></a>pp.golf <span class="ot">&lt;-</span> <span class="fu">profile</span>(fm1)</span>
<span id="cb545-2"><a href="hierarchical-mixed-models.html#cb545-2" tabindex="-1"></a></span>
<span id="cb545-3"><a href="hierarchical-mixed-models.html#cb545-3" tabindex="-1"></a><span class="fu">confint</span>(pp.golf)</span></code></pre></div>
<pre><code>##                  2.5 %    97.5 %
## .sig01       0.0000000  1.551145
## .sig02       0.8129721  3.837297
## .sigma       3.0513011  3.666234
## (Intercept) 72.2434040 76.265786</code></pre>
<div class="sourceCode" id="cb547"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb547-1"><a href="hierarchical-mixed-models.html#cb547-1" tabindex="-1"></a>lattice<span class="sc">::</span><span class="fu">xyplot</span>(pp.golf, <span class="at">absVal =</span> <span class="cn">TRUE</span>)</span></code></pre></div>
<p><img src="06-HierarchicalModels_files/figure-html/unnamed-chunk-63-1.png" width="672" /></p>
<p>We can also extract the conditional modes for the players and rounds.</p>
<div class="sourceCode" id="cb548"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb548-1"><a href="hierarchical-mixed-models.html#cb548-1" tabindex="-1"></a>player.modes <span class="ot">&lt;-</span> <span class="fu">ranef</span>(fm1)<span class="sc">$</span>player</span>
<span id="cb548-2"><a href="hierarchical-mixed-models.html#cb548-2" tabindex="-1"></a><span class="fu">head</span>(player.modes)</span></code></pre></div>
<pre><code>##             (Intercept)
## Akiyoshi      0.3983034
## Aphibarnrat  -0.3069054
## Axley        -0.0142805
## Babcock       0.1920115
## Baddeley     -0.1925652
## Berger       -0.4212456</code></pre>
<div class="sourceCode" id="cb550"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb550-1"><a href="hierarchical-mixed-models.html#cb550-1" tabindex="-1"></a>(round.modes <span class="ot">&lt;-</span> <span class="fu">ranef</span>(fm1)<span class="sc">$</span>round)</span></code></pre></div>
<pre><code>##     (Intercept)
## rd1   1.7211234
## rd2  -0.9012137
## rd3   1.1661848
## rd4  -1.9860945</code></pre>
<p>According to Wikipedia, on day 1 “conditions were extremely difficult as gusty winds hung around all day with sunny skies, making the course firm and fast.” This corresponds with the large conditional mode for round 1.</p>
<p>Finally, it is interesting to compare the conditional modes for the players who qualified to play in rounds 3 and 4, vs. the players who were “cut”.</p>
<div class="sourceCode" id="cb552"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb552-1"><a href="hierarchical-mixed-models.html#cb552-1" tabindex="-1"></a>player.stats <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(<span class="at">name =</span> <span class="fu">row.names</span>(player.modes),</span>
<span id="cb552-2"><a href="hierarchical-mixed-models.html#cb552-2" tabindex="-1"></a>                           <span class="at">mode =</span> player.modes[, <span class="dv">1</span>],</span>
<span id="cb552-3"><a href="hierarchical-mixed-models.html#cb552-3" tabindex="-1"></a>                           <span class="at">rds  =</span> <span class="fu">with</span>(golf, <span class="fu">as.numeric</span>(<span class="fu">table</span>(player))))</span>
<span id="cb552-4"><a href="hierarchical-mixed-models.html#cb552-4" tabindex="-1"></a></span>
<span id="cb552-5"><a href="hierarchical-mixed-models.html#cb552-5" tabindex="-1"></a><span class="fu">with</span>(player.stats, <span class="fu">stripchart</span>(mode <span class="sc">~</span> <span class="fu">as.factor</span>(rds), <span class="at">method =</span> <span class="st">&quot;jitter&quot;</span>, <span class="at">ylab =</span> <span class="st">&quot;rounds played&quot;</span>, </span>
<span id="cb552-6"><a href="hierarchical-mixed-models.html#cb552-6" tabindex="-1"></a>                              <span class="at">xlab =</span> <span class="st">&quot;conditional mode&quot;</span>, <span class="at">pch =</span> <span class="dv">1</span>))</span></code></pre></div>
<p><img src="06-HierarchicalModels_files/figure-html/unnamed-chunk-65-1.png" width="672" /></p>
<p>Interestingly, some players who qualified to play in rounds 3 and 4 ended up with higher (worse) conditional modes than some of the players who were “cut”. We might infer that these players played above their abilities on days 1 and 2.</p>
<p><img src="images/sports-comic.png" /><!-- --></p>
<p>Thanks to xkcd for the perspective.</p>
</div>
<div id="an-ecological-example-with-both-crossed-and-nested-random-effects" class="section level3 hasAnchor" number="6.4.3">
<h3><span class="header-section-number">6.4.3</span> An ecological example with both crossed and nested random effects<a href="hierarchical-mixed-models.html#an-ecological-example-with-both-crossed-and-nested-random-effects" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<p>M. Kirchner and E. Youngsteadt conducted the following study to examine the thermal tolerance of several ant species. Five sites were selected. At each of the five sites, up to three oak trees were sampled. Ant nests were sampled from each of the trees. Nests were scored with respect to the species of ant and the habitat in which the nest was found (arboreal or terrestrial). For each nest, the thermal tolerance of five ants was measured. The response that we consider here, <code>ct_max</code>, is the average maximum thermal tolerance of these five ants. (Thus there is one data record per nest.)</p>
<p>In this analysis, we restrict our attention to the habitat specialists, that is, those species that were found either only in arboreal habitats or only in terrestrial habitats.<a href="#fn8" class="footnote-ref" id="fnref8"><sup>8</sup></a> The investigators are interested in characterizing the difference between the average thermal tolerance of arboreal species vs. the average thermal tolerance of terrestrial species.</p>
<div class="sourceCode" id="cb553"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb553-1"><a href="hierarchical-mixed-models.html#cb553-1" tabindex="-1"></a>ant <span class="ot">&lt;-</span> <span class="fu">read.csv</span>(<span class="st">&quot;data/ant.csv&quot;</span>, <span class="at">head =</span> T, <span class="at">stringsAsFactors =</span> T)</span>
<span id="cb553-2"><a href="hierarchical-mixed-models.html#cb553-2" tabindex="-1"></a></span>
<span id="cb553-3"><a href="hierarchical-mixed-models.html#cb553-3" tabindex="-1"></a>ant_s <span class="ot">&lt;-</span> <span class="fu">droplevels</span>(<span class="fu">subset</span>(ant, genus_species <span class="sc">!=</span> <span class="st">&quot;Brachyponera chinensis&quot;</span>))  <span class="co"># exclude the generalist</span></span>
<span id="cb553-4"><a href="hierarchical-mixed-models.html#cb553-4" tabindex="-1"></a>ant_s <span class="ot">&lt;-</span> ant_s[, <span class="fu">c</span>(<span class="dv">2</span>, <span class="dv">3</span>, <span class="dv">5</span>, <span class="dv">6</span>, <span class="dv">8</span>)]  <span class="co"># remove irrelevant variables</span></span>
<span id="cb553-5"><a href="hierarchical-mixed-models.html#cb553-5" tabindex="-1"></a><span class="fu">names</span>(ant_s) <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">&quot;site&quot;</span>, <span class="st">&quot;tree&quot;</span>, <span class="st">&quot;habitat&quot;</span>, <span class="st">&quot;species&quot;</span>, <span class="st">&quot;ct_max&quot;</span>)</span>
<span id="cb553-6"><a href="hierarchical-mixed-models.html#cb553-6" tabindex="-1"></a><span class="fu">summary</span>(ant_s)</span></code></pre></div>
<pre><code>##   site     tree           habitat                        species  
##  ER1:10   QA4:11   arboreal   :17   Aphaenogaster rudis s.l. : 8  
##  ER2:14   QA5:23   terrestrial:39   Formica subsericea       : 8  
##  FL2: 7   QA6:22                    Camponotus castaneus     : 7  
##  UM1:15                             Crematogaster vermiculata: 6  
##  UM2:10                             Camponotus chromaiodes   : 4  
##                                     Crematogaster ashmeadi   : 4  
##                                     (Other)                  :19  
##      ct_max     
##  Min.   :42.20  
##  1st Qu.:43.09  
##  Median :44.26  
##  Mean   :44.86  
##  3rd Qu.:46.35  
##  Max.   :49.20  
## </code></pre>
<p>For this analysis, we use random effects to capture the differences among sites and the differences among trees at each site. The trees are nested within the sites. (Each tree occurs at one and only one site, but most sites have several trees.) We also use random effects to capture the differences among the species, regarding the species as a representative sample of all arboreal and of all terrestrial ant species. Although most species are absent from most sites, some species occur at multiple sites, and thus the species random effect is crossed with the site and tree random effects.</p>
<p>The differences between the habitats are modeled with a fixed effect, because the researchers are specifically interested in these two habitats.</p>
<p>Here is some brief data exploration that shows how many nests of each species were found at each site.</p>
<div class="sourceCode" id="cb555"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb555-1"><a href="hierarchical-mixed-models.html#cb555-1" tabindex="-1"></a><span class="fu">with</span>(ant_s, <span class="fu">table</span>(species, site))</span></code></pre></div>
<pre><code>##                              site
## species                       ER1 ER2 FL2 UM1 UM2
##   Aphaenogaster mariae          0   0   2   0   0
##   Aphaenogaster rudis s.l.      3   3   0   2   0
##   Aphaenogaster tennesseensis   1   0   0   0   0
##   Camponotus americanus         0   0   0   1   0
##   Camponotus castaneus          1   2   2   0   2
##   Camponotus chromaiodes        1   2   1   0   0
##   Camponotus nearcticus         0   1   1   1   0
##   Camponotus pennsylvanicus     1   0   0   0   0
##   Crematogaster ashmeadi        0   1   0   3   0
##   Crematogaster vermiculata     0   0   0   0   6
##   Formica subsericea            1   3   1   1   2
##   Lasius americanus             0   0   0   3   0
##   Monomorium minimum            0   1   0   0   0
##   Nylanderia faisonensis        1   0   0   1   0
##   Prenolepis imparis            0   1   0   0   0
##   Solenopsis molesta s.l.       0   0   0   2   0
##   Temnothorax curvispinosus     1   0   0   0   0
##   Temnothorax schaumii          0   0   0   1   0</code></pre>
<p>To visualize the data, we will compute the raw average thermal tolerance for each species.</p>
<div class="sourceCode" id="cb557"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb557-1"><a href="hierarchical-mixed-models.html#cb557-1" tabindex="-1"></a>s_data <span class="ot">&lt;-</span> <span class="fu">with</span>(ant_s, <span class="fu">aggregate</span>(ct_max, <span class="fu">list</span>(habitat, species), <span class="at">FUN =</span> mean))  <span class="co"># note the rows are sorted alphabetically by species</span></span>
<span id="cb557-2"><a href="hierarchical-mixed-models.html#cb557-2" tabindex="-1"></a><span class="fu">names</span>(s_data) <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">&quot;habitat&quot;</span>, <span class="st">&quot;species&quot;</span>, <span class="st">&quot;avg&quot;</span>)</span>
<span id="cb557-3"><a href="hierarchical-mixed-models.html#cb557-3" tabindex="-1"></a><span class="fu">with</span>(s_data, <span class="fu">stripchart</span>(avg <span class="sc">~</span> habitat, <span class="at">pch =</span> <span class="dv">16</span>))</span></code></pre></div>
<p><img src="06-HierarchicalModels_files/figure-html/unnamed-chunk-70-1.png" width="672" />
Now fit the model with the desired structure.</p>
<div class="sourceCode" id="cb558"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb558-1"><a href="hierarchical-mixed-models.html#cb558-1" tabindex="-1"></a>fm1 <span class="ot">&lt;-</span> lme4<span class="sc">::</span><span class="fu">lmer</span>(ct_max <span class="sc">~</span> habitat <span class="sc">+</span> (<span class="dv">1</span> <span class="sc">|</span> site) <span class="sc">+</span> (<span class="dv">1</span> <span class="sc">|</span> site<span class="sc">:</span>tree) <span class="sc">+</span> (<span class="dv">1</span> <span class="sc">|</span> species),</span>
<span id="cb558-2"><a href="hierarchical-mixed-models.html#cb558-2" tabindex="-1"></a>                  <span class="at">data =</span> ant_s)</span></code></pre></div>
<pre><code>## boundary (singular) fit: see help(&#39;isSingular&#39;)</code></pre>
<div class="sourceCode" id="cb560"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb560-1"><a href="hierarchical-mixed-models.html#cb560-1" tabindex="-1"></a><span class="fu">summary</span>(fm1)</span></code></pre></div>
<pre><code>## Linear mixed model fit by REML [&#39;lmerMod&#39;]
## Formula: ct_max ~ habitat + (1 | site) + (1 | site:tree) + (1 | species)
##    Data: ant_s
## 
## REML criterion at convergence: 158.3
## 
## Scaled residuals: 
##      Min       1Q   Median       3Q      Max 
## -2.52842 -0.46347 -0.02458  0.46006  2.19640 
## 
## Random effects:
##  Groups    Name        Variance Std.Dev.
##  species   (Intercept) 3.3820   1.8390  
##  site:tree (Intercept) 0.0000   0.0000  
##  site      (Intercept) 0.1644   0.4054  
##  Residual              0.3506   0.5921  
## Number of obs: 56, groups:  species, 18; site:tree, 12; site, 5
## 
## Fixed effects:
##                    Estimate Std. Error t value
## (Intercept)         46.3859     0.7930   58.49
## habitatterrestrial  -2.3022     0.9473   -2.43
## 
## Correlation of Fixed Effects:
##             (Intr)
## hbtttrrstrl -0.793
## optimizer (nloptwrap) convergence code: 0 (OK)
## boundary (singular) fit: see help(&#39;isSingular&#39;)</code></pre>
<p>The two most interesting parameters are the estimate of the difference in mean responses between the two habitats (<span class="math inline">\(-2.30\)</span>) and the standard deviation of the species-level variance (<span class="math inline">\(1.84\)</span>). The estimate of the tree-level variance is 0, indicating that two measurements from the same tree are no more strongly correlated than two measurements from different trees at the same site. Retaining the random effect for the tree doesn’t impact the rest of the fit, so we’ll retain it.</p>
<p>To visualize the model fit, we can compute blups for each species</p>
<div class="sourceCode" id="cb562"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb562-1"><a href="hierarchical-mixed-models.html#cb562-1" tabindex="-1"></a>s_data<span class="sc">$</span>blup <span class="ot">&lt;-</span> <span class="fu">ranef</span>(fm1)<span class="sc">$</span>species[, <span class="dv">1</span>] <span class="sc">+</span> <span class="fu">coef</span>(<span class="fu">summary</span>(fm1))[<span class="dv">1</span>, <span class="dv">1</span>] <span class="sc">+</span> <span class="fu">ifelse</span>(s_data<span class="sc">$</span>habitat <span class="sc">==</span> <span class="st">&quot;terrestrial&quot;</span>, <span class="fu">coef</span>(<span class="fu">summary</span>(fm1))[<span class="dv">2</span>, <span class="dv">1</span>], <span class="dv">0</span>)</span>
<span id="cb562-2"><a href="hierarchical-mixed-models.html#cb562-2" tabindex="-1"></a><span class="fu">with</span>(s_data, <span class="fu">stripchart</span>(blup <span class="sc">~</span> habitat, <span class="at">pch =</span> <span class="dv">16</span>))</span></code></pre></div>
<p><img src="06-HierarchicalModels_files/figure-html/unnamed-chunk-72-1.png" width="672" /></p>
<p>Note that the blups are not too different from the raw averages. (The shrinkage here is small because the estimate of the species-level variance is large.)</p>
<p>To draw inferences about the parameters of interest, we can profile.</p>
<div class="sourceCode" id="cb563"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb563-1"><a href="hierarchical-mixed-models.html#cb563-1" tabindex="-1"></a>pr <span class="ot">&lt;-</span> <span class="fu">profile</span>(fm1)</span>
<span id="cb563-2"><a href="hierarchical-mixed-models.html#cb563-2" tabindex="-1"></a>lattice<span class="sc">::</span><span class="fu">xyplot</span>(pr, <span class="at">absVal =</span> T)</span></code></pre></div>
<p><img src="06-HierarchicalModels_files/figure-html/unnamed-chunk-73-1.png" width="672" /></p>
<div class="sourceCode" id="cb564"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb564-1"><a href="hierarchical-mixed-models.html#cb564-1" tabindex="-1"></a><span class="fu">confint</span>(pr)</span></code></pre></div>
<pre><code>##                           2.5 %     97.5 %
## .sig01              1.237329013  2.5573015
## .sig02              0.000000000  0.6505234
## .sig03              0.003573586  1.0558260
## .sigma              0.474974242  0.7698552
## (Intercept)        44.834426004 47.9327950
## habitatterrestrial -4.153908536 -0.4335560</code></pre>
<p>Note that the 95% CI for the difference between the habitats (labeled <code>habitatterrestrial</code>) does not overlap 0. Thus the difference between the two habitats is significant at the 5% level.</p>
<p>Alternative, we can use <code>lmerTest</code> to generate a <span class="math inline">\(p\)</span> value of unknown validity.</p>
<div class="sourceCode" id="cb566"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb566-1"><a href="hierarchical-mixed-models.html#cb566-1" tabindex="-1"></a>fm1b <span class="ot">&lt;-</span> lmerTest<span class="sc">::</span><span class="fu">lmer</span>(ct_max <span class="sc">~</span> habitat <span class="sc">+</span> (<span class="dv">1</span> <span class="sc">|</span> site) <span class="sc">+</span> (<span class="dv">1</span> <span class="sc">|</span> site<span class="sc">:</span>tree) <span class="sc">+</span> (<span class="dv">1</span> <span class="sc">|</span> species),</span>
<span id="cb566-2"><a href="hierarchical-mixed-models.html#cb566-2" tabindex="-1"></a>                       <span class="at">data =</span> ant_s)</span></code></pre></div>
<pre><code>## boundary (singular) fit: see help(&#39;isSingular&#39;)</code></pre>
<div class="sourceCode" id="cb568"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb568-1"><a href="hierarchical-mixed-models.html#cb568-1" tabindex="-1"></a><span class="fu">summary</span>(fm1b)</span></code></pre></div>
<pre><code>## Linear mixed model fit by REML. t-tests use Satterthwaite&#39;s method [
## lmerModLmerTest]
## Formula: ct_max ~ habitat + (1 | site) + (1 | site:tree) + (1 | species)
##    Data: ant_s
## 
## REML criterion at convergence: 158.3
## 
## Scaled residuals: 
##      Min       1Q   Median       3Q      Max 
## -2.52842 -0.46347 -0.02458  0.46006  2.19640 
## 
## Random effects:
##  Groups    Name        Variance Std.Dev.
##  species   (Intercept) 3.3820   1.8390  
##  site:tree (Intercept) 0.0000   0.0000  
##  site      (Intercept) 0.1644   0.4054  
##  Residual              0.3506   0.5921  
## Number of obs: 56, groups:  species, 18; site:tree, 12; site, 5
## 
## Fixed effects:
##                    Estimate Std. Error      df t value Pr(&gt;|t|)    
## (Intercept)         46.3859     0.7930 16.6776   58.49   &lt;2e-16 ***
## habitatterrestrial  -2.3022     0.9473 15.3755   -2.43   0.0278 *  
## ---
## Signif. codes:  0 &#39;***&#39; 0.001 &#39;**&#39; 0.01 &#39;*&#39; 0.05 &#39;.&#39; 0.1 &#39; &#39; 1
## 
## Correlation of Fixed Effects:
##             (Intr)
## hbtttrrstrl -0.793
## optimizer (nloptwrap) convergence code: 0 (OK)
## boundary (singular) fit: see help(&#39;isSingular&#39;)</code></pre>

</div>
</div>
</div>
<h3>Bibliography<a href="bibliography.html#bibliography" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<div id="refs" class="references csl-bib-body hanging-indent" entry-spacing="0">
<div id="ref-bates2012lme4" class="csl-entry">
Bates, Douglas M. 2012+. <em><span class="nocase">lme4</span>: Mixed-Effects Modeling with <span>R</span></em>. Unpublished.
</div>
<div id="ref-bishop1972" class="csl-entry">
Bishop, JA. 1972. <span>“An Experimental Study of the Cline of Industrial Melanism in Biston Betularia (l.)(lepidoptera) Between Urban Liverpool and Rural North Wales.”</span> <em>The Journal of Animal Ecology</em>, 209–43.
</div>
<div id="ref-box1973" class="csl-entry">
Box, GEP, and GC Tiao. 1973. <em>Bayesian Inference in Statistical Analysis</em>. Reading, MA: Addison-Wesley.
</div>
<div id="ref-ramsey2002" class="csl-entry">
Ramsey, Fred, and Daniel Schafer. 2002. <em>The Statistical Sleuth: A Course in Methods of Data Analysis</em>. 2nd ed. Pacific Grove, CA: Duxbury.
</div>
<div id="ref-zuur2007analysing" class="csl-entry">
Zuur, Alain F, Elena N Ieno, and Graham M Smith. 2007. <em>Analysing Ecological Data</em>. Springer.
</div>
<div id="ref-zuur2009" class="csl-entry">
Zuur, Alain F, Elena N Ieno, Neil J Walker, Anatoly A Saveliev, Graham M Smith, et al. 2009. <em>Mixed Effects Models and Extensions in Ecology with <span>R</span></em>. Vol. 574. Springer.
</div>
</div>
<div class="footnotes">
<hr />
<ol start="7">
<li id="fn7"><p>Note that you can actually use the <code>profile</code> function on the REML fit, but in that case the <code>profile</code> function will first refit the model using ML. So, <code>profile</code> will return profiles of the ML fit, regardless of whether it is given a model fit with REML or a model fit with ML.<a href="hierarchical-mixed-models.html#fnref7" class="footnote-back">↩︎</a></p></li>
<li id="fn8"><p>The actual data includes one habitat generalist species that occurs in both arboreal and terrestrial habitats. Including that species complicates the anlysis substantially, so we restrict our attention to the habitat specialists.<a href="hierarchical-mixed-models.html#fnref8" class="footnote-back">↩︎</a></p></li>
</ol>
</div>
            </section>

          </div>
        </div>
      </div>
<a href="generalized-least-squares.html" class="navigation navigation-prev " aria-label="Previous page"><i class="fa fa-angle-left"></i></a>
<a href="generalized-linear-models.html" class="navigation navigation-next " aria-label="Next page"><i class="fa fa-angle-right"></i></a>
    </div>
  </div>
<script src="libs/gitbook-2.6.7/js/app.min.js"></script>
<script src="libs/gitbook-2.6.7/js/clipboard.min.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-search.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-sharing.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-fontsettings.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-bookdown.js"></script>
<script src="libs/gitbook-2.6.7/js/jquery.highlight.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-clipboard.js"></script>
<script>
gitbook.require(["gitbook"], function(gitbook) {
gitbook.start({
  "sharing": {
    "github": false,
    "facebook": true,
    "twitter": true,
    "linkedin": false,
    "weibo": false,
    "instapaper": false,
    "vk": false,
    "whatsapp": false,
    "all": ["facebook", "twitter", "linkedin", "weibo", "instapaper"]
  },
  "fontsettings": {
    "theme": "white",
    "family": "serif",
    "size": 2
  },
  "edit": {
    "link": null,
    "text": null
  },
  "history": {
    "link": null,
    "text": null
  },
  "view": {
    "link": null,
    "text": null
  },
  "download": null,
  "search": {
    "engine": "fuse",
    "options": null
  },
  "toc": {
    "collapse": "section"
  }
});
});
</script>

<!-- dynamically load mathjax for compatibility with self-contained -->
<script>
  (function () {
    var script = document.createElement("script");
    script.type = "text/javascript";
    var src = "true";
    if (src === "" || src === "true") src = "https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.9/latest.js?config=TeX-MML-AM_CHTML";
    if (location.protocol !== "file:")
      if (/^https?:/.test(src))
        src = src.replace(/^https?:/, '');
    script.src = src;
    document.getElementsByTagName("head")[0].appendChild(script);
  })();
</script>
</body>

</html>
